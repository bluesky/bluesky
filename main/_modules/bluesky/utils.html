
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>bluesky.utils &#8212; bluesky 1.13.0a4.dev243+ge2fadddd documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=3ee479438cf8b5e0d341" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=3ee479438cf8b5e0d341"></script>

    <script src="../../_static/documentation_options.js?v=aeca926c"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/bluesky/utils';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.15.3';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://blueskyproject.io/bluesky/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = '1.13.0a4.dev243+ge2fadddd';
        DOCUMENTATION_OPTIONS.show_version_warning_banner = false;
        </script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/bluesky-logo-dark.svg" class="logo__image only-light" alt=""/>
    <script>document.write(`<img src="../../_static/bluesky-logo-dark.svg" class="logo__image only-dark" alt=""/>`);</script>
  
  
    <p class="title logo__title">bluesky</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-internal" href="../../userindex.html">
    User Documentation
  </a>
</li>


<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-internal" href="../../devindex.html">
    Developer Documentation
  </a>
</li>


<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-external" href="https://blueskyproject.io/bluesky">
    bluesky
  </a>
</li>


<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-external" href="https://blueskyproject.io/ophyd">
    ophyd
  </a>
</li>


<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-external" href="https://blueskyproject.io/databroker">
    databroker
  </a>
</li>

            <li class="nav-item dropdown pst-header-nav-item">
                <button class="btn dropdown-toggle nav-item" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class="nav-item ">
  <a class="nav-link dropdown-item nav-external" href="https://nsls-ii.github.io/amostra">
    amostra
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link dropdown-item nav-external" href="https://nsls-ii.github.io/datamuxer">
    datamuxer
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link dropdown-item nav-external" href="https://blueskyproject.io/suitcase">
    suitcase
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link dropdown-item nav-external" href="https://github.com/NSLS-II/">
    NSLS-II Repositories
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link dropdown-item nav-external" href="https://github.com/NSLS-II/Bug-Reports/issues">
    Bug Reports
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/bluesky/bluesky" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/bluesky" title="PyPI" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fas fa-cube fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
      
        <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button id="pst-version-switcher-button-2"
      type="button"
      class="version-switcher__button btn btn-sm navbar-btn dropdown-toggle"
      data-bs-toggle="dropdown"
      aria-haspopup="listbox"
      aria-controls="pst-version-switcher-list-2"
      aria-label="Version switcher list"
    >
      Choose version  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div id="pst-version-switcher-list-2"
      class="version-switcher__menu dropdown-menu list-group-flush py-0"
      role="listbox" aria-labelledby="pst-version-switcher-button-2">
      <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <div class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-internal" href="../../userindex.html">
    User Documentation
  </a>
</li>


<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-internal" href="../../devindex.html">
    Developer Documentation
  </a>
</li>


<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-external" href="https://blueskyproject.io/bluesky">
    bluesky
  </a>
</li>


<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-external" href="https://blueskyproject.io/ophyd">
    ophyd
  </a>
</li>


<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-external" href="https://blueskyproject.io/databroker">
    databroker
  </a>
</li>


<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-external" href="https://nsls-ii.github.io/amostra">
    amostra
  </a>
</li>


<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-external" href="https://nsls-ii.github.io/datamuxer">
    datamuxer
  </a>
</li>


<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-external" href="https://blueskyproject.io/suitcase">
    suitcase
  </a>
</li>


<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-external" href="https://github.com/NSLS-II/">
    NSLS-II Repositories
  </a>
</li>


<li class="nav-item pst-header-nav-item">
  <a class="nav-link nav-external" href="https://github.com/NSLS-II/Bug-Reports/issues">
    Bug Reports
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/bluesky/bluesky" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/bluesky" title="PyPI" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fas fa-cube fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
        
          <div class="navbar-item">
<script>
document.write(`
  <div class="version-switcher__container dropdown">
    <button id="pst-version-switcher-button-3"
      type="button"
      class="version-switcher__button btn btn-sm navbar-btn dropdown-toggle"
      data-bs-toggle="dropdown"
      aria-haspopup="listbox"
      aria-controls="pst-version-switcher-list-3"
      aria-label="Version switcher list"
    >
      Choose version  <!-- this text may get changed later by javascript -->
      <span class="caret"></span>
    </button>
    <div id="pst-version-switcher-list-3"
      class="version-switcher__menu dropdown-menu list-group-flush py-0"
      role="listbox" aria-labelledby="pst-version-switcher-button-3">
      <!-- dropdown will be populated by javascript on page load -->
    </div>
  </div>
`);
</script></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">bluesky.utils</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for bluesky.utils</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">abc</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">collections.abc</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">uuid</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">namedtuple</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span><span class="p">,</span> <span class="n">reduce</span><span class="p">,</span> <span class="n">wraps</span>
<span class="kn">from</span> <span class="nn">inspect</span> <span class="kn">import</span> <span class="n">Parameter</span><span class="p">,</span> <span class="n">Signature</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Any</span><span class="p">,</span>
    <span class="n">AsyncIterable</span><span class="p">,</span>
    <span class="n">AsyncIterator</span><span class="p">,</span>
    <span class="n">Callable</span><span class="p">,</span>
    <span class="n">Dict</span><span class="p">,</span>
    <span class="n">List</span><span class="p">,</span>
    <span class="n">Optional</span><span class="p">,</span>
    <span class="n">Tuple</span><span class="p">,</span>
    <span class="n">Type</span><span class="p">,</span>
    <span class="n">Union</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">weakref</span> <span class="kn">import</span> <span class="n">WeakKeyDictionary</span><span class="p">,</span> <span class="n">ref</span>

<span class="kn">import</span> <span class="nn">msgpack</span>
<span class="kn">import</span> <span class="nn">msgpack_numpy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">zict</span>
<span class="kn">from</span> <span class="nn">cycler</span> <span class="kn">import</span> <span class="n">cycler</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">from</span> <span class="nn">tqdm.utils</span> <span class="kn">import</span> <span class="n">_screen_shape_wrapper</span><span class="p">,</span> <span class="n">_term_move_up</span><span class="p">,</span> <span class="n">_unicode</span>

<span class="kn">from</span> <span class="nn">bluesky._vendor.super_state_machine.errors</span> <span class="kn">import</span> <span class="n">TransitionError</span>
<span class="kn">from</span> <span class="nn">bluesky.protocols</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">Asset</span><span class="p">,</span>
    <span class="n">HasHints</span><span class="p">,</span>
    <span class="n">HasParent</span><span class="p">,</span>
    <span class="n">Hints</span><span class="p">,</span>
    <span class="n">Movable</span><span class="p">,</span>
    <span class="n">Readable</span><span class="p">,</span>
    <span class="n">StreamAsset</span><span class="p">,</span>
    <span class="n">SyncOrAsync</span><span class="p">,</span>
    <span class="n">SyncOrAsyncIterator</span><span class="p">,</span>
    <span class="n">T</span><span class="p">,</span>
    <span class="n">WritesExternalAssets</span><span class="p">,</span>
    <span class="n">WritesStreamAssets</span><span class="p">,</span>
    <span class="n">check_supports</span><span class="p">,</span>
<span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="c1"># cytools is a drop-in replacement for toolz, implemented in Cython</span>
    <span class="kn">from</span> <span class="nn">cytools</span> <span class="kn">import</span> <span class="n">groupby</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">toolz</span> <span class="kn">import</span> <span class="n">groupby</span>


<div class="viewcode-block" id="Msg">
<a class="viewcode-back" href="../../generated/bluesky.utils.Msg.html#bluesky.utils.Msg">[docs]</a>
<span class="k">class</span> <span class="nc">Msg</span><span class="p">(</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;Msg_base&quot;</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;command&quot;</span><span class="p">,</span> <span class="s2">&quot;obj&quot;</span><span class="p">,</span> <span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="s2">&quot;kwargs&quot;</span><span class="p">,</span> <span class="s2">&quot;run&quot;</span><span class="p">])):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Namedtuple sub-class to encapsulate a message from the plan to the RE.</span>

<span class="sd">    This class provides 3 key features:</span>

<span class="sd">    1. dot access to the contents</span>
<span class="sd">    2. default values and a variadic signature for args / kwargs</span>
<span class="sd">    3. a nice repr</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">()</span>

    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">obj</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">run</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Msg</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span>  <span class="c1"># noqa: UP008</span>
            <span class="bp">cls</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">run</span>
        <span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Msg(</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="si">!r}</span><span class="s2">, obj=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="si">!r}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;args=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="si">}</span><span class="s2">, kwargs=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="si">}</span><span class="s2">, run=</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">run</span><span class="si">!r}</span><span class="s2">)&quot;</span>
        <span class="p">)</span></div>



<div class="viewcode-block" id="RunEngineControlException">
<a class="viewcode-back" href="../../generated/bluesky.utils.RunEngineControlException.html#bluesky.utils.RunEngineControlException">[docs]</a>
<span class="k">class</span> <span class="nc">RunEngineControlException</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exception for signaling within the RunEngine.&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="RequestAbort">
<a class="viewcode-back" href="../../generated/bluesky.utils.RequestAbort.html#bluesky.utils.RequestAbort">[docs]</a>
<span class="k">class</span> <span class="nc">RequestAbort</span><span class="p">(</span><span class="n">RunEngineControlException</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Request that the current run be aborted.&quot;&quot;&quot;</span>

    <span class="n">exit_status</span> <span class="o">=</span> <span class="s2">&quot;abort&quot;</span></div>



<div class="viewcode-block" id="RequestStop">
<a class="viewcode-back" href="../../generated/bluesky.utils.RequestStop.html#bluesky.utils.RequestStop">[docs]</a>
<span class="k">class</span> <span class="nc">RequestStop</span><span class="p">(</span><span class="n">RunEngineControlException</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Request that the current run be stopped and marked successful.&quot;&quot;&quot;</span>

    <span class="n">exit_status</span> <span class="o">=</span> <span class="s2">&quot;success&quot;</span></div>



<div class="viewcode-block" id="RunEngineInterrupted">
<a class="viewcode-back" href="../../generated/bluesky.utils.RunEngineInterrupted.html#bluesky.utils.RunEngineInterrupted">[docs]</a>
<span class="k">class</span> <span class="nc">RunEngineInterrupted</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="NoReplayAllowed">
<a class="viewcode-back" href="../../generated/bluesky.utils.NoReplayAllowed.html#bluesky.utils.NoReplayAllowed">[docs]</a>
<span class="k">class</span> <span class="nc">NoReplayAllowed</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="IllegalMessageSequence">
<a class="viewcode-back" href="../../generated/bluesky.utils.IllegalMessageSequence.html#bluesky.utils.IllegalMessageSequence">[docs]</a>
<span class="k">class</span> <span class="nc">IllegalMessageSequence</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="FailedPause">
<a class="viewcode-back" href="../../generated/bluesky.utils.FailedPause.html#bluesky.utils.FailedPause">[docs]</a>
<span class="k">class</span> <span class="nc">FailedPause</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="FailedStatus">
<a class="viewcode-back" href="../../generated/bluesky.utils.FailedStatus.html#bluesky.utils.FailedStatus">[docs]</a>
<span class="k">class</span> <span class="nc">FailedStatus</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Exception to be raised if a SatusBase object reports done but failed&quot;&quot;&quot;</span></div>



<div class="viewcode-block" id="InvalidCommand">
<a class="viewcode-back" href="../../generated/bluesky.utils.InvalidCommand.html#bluesky.utils.InvalidCommand">[docs]</a>
<span class="k">class</span> <span class="nc">InvalidCommand</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="PlanHalt">
<a class="viewcode-back" href="../../generated/bluesky.utils.PlanHalt.html#bluesky.utils.PlanHalt">[docs]</a>
<span class="k">class</span> <span class="nc">PlanHalt</span><span class="p">(</span><span class="ne">GeneratorExit</span><span class="p">):</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="RampFail">
<a class="viewcode-back" href="../../generated/bluesky.utils.RampFail.html#bluesky.utils.RampFail">[docs]</a>
<span class="k">class</span> <span class="nc">RampFail</span><span class="p">(</span><span class="ne">RuntimeError</span><span class="p">):</span> <span class="o">...</span></div>



<span class="n">PLAN_TYPES</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Type</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">types</span><span class="o">.</span><span class="n">GeneratorType</span><span class="p">,)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">types</span> <span class="kn">import</span> <span class="n">CoroutineType</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="c1"># &lt; py35</span>
    <span class="k">pass</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">PLAN_TYPES</span> <span class="o">=</span> <span class="n">PLAN_TYPES</span> <span class="o">+</span> <span class="p">(</span><span class="n">CoroutineType</span><span class="p">,)</span>
    <span class="k">del</span> <span class="n">CoroutineType</span>


<span class="k">def</span> <span class="nf">ensure_generator</span><span class="p">(</span><span class="n">plan</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ensure that the input is a generator.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    plan : iterable or iterator</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    gen : coroutine</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="n">Msg</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">single_gen</span><span class="p">(</span><span class="n">plan</span><span class="p">)</span>
    <span class="n">gen</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">plan</span><span class="p">)</span>  <span class="c1"># no-op on generators; needed for classes</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">gen</span><span class="p">,</span> <span class="n">PLAN_TYPES</span><span class="p">):</span>
        <span class="c1"># If plan does not support .send, we must wrap it in a generator.</span>
        <span class="n">gen</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg</span> <span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">gen</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">gen</span>


<div class="viewcode-block" id="single_gen">
<a class="viewcode-back" href="../../generated/bluesky.preprocessors.single_gen.html#bluesky.utils.single_gen">[docs]</a>
<span class="k">def</span> <span class="nf">single_gen</span><span class="p">(</span><span class="n">msg</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Turn a single message into a plan</span>

<span class="sd">    If ``lambda x: yield x`` were valid Python, this would be equivalent.</span>
<span class="sd">    In Python 3.6 or 3.7 we might get lambda generators.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msg : Msg</span>
<span class="sd">        a single message</span>

<span class="sd">    Yields</span>
<span class="sd">    ------</span>
<span class="sd">    msg : Msg</span>
<span class="sd">        the input message</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="k">yield</span> <span class="n">msg</span><span class="p">)</span></div>



<span class="k">class</span> <span class="nc">SignalHandler</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Context manager for signal handing</span>

<span class="sd">    If multiple signals come in quickly, they may not all be seen, quoting</span>
<span class="sd">    the libc manual:</span>

<span class="sd">      Remember that if there is a particular signal pending for your</span>
<span class="sd">      process, additional signals of that same type that arrive in the</span>
<span class="sd">      meantime might be discarded. For example, if a SIGINT signal is</span>
<span class="sd">      pending when another SIGINT signal arrives, your program will</span>
<span class="sd">      probably only see one of them when you unblock this signal.</span>

<span class="sd">    https://www.gnu.org/software/libc/manual/html_node/Checking-for-Pending-Signals.html</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sig</span> <span class="o">=</span> <span class="n">sig</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interrupted</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">log</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">interrupted</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">released</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">original_handler</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">getsignal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">handler</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interrupted</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;SignalHandler caught SIGINT; count is </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="n">orig_func</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_handler</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
                <span class="n">orig_func</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">handle_signals</span><span class="p">()</span>

        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="p">,</span> <span class="n">handler</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">release</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">released</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sig</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">original_handler</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">released</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">handle_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="o">...</span>


<span class="k">class</span> <span class="nc">SigintHandler</span><span class="p">(</span><span class="n">SignalHandler</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">RE</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="n">RE</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">RE</span> <span class="o">=</span> <span class="n">RE</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_sigint_time</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># time most recent SIGINT was processed</span>

    <span class="k">def</span> <span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">handle_signals</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Check for pause requests from keyboard.</span>
        <span class="c1"># TODO, there is a possible race condition between the two</span>
        <span class="c1"># pauses here</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">RE</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">is_running</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">RE</span><span class="o">.</span><span class="n">_interrupted</span><span class="p">):</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_sigint_time</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_sigint_time</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">:</span>
                <span class="c1"># reset the counter to 1</span>
                <span class="c1"># It&#39;s been 10 seconds since the last SIGINT. Reset.</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_sigint_time</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;It has been 10 seconds since the last SIGINT. Resetting SIGINT handler.&quot;</span><span class="p">)</span>

                <span class="c1"># weeee push these to threads to not block the main thread</span>
                <span class="k">def</span> <span class="nf">maybe_defer_pause</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">RE</span><span class="o">.</span><span class="n">request_pause</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">TransitionError</span><span class="p">:</span>
                        <span class="o">...</span>

                <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">maybe_defer_pause</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;A &#39;deferred pause&#39; has been requested. The &quot;</span>
                    <span class="s2">&quot;RunEngine will pause at the next checkpoint. &quot;</span>
                    <span class="s2">&quot;To pause immediately, hit Ctrl+C again in the &quot;</span>
                    <span class="s2">&quot;next 10 seconds.&quot;</span>
                <span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">last_sigint_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;trying a second time&quot;</span><span class="p">)</span>
                <span class="c1"># - Ctrl-C twice within 10 seconds -&gt; hard pause</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;RunEngine detected two SIGINTs. A hard pause will be requested.&quot;</span><span class="p">)</span>

                <span class="c1"># weeee push these to threads to not block the main thread</span>
                <span class="k">def</span> <span class="nf">maybe_prompt_pause</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">RE</span><span class="o">.</span><span class="n">request_pause</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                    <span class="k">except</span> <span class="n">TransitionError</span><span class="p">:</span>
                        <span class="o">...</span>

                <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">maybe_prompt_pause</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">last_sigint_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">CallbackRegistry</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    See matplotlib.cbook.CallbackRegistry. This is a simplified since</span>
<span class="sd">    ``bluesky`` is python3.4+ only!</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ignore_exceptions</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">allowed_sigs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_exceptions</span> <span class="o">=</span> <span class="n">ignore_exceptions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">allowed_sigs</span> <span class="o">=</span> <span class="n">allowed_sigs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># noqa: C408</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cid</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_func_cid_map</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># We cannot currently pickle the callables in the registry, so</span>
        <span class="c1"># return an empty dictionary.</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="c1"># re-initialise an empty callback registry</span>
        <span class="bp">self</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">connect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Register ``func`` to be called when ``sig`` is generated</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sig</span>
<span class="sd">        func</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        cid : int</span>
<span class="sd">            The callback index. To be used with ``disconnect`` to deregister</span>
<span class="sd">            ``func`` so that it will no longer be called when ``sig`` is</span>
<span class="sd">            generated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_sigs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sig</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_sigs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Allowed signals are </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">allowed_sigs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_func_cid_map</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="n">WeakKeyDictionary</span><span class="p">())</span>
        <span class="c1"># Note proxy not needed in python 3.</span>
        <span class="c1"># TODO rewrite this when support for python2.x gets dropped.</span>
        <span class="c1"># Following discussion with TC: weakref.WeakMethod can not be used to</span>
        <span class="c1">#   replace the custom &#39;BoundMethodProxy&#39;, because it does not accept</span>
        <span class="c1">#   the &#39;destroy callback&#39; as a parameter. The &#39;destroy callback&#39; is</span>
        <span class="c1">#   necessary to automatically unsubscribe CB registry from the callback</span>
        <span class="c1">#   when the class object is destroyed and this is the main purpose of</span>
        <span class="c1">#   BoundMethodProxy.</span>
        <span class="n">proxy</span> <span class="o">=</span> <span class="n">_BoundMethodProxy</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">proxy</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func_cid_map</span><span class="p">[</span><span class="n">sig</span><span class="p">]:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func_cid_map</span><span class="p">[</span><span class="n">sig</span><span class="p">][</span><span class="n">proxy</span><span class="p">]</span>

        <span class="n">proxy</span><span class="o">.</span><span class="n">add_destroy_callback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_remove_proxy</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cid</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">cid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_func_cid_map</span><span class="p">[</span><span class="n">sig</span><span class="p">][</span><span class="n">proxy</span><span class="p">]</span> <span class="o">=</span> <span class="n">cid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">sig</span><span class="p">,</span> <span class="nb">dict</span><span class="p">())</span>  <span class="c1"># noqa: C408</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">sig</span><span class="p">][</span><span class="n">cid</span><span class="p">]</span> <span class="o">=</span> <span class="n">proxy</span>
        <span class="k">return</span> <span class="n">cid</span>

    <span class="k">def</span> <span class="nf">_remove_proxy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">proxy</span><span class="p">):</span>
        <span class="c1"># need the list because `del self._func_cid_map[sig]` mutates the dict</span>
        <span class="k">for</span> <span class="n">sig</span><span class="p">,</span> <span class="n">proxies</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_func_cid_map</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Here we need to delete the last reference to proxy (in &#39;self.callbacks[sig]&#39;)</span>
                <span class="c1">#   The respective entries in &#39;self._func_cid_map&#39; are deleted automatically,</span>
                <span class="c1">#   since &#39;self._func_cid_map[sig]&#39; entries are WeakKeyDictionary objects.</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">sig</span><span class="p">][</span><span class="n">proxies</span><span class="p">[</span><span class="n">proxy</span><span class="p">]]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="c1"># Remove dictionary items for signals with no assigned callbacks</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">sig</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">sig</span><span class="p">]</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func_cid_map</span><span class="p">[</span><span class="n">sig</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cid</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Disconnect the callback registered with callback id *cid*</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cid : int</span>
<span class="sd">            The callback index and return value from ``connect``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">eventname</span><span class="p">,</span> <span class="n">callbackd</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  <span class="c1"># noqa: B007</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># This may or may not remove entries in &#39;self._func_cid_map&#39;.</span>
                <span class="k">del</span> <span class="n">callbackd</span><span class="p">[</span><span class="n">cid</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Look for cid in &#39;self._func_cid_map&#39; as well. It may still be there.</span>
                <span class="k">for</span> <span class="n">sig</span><span class="p">,</span> <span class="n">functions</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func_cid_map</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  <span class="c1"># noqa: B007</span>
                    <span class="k">for</span> <span class="n">function</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">functions</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="n">cid</span><span class="p">:</span>
                            <span class="k">del</span> <span class="n">functions</span><span class="p">[</span><span class="n">function</span><span class="p">]</span>
                <span class="k">return</span>

    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sig</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process ``sig``</span>

<span class="sd">        All of the functions registered to receive callbacks on ``sig``</span>
<span class="sd">        will be called with ``args`` and ``kwargs``</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sig</span>
<span class="sd">        args</span>
<span class="sd">        kwargs</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_sigs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">sig</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_sigs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Allowed signals are </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">allowed_sigs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">exceptions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">sig</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">cid</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callbacks</span><span class="p">[</span><span class="n">sig</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>  <span class="c1"># noqa: B007</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ReferenceError</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_remove_proxy</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ignore_exceptions</span><span class="p">:</span>
                        <span class="n">exceptions</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">e</span><span class="p">,</span> <span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">()[</span><span class="mi">2</span><span class="p">]))</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span>
        <span class="k">return</span> <span class="n">exceptions</span>


<span class="k">class</span> <span class="nc">_BoundMethodProxy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Our own proxy object which enables weak references to bound and unbound</span>
<span class="sd">    methods and arbitrary callables. Pulls information about the function,</span>
<span class="sd">    class, and instance out of a bound method. Stores a weak reference to the</span>
<span class="sd">    instance to support garbage collection.</span>
<span class="sd">    @organization: IBM Corporation</span>
<span class="sd">    @copyright: Copyright (c) 2005, 2006 IBM Corporation</span>
<span class="sd">    @license: The BSD License</span>
<span class="sd">    Minor bugfixes by Michael Droettboom</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cb</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_hash</span> <span class="o">=</span> <span class="nb">hash</span><span class="p">(</span><span class="n">cb</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_destroy_callbacks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># This branch is successful if &#39;cb&#39; bound method and class method,</span>
            <span class="c1">#   but destroy_callback mechanism works only for bound methods,</span>
            <span class="c1">#   since cb.__self__ points to class instance only for</span>
            <span class="c1">#   bound methods, not for class methods. Therefore destroy_callback</span>
            <span class="c1">#   will not be called for class methods.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inst</span> <span class="o">=</span> <span class="n">ref</span><span class="p">(</span><span class="n">cb</span><span class="o">.</span><span class="vm">__self__</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_destroy</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">inst</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="vm">__func__</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">klass</span> <span class="o">=</span> <span class="n">cb</span><span class="o">.</span><span class="vm">__self__</span><span class="o">.</span><span class="vm">__class__</span>

        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c1"># &#39;cb&#39; is a function, callable object or static method.</span>
            <span class="c1"># No weak reference is created, strong reference is stored instead.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inst</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">cb</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">klass</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">add_destroy_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_destroy_callbacks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_BoundMethodProxy</span><span class="p">(</span><span class="n">callback</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">_destroy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wk</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">callback</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_destroy_callbacks</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">callback</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ReferenceError</span><span class="p">:</span>
                <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">d</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="c1"># de-weak reference inst</span>
        <span class="n">inst</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;inst&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">inst</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="s2">&quot;inst&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inst</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">d</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">statedict</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="vm">__dict__</span> <span class="o">=</span> <span class="n">statedict</span>
        <span class="n">inst</span> <span class="o">=</span> <span class="n">statedict</span><span class="p">[</span><span class="s2">&quot;inst&quot;</span><span class="p">]</span>
        <span class="c1"># turn inst back into a weakref</span>
        <span class="k">if</span> <span class="n">inst</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inst</span> <span class="o">=</span> <span class="n">ref</span><span class="p">(</span><span class="n">inst</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Proxy for a call to the weak referenced object. Take</span>
<span class="sd">        arbitrary params to pass to the callable.</span>
<span class="sd">        Raises `ReferenceError`: When the weak reference refers to</span>
<span class="sd">        a dead object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inst</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">inst</span><span class="p">()</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ReferenceError</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">inst</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># build a new instance method with a strong reference to the</span>
            <span class="c1"># instance</span>

            <span class="n">mtd</span> <span class="o">=</span> <span class="n">types</span><span class="o">.</span><span class="n">MethodType</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inst</span><span class="p">())</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># not a bound method, just return the func</span>
            <span class="n">mtd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span>
        <span class="c1"># invoke the callable and return the result</span>
        <span class="k">return</span> <span class="n">mtd</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__eq__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Compare the held function and instance with that held by</span>
<span class="sd">        another proxy.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inst</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">func</span> <span class="ow">and</span> <span class="n">other</span><span class="o">.</span><span class="n">inst</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">func</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">inst</span><span class="p">()</span> <span class="o">==</span> <span class="n">other</span><span class="o">.</span><span class="n">inst</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__ne__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Inverse of __eq__.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__eq__</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__hash__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hash</span>


<span class="c1"># The following two code blocks are adapted from David Beazley&#39;s</span>
<span class="c1"># &#39;Python 3 Metaprogramming&#39; https://www.youtube.com/watch?v=sPiWg5jSoZI</span>


<span class="k">class</span> <span class="nc">StructMeta</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">clsdict</span><span class="p">):</span>
        <span class="n">clsobj</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__new__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">clsdict</span><span class="p">)</span>
        <span class="n">args_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">Parameter</span><span class="o">.</span><span class="n">POSITIONAL_OR_KEYWORD</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">clsobj</span><span class="o">.</span><span class="n">_fields</span><span class="p">]</span>
        <span class="n">kwargs_params</span> <span class="o">=</span> <span class="p">[</span><span class="n">Parameter</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">Parameter</span><span class="o">.</span><span class="n">KEYWORD_ONLY</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;md&quot;</span><span class="p">]]</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">Signature</span><span class="p">(</span><span class="n">args_params</span> <span class="o">+</span> <span class="n">kwargs_params</span><span class="p">)</span>
        <span class="n">clsobj</span><span class="o">.</span><span class="n">__signature__</span> <span class="o">=</span> <span class="n">sig</span>
        <span class="k">return</span> <span class="n">clsobj</span>


<span class="k">class</span> <span class="nc">Struct</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">StructMeta</span><span class="p">):</span>
    <span class="s2">&quot;The _fields of any subclass become its attritubes and __init__ args.&quot;</span>

    <span class="n">_fields</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Now bind default values of optional arguments.</span>
        <span class="c1"># If it seems like there should be a cleaner way to do this, see</span>
        <span class="c1"># http://bugs.python.org/msg221104</span>
        <span class="n">bound</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">__signature__</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__signature__</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bound</span><span class="o">.</span><span class="n">arguments</span> <span class="ow">and</span> <span class="n">param</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">_empty</span><span class="p">:</span>
                <span class="n">bound</span><span class="o">.</span><span class="n">arguments</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="n">default</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">bound</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flyers</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="s2">&quot;Update attributes as keyword arguments.&quot;</span>
        <span class="k">for</span> <span class="n">attr</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">val</span><span class="p">)</span>


<span class="n">SUBS_NAMES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="s2">&quot;stop&quot;</span><span class="p">,</span> <span class="s2">&quot;event&quot;</span><span class="p">,</span> <span class="s2">&quot;descriptor&quot;</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">normalize_subs_input</span><span class="p">(</span><span class="n">subs</span><span class="p">):</span>
    <span class="s2">&quot;Accept a callable, a list, or a dict. Normalize to a dict of lists.&quot;</span>
    <span class="n">normalized</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">SUBS_NAMES</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">subs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="nb">callable</span><span class="p">(</span><span class="n">subs</span><span class="p">):</span>
        <span class="n">normalized</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">subs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">subs</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">funcs</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">subs</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">SUBS_NAMES</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Keys must be one of </span><span class="si">{</span><span class="n">SUBS_NAMES</span><span class="si">!r:</span><span class="s2">0</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">funcs</span><span class="p">):</span>
                <span class="n">normalized</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">funcs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">normalized</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">funcs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subs</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
        <span class="n">normalized</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">subs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;Subscriptions should be a callable, a list of &quot;</span>
            <span class="s2">&quot;callables, or a dictionary mapping subscription &quot;</span>
            <span class="s2">&quot;names to lists of callables.&quot;</span>
        <span class="p">)</span>
    <span class="c1"># Validates that all entries are callables.</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">funcs</span> <span class="ow">in</span> <span class="n">normalized</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>  <span class="c1"># noqa: B007</span>
        <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;subs values must be functions or lists of functions. The offending entry is</span><span class="se">\n</span><span class="s2"> &quot;</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">func</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
    <span class="k">return</span> <span class="n">normalized</span>


<span class="k">class</span> <span class="nc">DefaultSubs</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;a class-level descriptor&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">normalize_subs_input</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_value</span>

    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_value</span> <span class="o">=</span> <span class="n">normalize_subs_input</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Subs</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;a &#39;reusable&#39; property&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="n">normalize_subs_input</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">WeakKeyDictionary</span><span class="p">()</span>

    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="n">instance</span><span class="p">]</span> <span class="o">=</span> <span class="n">normalize_subs_input</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">snake_cyclers</span><span class="p">(</span><span class="n">cyclers</span><span class="p">,</span> <span class="n">snake_booleans</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combine cyclers with a &#39;snaking&#39; back-and-forth order.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cyclers : cycler.Cycler</span>
<span class="sd">        or any iterable that yields dictionaries of lists</span>
<span class="sd">    snake_booleans : list</span>
<span class="sd">        a list of the same length as cyclers indicating whether each cycler</span>
<span class="sd">        should &#39;snake&#39; (True) or not (False). Note that the first boolean</span>
<span class="sd">        does not make a difference because the first (slowest) dimension</span>
<span class="sd">        does not repeat.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    result : cycler</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cyclers</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">snake_booleans</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;number of cyclers does not match number of booleans&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">snake_booleans</span><span class="p">[</span><span class="mi">1</span><span class="p">:]):</span>
        <span class="k">return</span> <span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">mul</span><span class="p">,</span> <span class="n">cyclers</span><span class="p">)</span>
    <span class="n">lengths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">new_cyclers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">cyclers</span><span class="p">:</span>
        <span class="n">lengths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
    <span class="n">total_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">lengths</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">snake</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">cyclers</span><span class="p">,</span> <span class="n">snake_booleans</span><span class="p">)):</span>
        <span class="n">num_tiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">lengths</span><span class="p">[:</span><span class="n">i</span><span class="p">])</span>
        <span class="n">num_repeats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">lengths</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">:])</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">_transpose</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">snake</span><span class="p">:</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">v</span> <span class="o">+</span> <span class="n">v</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">num_repeats</span><span class="p">),</span> <span class="n">num_tiles</span><span class="p">)</span>
            <span class="n">expanded</span> <span class="o">=</span> <span class="n">v2</span><span class="p">[:</span><span class="n">total_length</span><span class="p">]</span>
            <span class="n">new_cyclers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cycler</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">expanded</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="n">new_cyclers</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">first_key_heuristic</span><span class="p">(</span><span class="n">device</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get the fully-qualified data key for the first entry in describe().</span>

<span class="sd">    This will raise is that entry&#39;s `describe()` method does not return a</span>
<span class="sd">    dictionary with exactly one key.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="n">device</span><span class="o">.</span><span class="n">describe</span><span class="p">()))</span>


<span class="k">def</span> <span class="nf">ancestry</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List self, parent, grandparent, ... back to ultimate ancestor.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    obj : object</span>
<span class="sd">        must have a `parent` attribute</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ancestry : list</span>
<span class="sd">        list of objects, starting with obj and tracing parents recursively</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ancestry</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">ancestor</span> <span class="o">=</span> <span class="n">obj</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">ancestry</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ancestor</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ancestor</span><span class="o">.</span><span class="n">parent</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ancestry</span>
        <span class="n">ancestor</span> <span class="o">=</span> <span class="n">ancestor</span><span class="o">.</span><span class="n">parent</span>


<span class="k">def</span> <span class="nf">root_ancestor</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Traverse ancestry to obtain root ancestor.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    obj : object</span>
<span class="sd">        must have a `parent` attribute</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    root : object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">ancestry</span><span class="p">(</span><span class="n">obj</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">share_ancestor</span><span class="p">(</span><span class="n">obj1</span><span class="p">,</span> <span class="n">obj2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check whether obj1 and obj2 have a common ancestor.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    obj1 : object</span>
<span class="sd">        must have a `parent` attribute</span>
<span class="sd">    obj2 : object</span>
<span class="sd">        must have a `parent` attribute</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    result : boolean</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">ancestry</span><span class="p">(</span><span class="n">obj1</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="n">ancestry</span><span class="p">(</span><span class="n">obj2</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">separate_devices</span><span class="p">(</span><span class="n">devices</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter out elements that have other elements as their ancestors.</span>

<span class="sd">    If A is an ancestor of B, [A, B, C] -&gt; [A, C].</span>

<span class="sd">    Paremeters</span>
<span class="sd">    ----------</span>
<span class="sd">    devices : list</span>
<span class="sd">        All elements must have a `parent` attribute.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    result : list</span>
<span class="sd">        subset of input, with order retained</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">existing_det</span> <span class="ow">in</span> <span class="n">result</span><span class="p">[:]:</span>
            <span class="k">if</span> <span class="n">existing_det</span> <span class="ow">in</span> <span class="n">ancestry</span><span class="p">(</span><span class="n">det</span><span class="p">):</span>
                <span class="c1"># known issue: here we assume that det is in the read_attrs</span>
                <span class="c1"># of existing_det -- to be addressed after plans.py refactor</span>
                <span class="k">break</span>
            <span class="k">elif</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">ancestry</span><span class="p">(</span><span class="n">existing_det</span><span class="p">):</span>
                <span class="c1"># existing_det is redundant; use det in its place</span>
                <span class="n">result</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">existing_det</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">det</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">all_safe_rewind</span><span class="p">(</span><span class="n">devices</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;If all devices can have their trigger method re-run on resume.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    devices : list</span>
<span class="sd">        List of devices</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    safe_rewind : bool</span>
<span class="sd">       If all the device can safely re-triggered</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="s2">&quot;rewindable&quot;</span><span class="p">):</span>
            <span class="n">rewindable</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">rewindable</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rewindable</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="kc">True</span>


<div class="viewcode-block" id="PersistentDict">
<a class="viewcode-back" href="../../generated/bluesky.utils.PersistentDict.html#bluesky.utils.PersistentDict">[docs]</a>
<span class="k">class</span> <span class="nc">PersistentDict</span><span class="p">(</span><span class="n">collections</span><span class="o">.</span><span class="n">abc</span><span class="o">.</span><span class="n">MutableMapping</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A MutableMapping which syncs it contents to disk.</span>

<span class="sd">    The contents are stored as msgpack-serialized files, with one file per item</span>
<span class="sd">    in the mapping.</span>

<span class="sd">    Note that when an item is *mutated* it is not immediately synced:</span>

<span class="sd">    &gt;&gt;&gt; d[&#39;sample&#39;] = {&quot;color&quot;: &quot;red&quot;}  # immediately synced</span>
<span class="sd">    &gt;&gt;&gt; d[&#39;sample&#39;][&#39;shape&#39;] = &#39;bar&#39;  # not immediately synced</span>

<span class="sd">    but that the full contents are synced to disk when the PersistentDict</span>
<span class="sd">    instance is garbage collected.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="PersistentDict.__init__">
<a class="viewcode-back" href="../../generated/bluesky.utils.PersistentDict.html#bluesky.utils.PersistentDict.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_directory</span> <span class="o">=</span> <span class="n">directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_file</span> <span class="o">=</span> <span class="n">zict</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_func</span> <span class="o">=</span> <span class="n">zict</span><span class="o">.</span><span class="n">Func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_dump</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reload</span><span class="p">()</span>

        <span class="c1"># Similar to flush() or _do_update(), but without reference to self</span>
        <span class="c1"># to avoid circular reference preventing collection.</span>
        <span class="c1"># NOTE: This still doesn&#39;t guarantee call on delete or gc.collect()!</span>
        <span class="c1">#       Explicitly call flush() if immediate write to disk required.</span>
        <span class="k">def</span> <span class="nf">finalize</span><span class="p">(</span><span class="n">zfile</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span> <span class="n">dump</span><span class="p">):</span>
            <span class="n">zfile</span><span class="o">.</span><span class="n">update</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">dump</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">cache</span><span class="o">.</span><span class="n">items</span><span class="p">())</span>

        <span class="kn">import</span> <span class="nn">weakref</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_finalizer</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">finalize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">finalize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_file</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">,</span> <span class="n">PersistentDict</span><span class="o">.</span><span class="n">_dump</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">directory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_directory</span>

    <span class="k">def</span> <span class="fm">__setitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_func</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span> <span class="fm">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__delitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__len__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;&lt;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="si">!r}</span><span class="s2">&gt;&quot;</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span>

    <span class="k">def</span> <span class="nf">popitem</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span><span class="o">.</span><span class="n">popitem</span><span class="p">()</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_func</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_dump</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
        <span class="s2">&quot;Encode as msgpack using numpy-aware encoder.&quot;</span>
        <span class="c1"># See https://github.com/msgpack/msgpack-python#string-and-binary-type</span>
        <span class="c1"># for more on use_bin_type.</span>
        <span class="k">return</span> <span class="n">msgpack</span><span class="o">.</span><span class="n">packb</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">msgpack_numpy</span><span class="o">.</span><span class="n">encode</span><span class="p">,</span> <span class="n">use_bin_type</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_load</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">msgpack</span><span class="o">.</span><span class="n">unpackb</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">object_hook</span><span class="o">=</span><span class="n">msgpack_numpy</span><span class="o">.</span><span class="n">decode</span><span class="p">,</span> <span class="n">raw</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">flush</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Force a write of the current state to disk&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_func</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">def</span> <span class="nf">reload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Force a reload from disk, overwriting current cache&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_cache</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_func</span><span class="o">.</span><span class="n">items</span><span class="p">())</span></div>



<span class="n">SEARCH_PATH</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">ENV_VAR</span> <span class="o">=</span> <span class="s2">&quot;BLUESKY_HISTORY_PATH&quot;</span>
<span class="k">if</span> <span class="n">ENV_VAR</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">:</span>
    <span class="n">SEARCH_PATH</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="n">ENV_VAR</span><span class="p">])</span>
<span class="n">SEARCH_PATH</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="s2">&quot;~/.config/bluesky/bluesky_history.db&quot;</span><span class="p">),</span>
        <span class="s2">&quot;/etc/bluesky/bluesky_history.db&quot;</span><span class="p">,</span>
    <span class="p">]</span>
<span class="p">)</span>


<span class="k">def</span> <span class="nf">get_history</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    DEPRECATED: Return a dict-like object for stashing metadata.</span>

<span class="sd">    If historydict is not installed, return a dict.</span>

<span class="sd">    If historydict is installed, look for a sqlite file in:</span>
<span class="sd">      - $BLUESKY_HISTORY_PATH, if defined</span>
<span class="sd">      - ~/.config/bluesky/bluesky_history.db</span>
<span class="sd">      - /etc/bluesky/bluesky_history.db</span>

<span class="sd">    If no existing file is found, create a new sqlite file in:</span>
<span class="sd">      - $BLUESKY_HISTORY_PATH, if defined</span>
<span class="sd">      - ~/.config/bluesky/bluesky_history.db, otherwise</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">historydict</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;You do not have historydict installed, your metadata &quot;</span>
            <span class="s2">&quot;will not be persistent or have any history of the &quot;</span>
            <span class="s2">&quot;values.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># noqa: C408</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">SEARCH_PATH</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading metadata history from </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">historydict</span><span class="o">.</span><span class="n">HistoryDict</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="c1"># No existing file was found. Try creating one.</span>
        <span class="n">path</span> <span class="o">=</span> <span class="n">SEARCH_PATH</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Storing metadata history in a new file at </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">historydict</span><span class="o">.</span><span class="n">HistoryDict</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">exc</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create metadata history file at </span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Storing HistoryDict in memory; it will not persist when session is ended.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">historydict</span><span class="o">.</span><span class="n">HistoryDict</span><span class="p">(</span><span class="s2">&quot;:memory:&quot;</span><span class="p">)</span>


<span class="n">_QT_KICKER_INSTALLED</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">_NB_KICKER_INSTALLED</span> <span class="o">=</span> <span class="p">{}</span>


<div class="viewcode-block" id="install_kicker">
<a class="viewcode-back" href="../../callbacks.html#bluesky.utils.install_kicker">[docs]</a>
<span class="k">def</span> <span class="nf">install_kicker</span><span class="p">(</span><span class="n">loop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_rate</span><span class="o">=</span><span class="mf">0.03</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Install a periodic callback to integrate drawing and asyncio event loops.</span>

<span class="sd">    This dispatches to :func:`install_qt_kicker` or :func:`install_nb_kicker`</span>
<span class="sd">    depending on the current matplotlib backend.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    loop : event loop, optional</span>
<span class="sd">    update_rate : number</span>
<span class="sd">        Seconds between periodic updates. Default is 0.03.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span>

    <span class="n">backend</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">get_backend</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">backend</span> <span class="o">==</span> <span class="s2">&quot;nbAgg&quot;</span><span class="p">:</span>
        <span class="n">install_nb_kicker</span><span class="p">(</span><span class="n">loop</span><span class="o">=</span><span class="n">loop</span><span class="p">,</span> <span class="n">update_rate</span><span class="o">=</span><span class="n">update_rate</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">backend</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;Qt4Agg&quot;</span><span class="p">,</span> <span class="s2">&quot;Qt5Agg&quot;</span><span class="p">):</span>
        <span class="n">install_qt_kicker</span><span class="p">(</span><span class="n">loop</span><span class="o">=</span><span class="n">loop</span><span class="p">,</span> <span class="n">update_rate</span><span class="o">=</span><span class="n">update_rate</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The matplotlib backend </span><span class="si">{</span><span class="n">backend</span><span class="si">}</span><span class="s2"> is not yet supported.&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="install_qt_kicker">
<a class="viewcode-back" href="../../callbacks.html#bluesky.utils.install_qt_kicker">[docs]</a>
<span class="k">def</span> <span class="nf">install_qt_kicker</span><span class="p">(</span><span class="n">loop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_rate</span><span class="o">=</span><span class="mf">0.03</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Install a periodic callback to integrate Qt and asyncio event loops.</span>

<span class="sd">    DEPRECATED: This functionality is now handled automatically by default and</span>
<span class="sd">    is configurable via the RunEngine&#39;s new ``during_task`` parameter. Calling</span>
<span class="sd">    this function now has no effect. It will be removed in a future release of</span>
<span class="sd">    bluesky.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    loop : event loop, optional</span>
<span class="sd">    update_rate : number</span>
<span class="sd">        Seconds between periodic updates. Default is 0.03.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>  <span class="c1"># noqa: B028</span>
        <span class="s2">&quot;bluesky.utils.install_qt_kicker is no longer necessary and &quot;</span>
        <span class="s2">&quot;has no effect. Please remove your use of it. It may be &quot;</span>
        <span class="s2">&quot;removed in a future release of bluesky.&quot;</span>
    <span class="p">)</span></div>



<span class="k">def</span> <span class="nf">install_remote_qt_kicker</span><span class="p">(</span><span class="n">loop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_rate</span><span class="o">=</span><span class="mf">0.03</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Install a periodic callback to integrate Qt and asyncio event loops.</span>

<span class="sd">    If a version of the Qt bindings are not already imported, this function</span>
<span class="sd">    will do nothing.</span>

<span class="sd">    It is safe to call this function multiple times.</span>

<span class="sd">    This is used when a Qt event loop is required and the process that needs</span>
<span class="sd">    it is different that the process that created the RunEngine,</span>
<span class="sd">    (see docstring for deprecated install_qt_kicker above)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    loop : event loop, optional</span>
<span class="sd">    update_rate : number</span>
<span class="sd">        Seconds between periodic updates. Default is 0.03.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">loop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
    <span class="k">global</span> <span class="n">_QT_KICKER_INSTALLED</span>
    <span class="k">if</span> <span class="n">loop</span> <span class="ow">in</span> <span class="n">_QT_KICKER_INSTALLED</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">any</span><span class="p">(</span><span class="n">p</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;PyQt4&quot;</span><span class="p">,</span> <span class="s2">&quot;pyside&quot;</span><span class="p">,</span> <span class="s2">&quot;PyQt5&quot;</span><span class="p">]):</span>
        <span class="k">return</span>

    <span class="kn">import</span> <span class="nn">matplotlib.backends.backend_qt</span>
    <span class="kn">from</span> <span class="nn">matplotlib._pylab_helpers</span> <span class="kn">import</span> <span class="n">Gcf</span>
    <span class="kn">from</span> <span class="nn">matplotlib.backends.backend_qt</span> <span class="kn">import</span> <span class="n">_create_qApp</span>

    <span class="n">_create_qApp</span><span class="p">()</span>
    <span class="n">qApp</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">backends</span><span class="o">.</span><span class="n">backend_qt</span><span class="o">.</span><span class="n">qApp</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">_draw_all</span> <span class="o">=</span> <span class="n">Gcf</span><span class="o">.</span><span class="n">draw_all</span>  <span class="c1"># mpl version &gt;= 1.5</span>
    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
        <span class="c1"># slower, but backward-compatible</span>
        <span class="k">def</span> <span class="nf">_draw_all</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">f_mgr</span> <span class="ow">in</span> <span class="n">Gcf</span><span class="o">.</span><span class="n">get_all_fig_managers</span><span class="p">():</span>
                <span class="n">f_mgr</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw_idle</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_qt_kicker</span><span class="p">():</span>
        <span class="c1"># The RunEngine Event Loop interferes with the qt event loop. Here we</span>
        <span class="c1"># kick it to keep it going.</span>
        <span class="n">_draw_all</span><span class="p">()</span>

        <span class="n">qApp</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
        <span class="n">loop</span><span class="o">.</span><span class="n">call_later</span><span class="p">(</span><span class="n">update_rate</span><span class="p">,</span> <span class="n">_qt_kicker</span><span class="p">)</span>

    <span class="n">_QT_KICKER_INSTALLED</span><span class="p">[</span><span class="n">loop</span><span class="p">]</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">call_soon</span><span class="p">(</span><span class="n">_qt_kicker</span><span class="p">)</span>


<div class="viewcode-block" id="install_nb_kicker">
<a class="viewcode-back" href="../../callbacks.html#bluesky.utils.install_nb_kicker">[docs]</a>
<span class="k">def</span> <span class="nf">install_nb_kicker</span><span class="p">(</span><span class="n">loop</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_rate</span><span class="o">=</span><span class="mf">0.03</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Install a periodic callback to integrate ipykernel and asyncio event loops.</span>

<span class="sd">    It is safe to call this function multiple times.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    loop : event loop, optional</span>
<span class="sd">    update_rate : number</span>
<span class="sd">        Seconds between periodic updates. Default is 0.03.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span>

    <span class="k">if</span> <span class="n">loop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
    <span class="k">global</span> <span class="n">_NB_KICKER_INSTALLED</span>
    <span class="k">if</span> <span class="n">loop</span> <span class="ow">in</span> <span class="n">_NB_KICKER_INSTALLED</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="k">def</span> <span class="nf">_nbagg_kicker</span><span class="p">():</span>
        <span class="c1"># This is more brute-force variant of the _qt_kicker function used</span>
        <span class="c1"># inside install_qt_kicker.</span>
        <span class="k">for</span> <span class="n">f_mgr</span> <span class="ow">in</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">_pylab_helpers</span><span class="o">.</span><span class="n">Gcf</span><span class="o">.</span><span class="n">get_all_fig_managers</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">f_mgr</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">stale</span><span class="p">:</span>
                <span class="n">f_mgr</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

        <span class="n">loop</span><span class="o">.</span><span class="n">call_later</span><span class="p">(</span><span class="n">update_rate</span><span class="p">,</span> <span class="n">_nbagg_kicker</span><span class="p">)</span>

    <span class="n">_NB_KICKER_INSTALLED</span><span class="p">[</span><span class="n">loop</span><span class="p">]</span> <span class="o">=</span> <span class="n">loop</span><span class="o">.</span><span class="n">call_soon</span><span class="p">(</span><span class="n">_nbagg_kicker</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">apply_sub_factories</span><span class="p">(</span><span class="n">factories</span><span class="p">,</span> <span class="n">plan</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Run sub factory functions for a plan</span>

<span class="sd">    Factory functions should return lists, which will be added onto the</span>
<span class="sd">    subscription key (e.g., &#39;all&#39; or &#39;start&#39;) specified in the factory</span>
<span class="sd">    definition.</span>

<span class="sd">    If the factory function returns None, the list will not be modified.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">factories</span> <span class="o">=</span> <span class="n">normalize_subs_input</span><span class="p">(</span><span class="n">factories</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">k</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">filterfalse</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">,</span> <span class="p">(</span><span class="n">sf</span><span class="p">(</span><span class="n">plan</span><span class="p">)</span> <span class="k">for</span> <span class="n">sf</span> <span class="ow">in</span> <span class="n">v</span><span class="p">)))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">factories</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">update_sub_lists</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">inp</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Extends dictionary `out` lists with those in `inp`</span>

<span class="sd">    Assumes dictionaries where all values are lists</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">inp</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">out</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">register_transform</span><span class="p">(</span><span class="n">RE</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="n">ip</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Register RunEngine IPython magic convenience transform</span>
<span class="sd">    Assuming the default parameters</span>
<span class="sd">    This maps `&lt; stuff(*args, **kwargs)` -&gt; `RE(stuff(*args, **kwargs))`</span>
<span class="sd">    RE is assumed to be available in the global namespace</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    RE : str</span>
<span class="sd">        The name of a valid RunEngine instance in the global IPython namespace</span>
<span class="sd">    prefix : str, optional</span>
<span class="sd">        The prefix to trigger this transform on.  If this collides with</span>
<span class="sd">        valid python syntax or an existing transform you are on your own.</span>
<span class="sd">    ip : IPython shell, optional</span>
<span class="sd">        If not passed, uses `IPython.get_ipython()` to get the current shell</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">import</span> <span class="nn">IPython</span>

    <span class="k">if</span> <span class="n">ip</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">ip</span> <span class="o">=</span> <span class="n">IPython</span><span class="o">.</span><span class="n">get_ipython</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">IPython</span><span class="o">.</span><span class="n">__version__</span> <span class="o">&gt;=</span> <span class="s2">&quot;7&quot;</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">tr_re</span><span class="p">(</span><span class="n">lines</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">lines</span>
            <span class="p">(</span><span class="n">line</span><span class="p">,)</span> <span class="o">=</span> <span class="n">lines</span>
            <span class="n">head</span><span class="p">,</span> <span class="n">split</span><span class="p">,</span> <span class="n">tail</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">partition</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">split</span> <span class="o">==</span> <span class="n">prefix</span> <span class="ow">and</span> <span class="n">head</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">RE</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">tail</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2">)</span><span class="se">\n</span><span class="s2">&quot;</span>

            <span class="k">return</span> <span class="p">[</span><span class="n">line</span><span class="p">]</span>

        <span class="n">ip</span><span class="o">.</span><span class="n">input_transformers_post</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tr_re</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">IPython.core.inputtransformer</span> <span class="kn">import</span> <span class="n">StatelessInputTransformer</span>

        <span class="nd">@StatelessInputTransformer</span><span class="o">.</span><span class="n">wrap</span>
        <span class="k">def</span> <span class="nf">tr_re</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">prefix</span><span class="p">):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">prefix</span><span class="p">)</span> <span class="p">:]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">RE</span><span class="si">}</span><span class="s2">(</span><span class="si">{</span><span class="n">line</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="k">return</span> <span class="n">line</span>

        <span class="n">ip</span><span class="o">.</span><span class="n">input_splitter</span><span class="o">.</span><span class="n">logical_line_transforms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tr_re</span><span class="p">())</span>
        <span class="n">ip</span><span class="o">.</span><span class="n">input_transformer_manager</span><span class="o">.</span><span class="n">logical_line_transforms</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tr_re</span><span class="p">())</span>


<span class="k">class</span> <span class="nc">AsyncInput</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;a input prompt that allows event loop to run in the background</span>

<span class="sd">    adapted from http://stackoverflow.com/a/35514777/1221924</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">loop</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span> <span class="o">=</span> <span class="n">loop</span> <span class="ow">or</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">(</span><span class="n">loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">add_reader</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">got_input</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">got_input</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdin</span><span class="o">.</span><span class="n">readline</span><span class="p">()),</span> <span class="n">loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prompt</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="n">flush</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">())</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">new_uid</span><span class="p">():</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">uuid</span><span class="o">.</span><span class="n">uuid4</span><span class="p">())</span>


<span class="k">def</span> <span class="nf">sanitize_np</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
    <span class="s2">&quot;Convert any numpy objects into built-in Python types.&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">generic</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isscalar</span><span class="p">(</span><span class="n">val</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">val</span><span class="o">.</span><span class="n">item</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">val</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">val</span>


<span class="k">def</span> <span class="nf">expiring_function</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">loop</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    If timeout has not occurred, call func(*args, **kwargs).</span>

<span class="sd">    This is meant to used with the event loop&#39;s run_in_executor</span>
<span class="sd">    method. Outside that context, it doesn&#39;t make any sense.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">dummy</span><span class="p">(</span><span class="n">start_time</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">loop</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">start_time</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">return</span> <span class="n">dummy</span>


<span class="k">def</span> <span class="nf">short_uid</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">truncate</span><span class="o">=</span><span class="mi">6</span><span class="p">):</span>
    <span class="s2">&quot;Return a readable but unique id like &#39;label-fjfi5a&#39;&quot;</span>
    <span class="k">if</span> <span class="n">label</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">label</span><span class="p">,</span> <span class="n">new_uid</span><span class="p">()[:</span><span class="n">truncate</span><span class="p">]])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">new_uid</span><span class="p">()[:</span><span class="n">truncate</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">ensure_uid</span><span class="p">(</span><span class="n">doc_or_uid</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Accept a uid or a dict with a &#39;uid&#39; key. Return the uid.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">doc_or_uid</span><span class="p">[</span><span class="s2">&quot;uid&quot;</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">doc_or_uid</span>


<span class="k">def</span> <span class="nf">ts_msg_hook</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">):</span>
    <span class="n">t</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="si">:</span><span class="s2">%H:%M:%S.%f</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">msg_fmt</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{: &lt;17s}</span><span class="s2"> -&gt; </span><span class="si">{!s: &lt;15s}</span><span class="s2"> args: </span><span class="si">{}</span><span class="s2">, kwargs: </span><span class="si">{}</span><span class="s2">, run: </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">command</span><span class="p">,</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">msg</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">args</span><span class="p">,</span>
        <span class="n">msg</span><span class="o">.</span><span class="n">kwargs</span><span class="p">,</span>
        <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">run</span><span class="si">}</span><span class="s2">&#39;&quot;</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">run</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="k">else</span> <span class="n">msg</span><span class="o">.</span><span class="n">run</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">msg_fmt</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">file</span><span class="p">)</span>


<div class="viewcode-block" id="make_decorator">
<a class="viewcode-back" href="../../generated/bluesky.preprocessors.make_decorator.html#bluesky.utils.make_decorator">[docs]</a>
<span class="k">def</span> <span class="nf">make_decorator</span><span class="p">(</span><span class="n">wrapper</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Turn a generator instance wrapper into a generator function decorator.</span>

<span class="sd">    The functions named &lt;something&gt;_wrapper accept a generator instance and</span>
<span class="sd">    return a mutated generator instance.</span>

<span class="sd">    Example of a &#39;wrapper&#39;:</span>
<span class="sd">    &gt;&gt;&gt; plan = count([det])  # returns a generator instance</span>
<span class="sd">    &gt;&gt;&gt; revised_plan = some_wrapper(plan)  # returns a new instance</span>

<span class="sd">    Example of a decorator:</span>
<span class="sd">    &gt;&gt;&gt; some_decorator = make_decorator(some_wrapper)  # returns decorator</span>
<span class="sd">    &gt;&gt;&gt; customized_count = some_decorator(count)  # returns generator func</span>
<span class="sd">    &gt;&gt;&gt; plan = customized_count([det])  # returns a generator instance</span>

<span class="sd">    This turns a &#39;wrapper&#39; into a decorator, which accepts a generator</span>
<span class="sd">    function and returns a generator function.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">wrapper</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">dec_outer</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">dec</span><span class="p">(</span><span class="n">gen_func</span><span class="p">):</span>
            <span class="nd">@wraps</span><span class="p">(</span><span class="n">gen_func</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">dec_inner</span><span class="p">(</span><span class="o">*</span><span class="n">inner_args</span><span class="p">,</span> <span class="o">**</span><span class="n">inner_kwargs</span><span class="p">):</span>
                <span class="n">plan</span> <span class="o">=</span> <span class="n">gen_func</span><span class="p">(</span><span class="o">*</span><span class="n">inner_args</span><span class="p">,</span> <span class="o">**</span><span class="n">inner_kwargs</span><span class="p">)</span>
                <span class="n">plan</span> <span class="o">=</span> <span class="n">wrapper</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
                <span class="k">return</span> <span class="p">(</span><span class="k">yield from</span> <span class="n">plan</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">dec_inner</span>

        <span class="k">return</span> <span class="n">dec</span>

    <span class="k">return</span> <span class="n">dec_outer</span></div>



<span class="k">def</span> <span class="nf">apply_to_dict_recursively</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Recursively apply function to a document</span>

<span class="sd">    This modifies the dict in place and returns it.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    d: dict</span>
<span class="sd">        e.g. event_model Document</span>
<span class="sd">    f: function</span>
<span class="sd">       any func to be performed on d recursively</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="s2">&quot;items&quot;</span><span class="p">):</span>
            <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">apply_to_dict_recursively</span><span class="p">(</span><span class="n">d</span><span class="o">=</span><span class="n">val</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="n">f</span><span class="p">)</span>
        <span class="n">d</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">d</span>


<span class="k">class</span> <span class="nc">ProgressBarBase</span><span class="p">(</span><span class="n">abc</span><span class="o">.</span><span class="n">ABC</span><span class="p">):</span>  <span class="c1"># noqa: B024</span>
    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span>  <span class="c1"># noqa: B027</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pos</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">current</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">initial</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">target</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">unit</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;units&quot;</span><span class="p">,</span>
        <span class="n">precision</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">fraction</span><span class="p">:</span> <span class="n">Any</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">time_elapsed</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">time_remaining</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span> <span class="o">...</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="o">...</span>  <span class="c1"># noqa: B027</span>


<span class="k">class</span> <span class="nc">TerminalProgressBar</span><span class="p">(</span><span class="n">ProgressBarBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_objs</span><span class="p">,</span> <span class="n">delay_draw</span><span class="o">=</span><span class="mf">0.2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Represent status objects with a progress bars.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        status_objs : list</span>
<span class="sd">            Status objects</span>
<span class="sd">        delay_draw : float, optional</span>
<span class="sd">            To avoid flashing progress bars that will complete quickly after</span>
<span class="sd">            they are displayed, delay drawing until the progress bar has been</span>
<span class="sd">            around for awhile. Default is 0.2 seconds.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">meters</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status_objs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># Determine terminal width.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ncols</span> <span class="o">=</span> <span class="n">_screen_shape_wrapper</span><span class="p">()(</span><span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">or</span> <span class="mi">79</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fp</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">creation_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">delay_draw</span> <span class="o">=</span> <span class="n">delay_draw</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drawn</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>

        <span class="c1"># If the ProgressBar is not finished before the delay_draw time but</span>
        <span class="c1"># never again updated after the delay_draw time, we need to draw it</span>
        <span class="c1"># once.</span>
        <span class="k">if</span> <span class="n">delay_draw</span><span class="p">:</span>
            <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ensure_draw</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="c1"># Create a closure over self.update for each status object that</span>
        <span class="c1"># implemets the &#39;watch&#39; method.</span>
        <span class="k">for</span> <span class="n">st</span> <span class="ow">in</span> <span class="n">status_objs</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">st</span><span class="p">,</span> <span class="s2">&quot;watch&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">st</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
                    <span class="n">pos</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meters</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">meters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">status_objs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">st</span><span class="p">)</span>
                    <span class="n">st</span><span class="o">.</span><span class="n">watch</span><span class="p">(</span><span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">update</span><span class="p">,</span> <span class="n">pos</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">pos</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">current</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">initial</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">unit</span><span class="o">=</span><span class="s2">&quot;units&quot;</span><span class="p">,</span>
        <span class="n">precision</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">fraction</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">time_elapsed</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">time_remaining</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">initial</span><span class="p">,</span> <span class="n">target</span><span class="p">)):</span>
            <span class="c1"># Display a proper progress bar.</span>
            <span class="n">total</span> <span class="o">=</span> <span class="nb">round</span><span class="p">(</span><span class="n">_L2norm</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">initial</span><span class="p">),</span> <span class="n">precision</span> <span class="ow">or</span> <span class="mi">3</span><span class="p">)</span>
            <span class="c1"># make sure we ignore overshoot to prevent tqdm from exploding.</span>
            <span class="n">n</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">_L2norm</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="n">initial</span><span class="p">),</span> <span class="n">precision</span> <span class="ow">or</span> <span class="mi">3</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span>
            <span class="c1"># Compute this only if the status object did not provide it.</span>
            <span class="k">if</span> <span class="n">time_elapsed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">time_elapsed</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">creation_time</span>
            <span class="c1"># TODO Account for &#39;fraction&#39;, which might in some special cases</span>
            <span class="c1"># differ from the naive computation above.</span>
            <span class="c1"># TODO Account for &#39;time_remaining&#39; which might in some special</span>
            <span class="c1"># cases differ from the naive computaiton performed by</span>
            <span class="c1"># format_meter.</span>
            <span class="n">meter</span> <span class="o">=</span> <span class="n">tqdm</span><span class="o">.</span><span class="n">format_meter</span><span class="p">(</span>
                <span class="n">n</span><span class="o">=</span><span class="n">n</span><span class="p">,</span>
                <span class="n">total</span><span class="o">=</span><span class="n">total</span><span class="p">,</span>
                <span class="n">elapsed</span><span class="o">=</span><span class="n">time_elapsed</span><span class="p">,</span>
                <span class="n">unit</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span>
                <span class="n">prefix</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
                <span class="n">ncols</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ncols</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Simply display completeness.</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">status_objs</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
                <span class="n">meter</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; [Complete.]&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">meter</span> <span class="o">=</span> <span class="n">name</span> <span class="o">+</span> <span class="s2">&quot; [In progress. No progress bar available.]&quot;</span>
            <span class="n">meter</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ncols</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">meter</span><span class="p">))</span>
            <span class="n">meter</span> <span class="o">=</span> <span class="n">meter</span><span class="p">[:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncols</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">meters</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">meter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">creation_time</span><span class="p">)</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">delay_draw</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">for</span> <span class="n">meter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meters</span><span class="p">:</span>
                <span class="n">tqdm</span><span class="o">.</span><span class="n">status_printer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="p">)(</span><span class="n">meter</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">_unicode</span><span class="p">(</span><span class="n">_term_move_up</span><span class="p">()</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meters</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">drawn</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span> <span class="nf">_ensure_draw</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Ensure that the progress bar is drawn at least once after the delay.</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">delay_draw</span><span class="p">)</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">done</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawn</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawn</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">meter</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">meters</span><span class="p">:</span>  <span class="c1"># noqa: B007</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ncols</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">fp</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">_unicode</span><span class="p">(</span><span class="n">_term_move_up</span><span class="p">()</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">meters</span><span class="p">)))</span>


<div class="viewcode-block" id="ProgressBar">
<a class="viewcode-back" href="../../generated/bluesky.utils.ProgressBar.html#bluesky.utils.ProgressBar">[docs]</a>
<span class="k">class</span> <span class="nc">ProgressBar</span><span class="p">(</span><span class="n">TerminalProgressBar</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Alias for backwards compatibility</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="o">...</span></div>



<span class="k">def</span> <span class="nf">default_progress_bar</span><span class="p">(</span><span class="n">status_objs_or_none</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ProgressBarBase</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">TerminalProgressBar</span><span class="p">(</span><span class="n">status_objs_or_none</span><span class="p">,</span> <span class="n">delay_draw</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>


<div class="viewcode-block" id="ProgressBarManager">
<a class="viewcode-back" href="../../generated/bluesky.utils.ProgressBarManager.html#bluesky.utils.ProgressBarManager">[docs]</a>
<span class="k">class</span> <span class="nc">ProgressBarManager</span><span class="p">:</span>
    <span class="n">pbar_factory</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">ProgressBarBase</span><span class="p">]</span>
    <span class="n">pbar</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ProgressBarBase</span><span class="p">]</span>

<div class="viewcode-block" id="ProgressBarManager.__init__">
<a class="viewcode-back" href="../../generated/bluesky.utils.ProgressBarManager.html#bluesky.utils.ProgressBarManager.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pbar_factory</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Any</span><span class="p">],</span> <span class="n">ProgressBarBase</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_progress_bar</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Manages creation and tearing down of progress bars.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pbar_factory : Callable[[Any], ProgressBar], optional</span>
<span class="sd">            A function that creates a progress bar given an optional list of status objects,</span>
<span class="sd">            by default default_progress_bar</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pbar_factory</span> <span class="o">=</span> <span class="n">pbar_factory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pbar</span> <span class="o">=</span> <span class="kc">None</span></div>


    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">status_objs_or_none</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Updates the manager with a new set of status, creates a new progress bar and</span>
<span class="sd">        cleans up the old one if needed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        status_objs_or_none : Set[Status], optional</span>
<span class="sd">            Optional list of status objects to be passed to the factory.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">status_objs_or_none</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Start a new ProgressBar.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbar</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;Previous ProgressBar never competed.&quot;</span><span class="p">)</span>  <span class="c1"># noqa: B028</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pbar</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pbar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbar_factory</span><span class="p">(</span><span class="n">status_objs_or_none</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Clean up an old one.</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pbar</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s2">&quot;There is no Progress bar to clean up.&quot;</span><span class="p">)</span>  <span class="c1"># noqa: B028</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pbar</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pbar</span> <span class="o">=</span> <span class="kc">None</span></div>



<span class="k">def</span> <span class="nf">_L2norm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="s2">&quot;works on (3, 5) and ((0, 3), (4, 0))&quot;</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">merge_axis</span><span class="p">(</span><span class="n">objs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Merge possibly related axis</span>

<span class="sd">    This function will take a list of objects and separate it into</span>

<span class="sd">     - list of completely independent objects (most settable things and</span>
<span class="sd">       detectors) that do not have coupled motion.</span>
<span class="sd">     - list of devices who have children who are coupled (PseudoPositioner</span>
<span class="sd">       ducked by looking for &#39;RealPosition&#39; as an attribute)</span>

<span class="sd">    Both of these lists will only contain objects directly passed in</span>
<span class="sd">    in objs</span>

<span class="sd">     - map between parents and objects passed in.  Each value</span>
<span class="sd">       of the map is a map between the strings</span>
<span class="sd">       {&#39;real&#39;, &#39;pseudo&#39;, &#39;independent&#39;} and a list of objects.  All</span>
<span class="sd">       of the objects in the (doubly nested) map are in the input.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    objs : Iterable[OphydObj]</span>
<span class="sd">        The input devices</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    independent_objs : List[OphydObj]</span>
<span class="sd">        Independent &#39;simple&#39; axis</span>

<span class="sd">    complex_objs : List[PseudoPositioner]</span>
<span class="sd">        Independent objects which have interdependent children</span>

<span class="sd">    coupled : Dict[PseudoPositioner, Dict[str, List[OphydObj]]]</span>
<span class="sd">        Mapping of interdependent axis passed in.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">get_parent</span><span class="p">(</span><span class="n">o</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">check_supports</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="n">HasParent</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span>

    <span class="n">independent_objs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">maybe_coupled</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">complex_objs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">o</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">:</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">o</span><span class="o">.</span><span class="n">parent</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">o</span><span class="p">,</span> <span class="s2">&quot;RealPosition&quot;</span><span class="p">):</span>
            <span class="n">complex_objs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="s2">&quot;RealPosition&quot;</span><span class="p">):</span>
            <span class="n">maybe_coupled</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">independent_objs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">o</span><span class="p">)</span>
    <span class="n">coupled</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">parent</span><span class="p">,</span> <span class="n">children</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">(</span><span class="n">get_parent</span><span class="p">,</span> <span class="n">maybe_coupled</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">real_p</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">real_positioners</span><span class="p">)</span>
        <span class="n">pseudo_p</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">parent</span><span class="o">.</span><span class="n">pseudo_positioners</span><span class="p">)</span>
        <span class="n">type_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;real&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;pseudo&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;unrelated&quot;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">real_p</span><span class="p">:</span>
                <span class="n">type_map</span><span class="p">[</span><span class="s2">&quot;real&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">pseudo_p</span><span class="p">:</span>
                <span class="n">type_map</span><span class="p">[</span><span class="s2">&quot;pseudo&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">type_map</span><span class="p">[</span><span class="s2">&quot;unrelated&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="n">coupled</span><span class="p">[</span><span class="n">parent</span><span class="p">]</span> <span class="o">=</span> <span class="n">type_map</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">independent_objs</span><span class="p">,</span> <span class="n">complex_objs</span><span class="p">,</span> <span class="n">coupled</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">merge_cycler</span><span class="p">(</span><span class="n">cyc</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Specify movements of sets of interdependent axes atomically.</span>

<span class="sd">    Inspect the keys of ``cyc`` (which are Devices) to indentify those</span>
<span class="sd">    which are interdependent (part of the same</span>
<span class="sd">    PseudoPositioner) and merge those independent entries into</span>
<span class="sd">    a single entry.</span>

<span class="sd">    This also validates that the user has not passed conflicting</span>
<span class="sd">    interdependent axis (such as a real and pseudo axis from the same</span>
<span class="sd">    PseudoPositioner)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cyc : Cycler[OphydObj, Sequence]</span>
<span class="sd">       A cycler as would be passed to :func:`scan_nd`</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Cycler[OphydObj, Sequence]</span>
<span class="sd">       A cycler as would be passed to :func:`scan_nd` with the same</span>
<span class="sd">       or fewer keys than the input.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">my_name</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the attribute name of this device on its parent Device&quot;&quot;&quot;</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">parent</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">([</span><span class="n">nm</span> <span class="k">for</span> <span class="n">nm</span> <span class="ow">in</span> <span class="n">parent</span><span class="o">.</span><span class="n">component_names</span> <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">nm</span><span class="p">)</span> <span class="ow">is</span> <span class="n">obj</span><span class="p">]))</span>

    <span class="n">io</span><span class="p">,</span> <span class="n">co</span><span class="p">,</span> <span class="n">gb</span> <span class="o">=</span> <span class="n">merge_axis</span><span class="p">(</span><span class="n">cyc</span><span class="o">.</span><span class="n">keys</span><span class="p">)</span>

    <span class="c1"># only simple non-coupled objects, declare victory and bail!</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">co</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">gb</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">cyc</span>

    <span class="n">input_data</span> <span class="o">=</span> <span class="n">cyc</span><span class="o">.</span><span class="n">by_key</span><span class="p">()</span>
    <span class="n">output_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">cycler</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">input_data</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">io</span> <span class="o">|</span> <span class="n">co</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">parent</span><span class="p">,</span> <span class="n">type_map</span> <span class="ow">in</span> <span class="n">gb</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">parent</span> <span class="ow">in</span> <span class="n">co</span> <span class="ow">and</span> <span class="p">(</span><span class="n">type_map</span><span class="p">[</span><span class="s2">&quot;pseudo&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="n">type_map</span><span class="p">[</span><span class="s2">&quot;real&quot;</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;A PseudoPostiioner and its children were both &quot;</span>
                <span class="s2">&quot;passed in.  We do not yet know how to merge &quot;</span>
                <span class="s2">&quot;these inputs, failing.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">type_map</span><span class="p">[</span><span class="s2">&quot;real&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">type_map</span><span class="p">[</span><span class="s2">&quot;pseudo&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Passed in a mix of real and pseudo axis. Can not cope, failing&quot;</span><span class="p">)</span>
        <span class="n">pseudo_axes</span> <span class="o">=</span> <span class="n">type_map</span><span class="p">[</span><span class="s2">&quot;pseudo&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pseudo_axes</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">p_cyc</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span>
                <span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">,</span>
                <span class="p">(</span><span class="n">cycler</span><span class="p">(</span><span class="n">my_name</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="n">input_data</span><span class="p">[</span><span class="n">c</span><span class="p">])</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">type_map</span><span class="p">[</span><span class="s2">&quot;pseudo&quot;</span><span class="p">]),</span>
            <span class="p">)</span>
            <span class="n">output_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cycler</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">p_cyc</span><span class="p">)))</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">pseudo_axes</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="p">(</span><span class="n">c</span><span class="p">,)</span> <span class="o">=</span> <span class="n">pseudo_axes</span>
            <span class="n">output_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cycler</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">input_data</span><span class="p">[</span><span class="n">c</span><span class="p">]))</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">type_map</span><span class="p">[</span><span class="s2">&quot;real&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">type_map</span><span class="p">[</span><span class="s2">&quot;unrelated&quot;</span><span class="p">]:</span>
            <span class="n">output_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cycler</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">input_data</span><span class="p">[</span><span class="n">c</span><span class="p">]))</span>

    <span class="k">return</span> <span class="n">reduce</span><span class="p">(</span><span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">,</span> <span class="n">output_data</span><span class="p">)</span>


<span class="n">_qapp</span> <span class="o">=</span> <span class="kc">None</span>


<div class="viewcode-block" id="DuringTask">
<a class="viewcode-back" href="../../generated/bluesky.utils.DuringTask.html#bluesky.utils.DuringTask">[docs]</a>
<span class="k">class</span> <span class="nc">DuringTask</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This class waits on the event (which fully blocks the thread).&quot;&quot;&quot;</span>

<div class="viewcode-block" id="DuringTask.__init__">
<a class="viewcode-back" href="../../generated/bluesky.utils.DuringTask.html#bluesky.utils.DuringTask.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span></div>


<div class="viewcode-block" id="DuringTask.block">
<a class="viewcode-back" href="../../generated/bluesky.utils.DuringTask.block.html#bluesky.utils.DuringTask.block">[docs]</a>
    <span class="k">def</span> <span class="nf">block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blocking_event</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Wait plan to finish.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        blocking_event : threading.Event</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">blocking_event</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span></div>
</div>



<div class="viewcode-block" id="DefaultDuringTask">
<a class="viewcode-back" href="../../generated/bluesky.utils.DefaultDuringTask.html#bluesky.utils.DefaultDuringTask">[docs]</a>
<span class="k">class</span> <span class="nc">DefaultDuringTask</span><span class="p">(</span><span class="n">DuringTask</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;This class run the Qt main loop while waiting for the plan to finish.</span>

<span class="sd">    The default setting for the RunEngine&#39;s during_task parameter.</span>

<span class="sd">    This makes it possible for plots that use Matplotlib&#39;s Qt backend to update</span>
<span class="sd">    live during data acquisition.</span>

<span class="sd">    It solves the problem that Qt must be run from the main thread.</span>
<span class="sd">    If Matplotlib and a known Qt binding are already imported, run</span>
<span class="sd">    Matplotlib qApp until the task completes. If not, there is no need to</span>
<span class="sd">    handle qApp: just wait on the task.</span>

<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="DefaultDuringTask.__init__">
<a class="viewcode-back" href="../../generated/bluesky.utils.DefaultDuringTask.html#bluesky.utils.DefaultDuringTask.__init__">[docs]</a>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initialize backend.</span>

<span class="sd">        Currently only the Qt backend is supported. The function is</span>
<span class="sd">        initializing the &#39;teleporter&#39; if Qt backend is used.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="s2">&quot;matplotlib&quot;</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">matplotlib</span>

            <span class="n">backend</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">get_backend</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">if</span> <span class="s2">&quot;qt&quot;</span> <span class="ow">in</span> <span class="n">backend</span><span class="p">:</span>
                <span class="kn">from</span> <span class="nn">bluesky.callbacks.mpl_plotting</span> <span class="kn">import</span> <span class="n">initialize_qt_teleporter</span>

                <span class="n">initialize_qt_teleporter</span><span class="p">()</span></div>


    <span class="k">def</span> <span class="nf">block</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">blocking_event</span><span class="p">):</span>
        <span class="c1"># docstring inherited</span>
        <span class="k">global</span> <span class="n">_qapp</span>
        <span class="k">if</span> <span class="s2">&quot;matplotlib&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
            <span class="c1"># We are not using matplotlib + Qt. Just wait on the Event.</span>
            <span class="n">blocking_event</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="c1"># Figure out if we are using matplotlib with which backend</span>
        <span class="c1"># without importing anything that is not already imported.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">matplotlib</span>

            <span class="n">backend</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">get_backend</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="c1"># if with a Qt backend, do the scary thing</span>
            <span class="k">if</span> <span class="s2">&quot;qt&quot;</span> <span class="ow">in</span> <span class="n">backend</span><span class="p">:</span>
                <span class="kn">import</span> <span class="nn">functools</span>

                <span class="kn">from</span> <span class="nn">matplotlib.backends.qt_compat</span> <span class="kn">import</span> <span class="n">QT_API</span><span class="p">,</span> <span class="n">QtCore</span><span class="p">,</span> <span class="n">QtWidgets</span>

                <span class="nd">@functools</span><span class="o">.</span><span class="n">lru_cache</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                <span class="k">def</span> <span class="nf">_enum</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">                    Between PyQt5 and PyQt6 how the various enums were accessed changed from</span>
<span class="sd">                    all of the various names being in the module namespace to being nested under</span>
<span class="sd">                    the Enum name.  Thus in PyQt5 we access the QSocketNotifier Type enum values as ::</span>

<span class="sd">                        QtCore.QSocketNotifier.Read</span>

<span class="sd">                    but in PyQt6 we use::</span>

<span class="sd">                         QtCore.QSocketNotifier.Type.Read</span>

<span class="sd">                    rather than have this checking inline where we use it, this function lets us do::</span>

<span class="sd">                        _enum(&#39;QtCore.QSocketNotifier.Type&#39;).Read</span>

<span class="sd">                    and well get the right namespace to get the Enum member from.</span>

<span class="sd">                    We use the extra layer of indirection of `operator.attrgetter` so that</span>
<span class="sd">                    multi-level names work and we can rely on the Qt compat layer to get the</span>
<span class="sd">                    correct PyQt5 vs PyQt6</span>

<span class="sd">                    This is copied from Matplotlib.</span>
<span class="sd">                    &quot;&quot;&quot;</span>
                    <span class="c1"># foo.bar.Enum.Entry (PyQt6) &lt;=&gt; foo.bar.Entry (non-PyQt6).</span>
                    <span class="k">return</span> <span class="n">operator</span><span class="o">.</span><span class="n">attrgetter</span><span class="p">(</span><span class="n">name</span> <span class="k">if</span> <span class="n">QT_API</span> <span class="o">==</span> <span class="s2">&quot;PyQt6&quot;</span> <span class="k">else</span> <span class="n">name</span><span class="o">.</span><span class="n">rpartition</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])(</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">QtCore</span><span class="o">.</span><span class="n">__package__</span><span class="p">]</span>
                    <span class="p">)</span>

                <span class="n">app</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QApplication</span><span class="o">.</span><span class="n">instance</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">app</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">_qapp</span> <span class="o">=</span> <span class="n">app</span> <span class="o">=</span> <span class="n">QtWidgets</span><span class="o">.</span><span class="n">QApplication</span><span class="p">([</span><span class="sa">b</span><span class="s2">&quot;bluesky&quot;</span><span class="p">])</span>
                <span class="k">assert</span> <span class="n">app</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                <span class="n">event_loop</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QEventLoop</span><span class="p">()</span>

                <span class="k">def</span> <span class="nf">start_killer_thread</span><span class="p">():</span>
                    <span class="k">def</span> <span class="nf">exit_loop</span><span class="p">():</span>
                        <span class="n">blocking_event</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                        <span class="c1"># If the above wait ends quickly, we need to avoid the race</span>
                        <span class="c1"># condition where this thread might try to exit the qApp</span>
                        <span class="c1"># before it even starts.  Therefore, we use QTimer, below,</span>
                        <span class="c1"># which will not start running until the qApp event loop is</span>
                        <span class="c1"># running.</span>
                        <span class="n">event_loop</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

                    <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">exit_loop</span><span class="p">)</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

                <span class="c1"># https://www.riverbankcomputing.com/pipermail/pyqt/2015-March/035674.html</span>
                <span class="c1"># adapted from code at</span>
                <span class="c1"># https://bitbucket.org/tortoisehg/thg/commits/550e1df5fbad</span>
                <span class="k">if</span> <span class="p">(</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;posix&quot;</span>
                    <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="s2">&quot;set_wakeup_fd&quot;</span><span class="p">)</span>
                    <span class="ow">and</span>
                    <span class="c1"># TODO also check if main interpreter</span>
                    <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span> <span class="ow">is</span> <span class="n">threading</span><span class="o">.</span><span class="n">main_thread</span><span class="p">()</span>
                <span class="p">):</span>
                    <span class="c1"># Wake up Python interpreter via pipe so that SIGINT</span>
                    <span class="c1"># can be handled immediately.</span>
                    <span class="c1"># (http://qt-project.org/doc/qt-4.8/unix-signals.html)</span>
                    <span class="c1"># Updated docs:</span>
                    <span class="c1"># https://doc.qt.io/qt-5/unix-signals.html</span>
                    <span class="kn">import</span> <span class="nn">fcntl</span>

                    <span class="n">rfd</span><span class="p">,</span> <span class="n">wfd</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">pipe</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">fd</span> <span class="ow">in</span> <span class="p">(</span><span class="n">rfd</span><span class="p">,</span> <span class="n">wfd</span><span class="p">):</span>
                        <span class="n">flags</span> <span class="o">=</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">F_GETFL</span><span class="p">)</span>
                        <span class="n">fcntl</span><span class="o">.</span><span class="n">fcntl</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">F_SETFL</span><span class="p">,</span> <span class="n">flags</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_NONBLOCK</span><span class="p">)</span>
                    <span class="n">wakeupsn</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QSocketNotifier</span><span class="p">(</span><span class="n">rfd</span><span class="p">,</span> <span class="n">_enum</span><span class="p">(</span><span class="s2">&quot;QtCore.QSocketNotifier.Type&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">Read</span><span class="p">)</span>
                    <span class="n">origwakeupfd</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">set_wakeup_fd</span><span class="p">(</span><span class="n">wfd</span><span class="p">)</span>

                    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">():</span>
                        <span class="n">wakeupsn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">rfd</span> <span class="o">=</span> <span class="n">wakeupsn</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
                        <span class="n">wfd</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">set_wakeup_fd</span><span class="p">(</span><span class="n">origwakeupfd</span><span class="p">)</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">rfd</span><span class="p">))</span>
                        <span class="n">os</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">wfd</span><span class="p">)</span>

                    <span class="k">def</span> <span class="nf">handleWakeup</span><span class="p">(</span><span class="n">inp</span><span class="p">):</span>
                        <span class="c1"># here Python signal handler will be invoked</span>
                        <span class="c1"># this book-keeping is to drain the pipe</span>
                        <span class="n">wakeupsn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">rfd</span> <span class="o">=</span> <span class="n">wakeupsn</span><span class="o">.</span><span class="n">socket</span><span class="p">()</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">rfd</span><span class="p">),</span> <span class="mi">4096</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">OSError</span> <span class="k">as</span> <span class="n">inst</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;failed to read wakeup fd: </span><span class="si">{</span><span class="n">inst</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

                        <span class="n">wakeupsn</span><span class="o">.</span><span class="n">setEnabled</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>

                    <span class="n">wakeupsn</span><span class="o">.</span><span class="n">activated</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">handleWakeup</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># On Windows, non-blocking anonymous pipe or socket is</span>
                    <span class="c1"># not available.</span>

                    <span class="k">def</span> <span class="nf">null</span><span class="p">():</span> <span class="o">...</span>

                    <span class="c1"># we need to &#39;kick&#39; the python interpreter so it sees</span>
                    <span class="c1"># system signals</span>
                    <span class="c1"># https://stackoverflow.com/a/4939113/380231</span>
                    <span class="n">kick_timer</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QTimer</span><span class="p">()</span>
                    <span class="n">kick_timer</span><span class="o">.</span><span class="n">timeout</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">null</span><span class="p">)</span>
                    <span class="n">kick_timer</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>

                    <span class="n">cleanup</span> <span class="o">=</span> <span class="n">kick_timer</span><span class="o">.</span><span class="n">stop</span>

                <span class="c1"># we also need to make sure that the qApp never sees</span>
                <span class="c1"># exceptions raised by python inside of a c++ callback (as</span>
                <span class="c1"># it will segfault itself because due to the way the</span>
                <span class="c1"># code is called there is no clear way to propagate that</span>
                <span class="c1"># back to the python code.</span>
                <span class="n">vals</span> <span class="o">=</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                <span class="n">old_sys_handler</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">excepthook</span>

                <span class="k">def</span> <span class="nf">my_exception_hook</span><span class="p">(</span><span class="n">exctype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
                    <span class="k">nonlocal</span> <span class="n">vals</span>
                    <span class="n">vals</span> <span class="o">=</span> <span class="p">(</span><span class="n">exctype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">)</span>
                    <span class="n">event_loop</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
                    <span class="n">old_sys_handler</span><span class="p">(</span><span class="n">exctype</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">)</span>

                <span class="c1"># this kill the Qt event loop when the plan is finished</span>
                <span class="n">killer_timer</span> <span class="o">=</span> <span class="n">QtCore</span><span class="o">.</span><span class="n">QTimer</span><span class="p">()</span>
                <span class="n">killer_timer</span><span class="o">.</span><span class="n">setSingleShot</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">killer_timer</span><span class="o">.</span><span class="n">timeout</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">start_killer_thread</span><span class="p">)</span>
                <span class="n">killer_timer</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">excepthook</span> <span class="o">=</span> <span class="n">my_exception_hook</span>
                    <span class="p">(</span><span class="n">event_loop</span><span class="o">.</span><span class="n">exec</span><span class="p">()</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">event_loop</span><span class="p">,</span> <span class="s2">&quot;exec&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">event_loop</span><span class="o">.</span><span class="n">exec_</span><span class="p">())</span>
                    <span class="c1"># make sure any pending signals are processed</span>
                    <span class="n">event_loop</span><span class="o">.</span><span class="n">processEvents</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">cleanup</span><span class="p">()</span>
                    <span class="k">finally</span><span class="p">:</span>
                        <span class="n">sys</span><span class="o">.</span><span class="n">excepthook</span> <span class="o">=</span> <span class="n">old_sys_handler</span>
            <span class="k">elif</span> <span class="s2">&quot;ipympl&quot;</span> <span class="ow">in</span> <span class="n">backend</span> <span class="ow">or</span> <span class="s2">&quot;nbagg&quot;</span> <span class="ow">in</span> <span class="n">backend</span><span class="p">:</span>
                <span class="n">Gcf</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">_pylab_helpers</span><span class="o">.</span><span class="n">Gcf</span>
                <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                    <span class="n">done</span> <span class="o">=</span> <span class="n">blocking_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mf">0.1</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">f_mgr</span> <span class="ow">in</span> <span class="n">Gcf</span><span class="o">.</span><span class="n">get_all_fig_managers</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">f_mgr</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">figure</span><span class="o">.</span><span class="n">stale</span><span class="p">:</span>
                            <span class="n">f_mgr</span><span class="o">.</span><span class="n">canvas</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
                        <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># We are not using matplotlib + Qt. Just wait on the Event.</span>
                <span class="n">blocking_event</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span></div>



<span class="k">def</span> <span class="nf">_rearrange_into_parallel_dicts</span><span class="p">(</span><span class="n">readings</span><span class="p">):</span>
    <span class="n">data</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">timestamps</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">payload</span> <span class="ow">in</span> <span class="n">readings</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>
        <span class="n">timestamps</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">payload</span><span class="p">[</span><span class="s2">&quot;timestamp&quot;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">data</span><span class="p">,</span> <span class="n">timestamps</span>


<span class="k">def</span> <span class="nf">is_movable</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Check if object satisfies bluesky &#39;Movable&#39; and `Readable` interfaces.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    obj : Object</span>
<span class="sd">        Object to test.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    boolean</span>
<span class="sd">        True if movable, False otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Movable</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Readable</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_hinted_fields</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">HasHints</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">obj</span><span class="o">.</span><span class="n">hints</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fields&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>


<span class="n">already_warned</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>


<span class="k">def</span> <span class="nf">warn_if_msg_args_or_kwargs</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">meth</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">args</span> <span class="ow">or</span> <span class="n">kwargs</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">already_warned</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">command</span><span class="p">):</span>
        <span class="n">already_warned</span><span class="p">[</span><span class="n">msg</span><span class="o">.</span><span class="n">command</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">error_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span><span class="se">\</span>
<span class="s2">About to call </span><span class="si">{</span><span class="n">meth</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">() with args </span><span class="si">{</span><span class="n">args</span><span class="si">}</span><span class="s2"> and kwargs </span><span class="si">{</span><span class="n">kwargs</span><span class="si">}</span><span class="s2">.</span>
<span class="s2">In the future the passing of Msg.args and Msg.kwargs down to hardware from</span>
<span class="s2">Msg(&quot;</span><span class="si">{</span><span class="n">msg</span><span class="o">.</span><span class="n">command</span><span class="si">}</span><span class="s2">&quot;) may be deprecated. If you have a use case for these,</span>
<span class="s2">we would like to know about it, so please open an issue at</span>
<span class="s2">https://github.com/bluesky/bluesky/issues&quot;&quot;&quot;</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>  <span class="c1"># noqa: B028</span>


<span class="k">def</span> <span class="nf">maybe_update_hints</span><span class="p">(</span><span class="n">hints</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Hints</span><span class="p">],</span> <span class="n">obj</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">HasHints</span><span class="p">):</span>
        <span class="n">hints</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">hints</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">iterate_maybe_async</span><span class="p">(</span><span class="n">iterator</span><span class="p">:</span> <span class="n">SyncOrAsyncIterator</span><span class="p">[</span><span class="n">T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">AsyncIterator</span><span class="p">[</span><span class="n">T</span><span class="p">]:</span>
    <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isasyncgen</span><span class="p">(</span><span class="n">iterator</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">v</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">iterator</span><span class="p">:</span>  <span class="c1"># type: ignore</span>
            <span class="k">yield</span> <span class="n">v</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">maybe_collect_asset_docs</span><span class="p">(</span>
    <span class="n">msg</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">index</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AsyncIterable</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">Asset</span><span class="p">,</span> <span class="n">StreamAsset</span><span class="p">]]:</span>
    <span class="c1"># The if/elif statement must be done in this order because isinstance for protocol</span>
    <span class="c1"># doesn&#39;t check for exclusive signatures, and WritesExternalAssets will also</span>
    <span class="c1"># return true for a WritesStreamAsset as they both contain collect_asset_docs</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">WritesStreamAssets</span><span class="p">):</span>
        <span class="n">warn_if_msg_args_or_kwargs</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">collect_asset_docs</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">stream_doc</span> <span class="ow">in</span> <span class="n">iterate_maybe_async</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">collect_asset_docs</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)):</span>
            <span class="k">yield</span> <span class="n">stream_doc</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">WritesExternalAssets</span><span class="p">):</span>
        <span class="n">warn_if_msg_args_or_kwargs</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">collect_asset_docs</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">doc</span> <span class="ow">in</span> <span class="n">iterate_maybe_async</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">collect_asset_docs</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)):</span>
            <span class="k">yield</span> <span class="n">doc</span>


<span class="k">async</span> <span class="k">def</span> <span class="nf">maybe_await</span><span class="p">(</span><span class="n">ret</span><span class="p">:</span> <span class="n">SyncOrAsync</span><span class="p">[</span><span class="n">T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isawaitable</span><span class="p">(</span><span class="n">ret</span><span class="p">):</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">ret</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Mypy does not understand how to narrow type to non-awaitable in this</span>
        <span class="c1"># instance, see https://github.com/python/mypy/issues/15520</span>
        <span class="k">return</span> <span class="n">ret</span>  <span class="c1"># type: ignore</span>


<span class="k">class</span> <span class="nc">Plan</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_iter</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stack</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_stack</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stack</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stack</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stack</span> <span class="o">+=</span> <span class="p">[</span>
            <span class="sa">f</span><span class="s2">&quot;RuntimeWarning: plan `</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">` was never iterated&quot;</span> <span class="s2">&quot;, did you mean to use `yield from`?&quot;</span>
        <span class="p">]</span>

    <span class="k">def</span> <span class="fm">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stack</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="p">(</span><span class="k">yield from</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_iter</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stack</span><span class="p">:</span>
            <span class="n">warning_message</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stack</span><span class="p">)</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">warning_message</span><span class="p">,</span> <span class="ne">RuntimeWarning</span><span class="p">,</span> <span class="n">stacklevel</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">send</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">throw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">val</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tb</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_iter</span><span class="o">.</span><span class="n">throw</span><span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">tb</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">plan</span><span class="p">(</span><span class="n">plan</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator that warns user if a `yield from` is not called</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    plan : Generator</span>
<span class="sd">        Generator coroutine usually a Bluesky plan</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Plan</span>
<span class="sd">        Wrapped plans</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@wraps</span><span class="p">(</span><span class="n">plan</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Plan</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Plan</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">wrapper</span>
</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=3ee479438cf8b5e0d341"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=3ee479438cf8b5e0d341"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2015, Brookhaven National Lab.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.3.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>