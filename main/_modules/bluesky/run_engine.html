
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>bluesky.run_engine &#8212; bluesky 1.14.6.dev9+g7d4e0748d documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
  
  <!-- So that users can add custom icons -->
  <script src="../../_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="../../_static/documentation_options.js?v=3bb88580"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs"></script>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs"></script>
    <script type="module">import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";import elkLayouts from "https://cdn.jsdelivr.net/npm/@mermaid-js/layout-elk@0.1.4/dist/mermaid-layout-elk.esm.min.mjs";mermaid.registerLayoutLoaders(elkLayouts);mermaid.initialize({startOnLoad:false});</script>
    <script src="https://cdn.jsdelivr.net/npm/d3@7.9.0/dist/d3.min.js"></script>
    <script type="module">
import mermaid from "https://cdn.jsdelivr.net/npm/mermaid@11.2.0/dist/mermaid.esm.min.mjs";
window.addEventListener("load", () => mermaid.run());
</script>
    <script>DOCUMENTATION_OPTIONS.pagename = '_modules/bluesky/run_engine';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.16.1';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://blueskyproject.io/bluesky/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = '1.14.6.dev9+g7d4e0748d';
        DOCUMENTATION_OPTIONS.show_version_warning_banner =
            false;
        </script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="1.14.6.dev9+g7d4e0748d" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/bluesky-logo-dark.svg" class="logo__image only-light" alt=""/>
    <img src="../../_static/bluesky-logo-dark.svg" class="logo__image only-dark pst-js-only" alt=""/>
  
  
    <p class="title logo__title">bluesky</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../userindex.html">
    User Documentation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../devindex.html">
    Developer Documentation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://blueskyproject.io/bluesky">
    bluesky
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://blueskyproject.io/ophyd">
    ophyd
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://blueskyproject.io/databroker">
    databroker
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button"
                data-bs-toggle="dropdown" aria-expanded="false"
                aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://nsls-ii.github.io/amostra">
    amostra
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://nsls-ii.github.io/datamuxer">
    datamuxer
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://blueskyproject.io/suitcase">
    suitcase
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://github.com/NSLS-II/">
    NSLS-II Repositories
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://github.com/NSLS-II/Bug-Reports/issues">
    Bug Reports
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/bluesky/bluesky" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/bluesky" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fas fa-cube fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
      
        <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-2"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-2"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-2"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-2">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../userindex.html">
    User Documentation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="../../devindex.html">
    Developer Documentation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://blueskyproject.io/bluesky">
    bluesky
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://blueskyproject.io/ophyd">
    ophyd
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://blueskyproject.io/databroker">
    databroker
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://nsls-ii.github.io/amostra">
    amostra
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://nsls-ii.github.io/datamuxer">
    datamuxer
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://blueskyproject.io/suitcase">
    suitcase
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://github.com/NSLS-II/">
    NSLS-II Repositories
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://github.com/NSLS-II/Bug-Reports/issues">
    Bug Reports
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/bluesky/bluesky" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/bluesky" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fas fa-cube fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
        
          <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-3"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-3"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-3"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-3">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../index.html" class="nav-link">Module code</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">bluesky.run_engine</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <h1>Source code for bluesky.run_engine</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span><span class="w"> </span><span class="nn">asyncio</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">concurrent</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">copy</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">functools</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">inspect</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">json</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">typing</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">weakref</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChainMap</span><span class="p">,</span> <span class="n">defaultdict</span><span class="p">,</span> <span class="n">deque</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">contextlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExitStack</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">dataclasses</span><span class="w"> </span><span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">enum</span><span class="w"> </span><span class="kn">import</span> <span class="n">Enum</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">inspect</span><span class="w"> </span><span class="kn">import</span> <span class="n">iscoroutine</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">itertools</span><span class="w"> </span><span class="kn">import</span> <span class="n">count</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">warnings</span><span class="w"> </span><span class="kn">import</span> <span class="n">warn</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">event_model</span><span class="w"> </span><span class="kn">import</span> <span class="n">DocumentNames</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry</span><span class="w"> </span><span class="kn">import</span> <span class="n">trace</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">opentelemetry.trace</span><span class="w"> </span><span class="kn">import</span> <span class="n">Span</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">bluesky._vendor.super_state_machine.errors</span><span class="w"> </span><span class="kn">import</span> <span class="n">TransitionError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bluesky._vendor.super_state_machine.extras</span><span class="w"> </span><span class="kn">import</span> <span class="n">PropertyMachine</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bluesky._vendor.super_state_machine.machines</span><span class="w"> </span><span class="kn">import</span> <span class="n">StateMachine</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">.bundlers</span><span class="w"> </span><span class="kn">import</span> <span class="n">RunBundler</span><span class="p">,</span> <span class="n">maybe_await</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.log</span><span class="w"> </span><span class="kn">import</span> <span class="n">ComposableLogAdapter</span><span class="p">,</span> <span class="n">logger</span><span class="p">,</span> <span class="n">msg_logger</span><span class="p">,</span> <span class="n">state_logger</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.protocols</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Flyable</span><span class="p">,</span>
    <span class="n">Locatable</span><span class="p">,</span>
    <span class="n">Movable</span><span class="p">,</span>
    <span class="n">Pausable</span><span class="p">,</span>
    <span class="n">Preparable</span><span class="p">,</span>
    <span class="n">Readable</span><span class="p">,</span>
    <span class="n">Stageable</span><span class="p">,</span>
    <span class="n">Status</span><span class="p">,</span>
    <span class="n">Stoppable</span><span class="p">,</span>
    <span class="n">SyncOrAsync</span><span class="p">,</span>
    <span class="n">T</span><span class="p">,</span>
    <span class="n">Triggerable</span><span class="p">,</span>
    <span class="n">check_supports</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.tracing</span><span class="w"> </span><span class="kn">import</span> <span class="n">tracer</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">.utils</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">AsyncInput</span><span class="p">,</span>
    <span class="n">CallbackRegistry</span><span class="p">,</span>
    <span class="n">DefaultDuringTask</span><span class="p">,</span>
    <span class="n">DuringTask</span><span class="p">,</span>
    <span class="n">FailedPause</span><span class="p">,</span>
    <span class="n">FailedStatus</span><span class="p">,</span>
    <span class="n">IllegalMessageSequence</span><span class="p">,</span>
    <span class="n">InvalidCommand</span><span class="p">,</span>
    <span class="n">Msg</span><span class="p">,</span>
    <span class="n">NoReplayAllowed</span><span class="p">,</span>
    <span class="n">PlanHalt</span><span class="p">,</span>
    <span class="n">RequestAbort</span><span class="p">,</span>
    <span class="n">RequestStop</span><span class="p">,</span>
    <span class="n">RunEngineInterrupted</span><span class="p">,</span>
    <span class="n">SigintHandler</span><span class="p">,</span>
    <span class="n">Subscribers</span><span class="p">,</span>
    <span class="n">ensure_generator</span><span class="p">,</span>
    <span class="n">normalize_subs_input</span><span class="p">,</span>
    <span class="n">single_gen</span><span class="p">,</span>
    <span class="n">warn_if_msg_args_or_kwargs</span><span class="p">,</span>
<span class="p">)</span>

<span class="n">_SPAN_NAME_PREFIX</span> <span class="o">=</span> <span class="s2">&quot;Bluesky RunEngine&quot;</span>

<span class="n">current_task</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Callable</span><span class="p">[[</span><span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">AbstractEventLoop</span><span class="p">]],</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span><span class="p">]]</span>
<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">asyncio</span><span class="w"> </span><span class="kn">import</span> <span class="n">current_task</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="c1"># handle py &lt; 3,7</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">asyncio.tasks</span><span class="w"> </span><span class="kn">import</span> <span class="n">Task</span>

    <span class="n">current_task</span> <span class="o">=</span> <span class="n">Task</span><span class="o">.</span><span class="n">current_task</span>  <span class="c1"># type: ignore</span>
    <span class="k">del</span> <span class="n">Task</span>


<span class="k">class</span><span class="w"> </span><span class="nc">_RunEnginePanic</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span> <span class="o">...</span>


<span class="k">class</span><span class="w"> </span><span class="nc">WaitForTimeoutError</span><span class="p">(</span><span class="ne">TimeoutError</span><span class="p">):</span> <span class="o">...</span>


<div class="viewcode-block" id="RunEngineResult">
<a class="viewcode-back" href="../../generated/bluesky.run_engine.RunEngineResult.html#bluesky.run_engine.RunEngineResult">[docs]</a>
<span class="nd">@dataclass</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RunEngineResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Information about the plan that was run</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    run_start_uids : list</span>
<span class="sd">        A list of the UIDs generated during the plan (if any)</span>
<span class="sd">    plan_result :</span>
<span class="sd">        The return value of the top-level plan that was run</span>
<span class="sd">    exit_status : str</span>
<span class="sd">    interrupted : bool</span>
<span class="sd">        True if the plan was halted, stopped or aborted</span>
<span class="sd">    reason : str</span>
<span class="sd">        A text description of the reason why the plan was aborted (if aborted)</span>
<span class="sd">    exception :</span>
<span class="sd">        The exception generated by the plan, if any</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">run_start_uids</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span>
    <span class="n">plan_result</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span>
    <span class="n">exit_status</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">interrupted</span><span class="p">:</span> <span class="nb">bool</span>
    <span class="n">reason</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">exception</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="ne">Exception</span><span class="p">]</span></div>



<span class="k">class</span><span class="w"> </span><span class="nc">RunEngineStateMachine</span><span class="p">(</span><span class="n">StateMachine</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    is_idle</span>
<span class="sd">        State machine is in its idle state</span>
<span class="sd">    is_running</span>
<span class="sd">        State machine is in its running state</span>
<span class="sd">    is_paused</span>
<span class="sd">        State machine is paused.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">States</span><span class="p">(</span><span class="n">Enum</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;state.name = state.value&quot;&quot;&quot;</span>

        <span class="n">IDLE</span> <span class="o">=</span> <span class="s2">&quot;idle&quot;</span>

        <span class="n">RUNNING</span> <span class="o">=</span> <span class="s2">&quot;running&quot;</span>

        <span class="n">PAUSING</span> <span class="o">=</span> <span class="s2">&quot;pausing&quot;</span>
        <span class="n">PAUSED</span> <span class="o">=</span> <span class="s2">&quot;paused&quot;</span>

        <span class="n">HALTING</span> <span class="o">=</span> <span class="s2">&quot;halting&quot;</span>
        <span class="n">STOPPING</span> <span class="o">=</span> <span class="s2">&quot;stopping&quot;</span>
        <span class="n">ABORTING</span> <span class="o">=</span> <span class="s2">&quot;aborting&quot;</span>

        <span class="n">SUSPENDING</span> <span class="o">=</span> <span class="s2">&quot;suspending&quot;</span>

        <span class="n">PANICKED</span> <span class="o">=</span> <span class="s2">&quot;panicked&quot;</span>

        <span class="nd">@classmethod</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">states</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">state</span><span class="o">.</span><span class="n">value</span> <span class="k">for</span> <span class="n">state</span> <span class="ow">in</span> <span class="bp">cls</span><span class="p">]</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">allow_empty</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">initial_state</span> <span class="o">=</span> <span class="s2">&quot;idle&quot;</span>
        <span class="n">transitions</span> <span class="o">=</span> <span class="p">{</span>
            <span class="c1"># Notice that &#39;transitions&#39; and &#39;named_transitions&#39; have</span>
            <span class="c1"># opposite to &lt;--&gt; from structure.</span>
            <span class="c1"># from_state : [valid_to_states]</span>
            <span class="s2">&quot;idle&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;running&quot;</span><span class="p">,</span> <span class="s2">&quot;panicked&quot;</span><span class="p">],</span>
            <span class="s2">&quot;running&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;idle&quot;</span><span class="p">,</span> <span class="s2">&quot;pausing&quot;</span><span class="p">,</span> <span class="s2">&quot;halting&quot;</span><span class="p">,</span> <span class="s2">&quot;stopping&quot;</span><span class="p">,</span> <span class="s2">&quot;aborting&quot;</span><span class="p">,</span> <span class="s2">&quot;suspending&quot;</span><span class="p">,</span> <span class="s2">&quot;panicked&quot;</span><span class="p">],</span>
            <span class="s2">&quot;pausing&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;paused&quot;</span><span class="p">,</span> <span class="s2">&quot;idle&quot;</span><span class="p">,</span> <span class="s2">&quot;halting&quot;</span><span class="p">,</span> <span class="s2">&quot;aborting&quot;</span><span class="p">,</span> <span class="s2">&quot;panicked&quot;</span><span class="p">],</span>
            <span class="s2">&quot;suspending&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;running&quot;</span><span class="p">,</span> <span class="s2">&quot;halting&quot;</span><span class="p">,</span> <span class="s2">&quot;aborting&quot;</span><span class="p">,</span> <span class="s2">&quot;panicked&quot;</span><span class="p">],</span>
            <span class="s2">&quot;paused&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;idle&quot;</span><span class="p">,</span> <span class="s2">&quot;running&quot;</span><span class="p">,</span> <span class="s2">&quot;halting&quot;</span><span class="p">,</span> <span class="s2">&quot;stopping&quot;</span><span class="p">,</span> <span class="s2">&quot;aborting&quot;</span><span class="p">,</span> <span class="s2">&quot;panicked&quot;</span><span class="p">],</span>
            <span class="s2">&quot;halting&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;idle&quot;</span><span class="p">,</span> <span class="s2">&quot;panicked&quot;</span><span class="p">],</span>
            <span class="s2">&quot;stopping&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;idle&quot;</span><span class="p">,</span> <span class="s2">&quot;panicked&quot;</span><span class="p">],</span>
            <span class="s2">&quot;aborting&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;idle&quot;</span><span class="p">,</span> <span class="s2">&quot;panicked&quot;</span><span class="p">],</span>
            <span class="s2">&quot;panicked&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>
        <span class="n">named_checkers</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;can_pause&quot;</span><span class="p">,</span> <span class="s2">&quot;pausing&quot;</span><span class="p">),</span>
        <span class="p">]</span>


<span class="k">class</span><span class="w"> </span><span class="nc">LoggingPropertyMachine</span><span class="p">(</span><span class="n">PropertyMachine</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;expects object to have a `log` attribute</span>
<span class="sd">    and a `state_hook` attribute that is ``None`` or a callable with signature</span>
<span class="sd">    ``f(value, old_value)``&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">machine_type</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">machine_type</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="n">own</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">old_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">own</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">obj</span><span class="o">.</span><span class="n">_state_lock</span><span class="p">:</span>
            <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__set__</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">own</span><span class="p">)</span>
        <span class="n">tags</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;old_state&quot;</span><span class="p">:</span> <span class="n">old_value</span><span class="p">,</span> <span class="s2">&quot;new_state&quot;</span><span class="p">:</span> <span class="n">value</span><span class="p">,</span> <span class="s2">&quot;RE&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="p">}</span>

        <span class="n">state_logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Change state on </span><span class="si">%r</span><span class="s2"> from </span><span class="si">%r</span><span class="s2"> -&gt; </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">old_value</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="n">tags</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">state_hook</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">state_hook</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">old_value</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">,</span> <span class="n">owner</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">instance</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">owner</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">instance</span><span class="o">.</span><span class="n">_state_lock</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="n">owner</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">default_scan_id_source</span><span class="p">(</span><span class="n">md</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">md</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scan_id&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_state_locked</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">inner</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_lock</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">inner</span>


<div class="viewcode-block" id="RunEngine">
<a class="viewcode-back" href="../../generated/bluesky.run_engine.RunEngine.html#bluesky.run_engine.RunEngine">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">RunEngine</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;The Run Engine execute messages and emits Documents.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    md : dict-like, optional</span>
<span class="sd">        The default is a standard Python dictionary, but fancier</span>
<span class="sd">        objects can be used to store long-term history and persist</span>
<span class="sd">        it between sessions. The standard configuration</span>
<span class="sd">        instantiates a Run Engine with historydict.HistoryDict, a</span>
<span class="sd">        simple interface to a sqlite file. Any object supporting</span>
<span class="sd">        `__getitem__`, `__setitem__`, and `clear` will work.</span>

<span class="sd">    loop : asyncio event loop</span>
<span class="sd">        e.g., ``asyncio.get_event_loop()`` or ``asyncio.new_event_loop()``</span>

<span class="sd">    preprocessors : list, optional</span>
<span class="sd">        Generator functions that take in a plan (generator instance) and</span>
<span class="sd">        modify its messages on the way out. Suitable examples include</span>
<span class="sd">        the functions in the module ``bluesky.plans`` with names ending in</span>
<span class="sd">        &#39;wrapper&#39;.  Functions are composed in order: the preprocessors</span>
<span class="sd">        ``[f, g]`` are applied like ``f(g(plan))``.</span>

<span class="sd">    context_managers : list, optional</span>
<span class="sd">        Context managers that will be entered when we run a plan. The context</span>
<span class="sd">        managers will be composed in order, much like the preprocessors. If</span>
<span class="sd">        this argument is omitted, we will use a user-oriented handler for</span>
<span class="sd">        SIGINT. The elements of this list will be passed this ``RunEngine``</span>
<span class="sd">        instance as their only argument. You may pass an empty list if you</span>
<span class="sd">        would like a ``RunEngine`` with no signal handling and no context</span>
<span class="sd">        managers.</span>

<span class="sd">    md_validator : callable, optional</span>
<span class="sd">        a function that raises and prevents starting a run if it deems</span>
<span class="sd">        the metadata to be invalid or incomplete</span>
<span class="sd">        Expected signature: f(md)</span>
<span class="sd">        Function should raise if md is invalid. What that means is</span>
<span class="sd">        completely up to the user. The function&#39;s return value is</span>
<span class="sd">        ignored.</span>

<span class="sd">    md_normalizer : callable, optional</span>
<span class="sd">        a function that, similar to md_validator, raises and prevents starting</span>
<span class="sd">        a run if it deems the metadata to be invalid or incomplete.</span>
<span class="sd">        If it succeeds, it returns the normalized/transformed version of</span>
<span class="sd">        the original metadata.</span>
<span class="sd">        Expected signature: f(md)</span>
<span class="sd">        Function should raise if md is invalid. What that means is</span>
<span class="sd">        completely up to the user.</span>
<span class="sd">        Expected return: normalized metadata</span>

<span class="sd">    scan_id_source : callable, optional</span>
<span class="sd">        a (possibly async) function that will be used to calculate scan_id.</span>
<span class="sd">        Default is to increment scan_id by 1 each time. However you could pass</span>
<span class="sd">        in a customized function to get a scan_id from any source.</span>
<span class="sd">        Expected signature: f(md)</span>
<span class="sd">        Expected return: updated scan_id value</span>

<span class="sd">    during_task : reference to an object of class DuringTask, optional</span>
<span class="sd">        Class methods: ``block()`` to be run to block</span>
<span class="sd">        the main thread during `RE.__call__`</span>

<span class="sd">        The required signatures for the class methods ::</span>

<span class="sd">              def block(ev: Threading.Event) -&gt; None:</span>
<span class="sd">                  &quot;Returns when ev is set&quot;</span>

<span class="sd">        The default value handles the cases of:</span>
<span class="sd">           - Matplotlib is not imported (just wait on the event)</span>
<span class="sd">           - Matplotlib is imported, but not using a Qt, notebook or ipympl</span>
<span class="sd">             backend (just wait on the event)</span>
<span class="sd">           - Matplotlib is imported and using a Qt backend (run the Qt app</span>
<span class="sd">             on the main thread until the run finishes)</span>
<span class="sd">           - Matplotlib is imported and using a nbagg or ipympl backend (</span>
<span class="sd">             wait on the event and poll to push updates to the browser)</span>

<span class="sd">    call_returns_result : bool, default False</span>
<span class="sd">        A flag that controls the return value of __call__</span>
<span class="sd">        If ``True``, the ``RunEngine`` will return a :class:``RunEngineResult``</span>
<span class="sd">        object that contains information about the plan that was run.</span>
<span class="sd">        If ``False``, the ``RunEngine`` will return a tuple of uids.</span>
<span class="sd">        Defaults to ``False`` to preserve the old ``RunEngine`` behavior,</span>
<span class="sd">        but the default is expected to change to ``True`` in the future.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    md</span>
<span class="sd">        Direct access to the dict-like persistent storage described above</span>

<span class="sd">    record_interruptions</span>
<span class="sd">        False by default. Set to True to generate an extra event stream</span>
<span class="sd">        that records any interruptions (pauses, suspensions).</span>

<span class="sd">    state</span>
<span class="sd">        {&#39;idle&#39;, &#39;running&#39;, &#39;paused&#39;}</span>

<span class="sd">    suspenders</span>
<span class="sd">        Read-only collection of `bluesky.suspenders.SuspenderBase` objects</span>
<span class="sd">        which can suspend and resume execution; see related methods.</span>

<span class="sd">    preprocessors : list</span>
<span class="sd">        Generator functions that take in a plan (generator instance) and</span>
<span class="sd">        modify its messages on the way out. Suitable examples include</span>
<span class="sd">        the functions in the module ``bluesky.plans`` with names ending in</span>
<span class="sd">        &#39;wrapper&#39;.  Functions are composed in order: the preprocessors</span>
<span class="sd">        ``[f, g]`` are applied like ``f(g(plan))``.</span>

<span class="sd">    msg_hook</span>
<span class="sd">        Callable that receives all messages before they are processed</span>
<span class="sd">        (useful for logging or other development purposes); expected</span>
<span class="sd">        signature is ``f(msg)`` where ``msg`` is a ``bluesky.Msg``, a</span>
<span class="sd">        kind of namedtuple; default is None.</span>

<span class="sd">    state_hook</span>
<span class="sd">        Callable with signature ``f(new_state, old_state)`` that will be</span>
<span class="sd">        called whenever the RunEngine&#39;s state attribute is updated; default</span>
<span class="sd">        is None</span>

<span class="sd">    waiting_hook</span>
<span class="sd">        Callable with signature ``f(status_object)`` that will be called</span>
<span class="sd">        whenever the RunEngine is waiting for long-running commands</span>
<span class="sd">        (trigger, set, kickoff, complete) to complete. This hook is useful to</span>
<span class="sd">        incorporate a progress bar.</span>

<span class="sd">    ignore_callback_exceptions</span>
<span class="sd">        Boolean, False by default.</span>

<span class="sd">    call_returns_result</span>
<span class="sd">        Boolean, False by default. If False, RunEngine will return uuid list</span>
<span class="sd">        after running a plan. If True, RunEngine will return a RunEngineResult</span>
<span class="sd">        object that contains the plan result, error status, and uuid list.</span>

<span class="sd">    loop : asyncio event loop</span>
<span class="sd">        e.g., ``asyncio.get_event_loop()`` or ``asyncio.new_event_loop()``</span>

<span class="sd">    max_depth</span>
<span class="sd">        Maximum stack depth; set this to prevent users from calling the</span>
<span class="sd">        RunEngine inside a function (which can result in unexpected</span>
<span class="sd">        behavior and breaks introspection tools). Default is None.</span>
<span class="sd">        For built-in Python interpreter, set to 2. For IPython, set to 11</span>
<span class="sd">        (tested on IPython 5.1.0; other versions may vary).</span>

<span class="sd">    pause_msg : str</span>
<span class="sd">        The message printed when a run is interrupted. This message</span>
<span class="sd">        includes instructions of changing the state of the RunEngine.</span>
<span class="sd">        It is set to ``bluesky.run_engine.PAUSE_MSG`` by default and</span>
<span class="sd">        can be modified based on needs.</span>

<span class="sd">    commands:</span>
<span class="sd">        The list of commands available to Msg.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">_state</span> <span class="o">=</span> <span class="n">LoggingPropertyMachine</span><span class="p">(</span><span class="n">RunEngineStateMachine</span><span class="p">)</span>
    <span class="n">_UNCACHEABLE_COMMANDS</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;pause&quot;</span><span class="p">,</span>
        <span class="s2">&quot;subscribe&quot;</span><span class="p">,</span>
        <span class="s2">&quot;unsubscribe&quot;</span><span class="p">,</span>
        <span class="s2">&quot;stage&quot;</span><span class="p">,</span>
        <span class="s2">&quot;unstage&quot;</span><span class="p">,</span>
        <span class="s2">&quot;monitor&quot;</span><span class="p">,</span>
        <span class="s2">&quot;unmonitor&quot;</span><span class="p">,</span>
        <span class="s2">&quot;open_run&quot;</span><span class="p">,</span>
        <span class="s2">&quot;close_run&quot;</span><span class="p">,</span>
        <span class="s2">&quot;install_suspender&quot;</span><span class="p">,</span>
        <span class="s2">&quot;remove_suspender&quot;</span><span class="p">,</span>
        <span class="s2">&quot;_start_suspender&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">RunBundler</span> <span class="o">=</span> <span class="n">RunBundler</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">deferred_pause_requested</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The property returns ``True`` if deferred pause was requested, but</span>
<span class="sd">        not processed. The deferred pause is processed at the next checkpoint.</span>
<span class="sd">        If the pause is requested past the last checkpoint, the plan runs</span>
<span class="sd">        to completion and this property returns ``True`` until the next</span>
<span class="sd">        plan is started. Starting the next plan clears deferred pause request.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        boolean</span>
<span class="sd">            Indicates if deferred pause was requested, but not processed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deferred_pause_requested</span>

<div class="viewcode-block" id="RunEngine.__init__">
<a class="viewcode-back" href="../../generated/bluesky.run_engine.RunEngine.html#bluesky.run_engine.RunEngine.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">md</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">dict</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">loop</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">AbstractEventLoop</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">preprocessors</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">context_managers</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">list</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">md_validator</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">md_normalizer</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Callable</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">scan_id_source</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Callable</span><span class="p">[[</span><span class="nb">dict</span><span class="p">],</span> <span class="n">SyncOrAsync</span><span class="p">[</span><span class="nb">int</span><span class="p">]]</span> <span class="o">=</span> <span class="n">default_scan_id_source</span><span class="p">,</span>
        <span class="n">during_task</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">DuringTask</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">call_returns_result</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">loop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">new_event_loop</span><span class="p">()</span>
        <span class="n">set_bluesky_event_loop</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_th</span> <span class="o">=</span> <span class="n">_ensure_event_loop_running</span><span class="p">(</span><span class="n">loop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state_lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span> <span class="o">=</span> <span class="n">loop</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">):</span>  <span class="c1"># noqa: UP036</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_loop_for_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;loop&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_loop_for_kwargs</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">AbstractEventLoop</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># When set, RunEngine.__call__ should stop blocking.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_blocking_event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_run_tracing_spans</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">Span</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># When cleared, RunEngine._run will pause until set.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_permit</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">setup_event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">setup_run_permit</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_permit</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_loop_for_kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_permit</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="n">setup_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">call_soon_threadsafe</span><span class="p">(</span><span class="n">setup_run_permit</span><span class="p">)</span>
        <span class="n">setup_event</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

        <span class="c1"># Make a logger for this specific RE instance, using the instance&#39;s</span>
        <span class="c1"># Python id, to keep from mixing output from separate instances.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">ComposableLogAdapter</span><span class="p">(</span><span class="n">logger</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;RE&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="p">})</span>

        <span class="k">if</span> <span class="n">md</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">md</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">md</span> <span class="o">=</span> <span class="n">md</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;versions&quot;</span><span class="p">,</span> <span class="p">{})</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">ophyd</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="s2">&quot;versions&quot;</span><span class="p">][</span><span class="s2">&quot;ophyd&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ophyd</span><span class="o">.</span><span class="n">__version__</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Failed to import ophyd.&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">ophyd_async</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="s2">&quot;versions&quot;</span><span class="p">][</span><span class="s2">&quot;ophyd_async&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ophyd_async</span><span class="o">.</span><span class="n">__version__</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Failed to import ophyd_async.&quot;</span><span class="p">)</span>

        <span class="kn">from</span><span class="w"> </span><span class="nn">._version</span><span class="w"> </span><span class="kn">import</span> <span class="n">__version__</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="s2">&quot;versions&quot;</span><span class="p">][</span><span class="s2">&quot;bluesky&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__version__</span>

        <span class="k">if</span> <span class="n">preprocessors</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">preprocessors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preprocessors</span> <span class="o">=</span> <span class="n">preprocessors</span>
        <span class="k">if</span> <span class="n">context_managers</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">context_managers</span> <span class="o">=</span> <span class="p">[</span><span class="n">SigintHandler</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context_managers</span> <span class="o">=</span> <span class="n">context_managers</span>
        <span class="k">if</span> <span class="n">md_validator</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">md_validator</span> <span class="o">=</span> <span class="n">_default_md_validator</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">md_validator</span> <span class="o">=</span> <span class="n">md_validator</span>
        <span class="k">if</span> <span class="n">md_normalizer</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">md_normalizer</span> <span class="o">=</span> <span class="n">_default_md_normalizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">md_normalizer</span> <span class="o">=</span> <span class="n">md_normalizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scan_id_source</span> <span class="o">=</span> <span class="n">scan_id_source</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">msg_hook</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">state_hook</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">waiting_hook</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">record_interruptions</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pause_msg</span> <span class="o">=</span> <span class="n">PAUSE_MSG</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">NO_PLAN_RETURN</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">during_task</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">during_task</span> <span class="o">=</span> <span class="n">DefaultDuringTask</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_during_task</span> <span class="o">=</span> <span class="n">during_task</span>

        <span class="c1"># The RunEngine keeps track of a *lot* of state.</span>
        <span class="c1"># All flags and caches are defined here with a comment. Good luck.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_call_returns_result</span> <span class="o">=</span> <span class="n">call_returns_result</span>  <span class="c1"># should __call__ return UIDs or plan value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_bundlers</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">RunBundler</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># a mapping of open run -&gt; bundlers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_per_call</span><span class="p">:</span> <span class="nb">dict</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># for all runs generated by one __call__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_deferred_pause_requested</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># pause at next &#39;checkpoint&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exception</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># stored and then raised in the _run loop</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interrupted</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># True if paused, aborted, or failed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_staged</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># objects staged, not yet unstaged</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_objs_seen</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># all objects seen</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_movable_objs_touched</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># objects we moved at any point</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uids</span><span class="p">:</span> <span class="nb">list</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>  <span class="c1"># run start uids generated by __call__  # noqa: C408</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_suspenders</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># set holding suspenders</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="nb">set</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>  <span class="c1"># sets of Events to wait for</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status_objs</span><span class="p">:</span> <span class="n">defaultdict</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="nb">set</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span>
            <span class="nb">set</span>
        <span class="p">)</span>  <span class="c1"># status objects to wait for</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_temp_callback_ids</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># ids from CallbackRegistry</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_seen_wait_and_move_on_keys</span><span class="p">:</span> <span class="nb">set</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
            <span class="nb">set</span><span class="p">()</span>
        <span class="p">)</span>  <span class="c1"># group ids that have been passed to _wait_and_move_on</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_msg_cache</span><span class="p">:</span> <span class="n">deque</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>  <span class="c1"># history of processed msgs for rewinding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rewindable_flag</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># if the RE is allowed to replay msgs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plan_stack</span><span class="p">:</span> <span class="n">deque</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>  <span class="c1"># stack of generators to work off of</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_response_stack</span><span class="p">:</span> <span class="n">deque</span><span class="p">[</span><span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>  <span class="c1"># resps to send into the plans</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exit_status</span> <span class="o">=</span> <span class="s2">&quot;success&quot;</span>  <span class="c1"># optimistic default</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reason</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>  <span class="c1"># reason for abort</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_task</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># asyncio.Task associated with call to self._run</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_task_fut</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># future proxy to the task above</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pardon_failures</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># will hold an asyncio.Event</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plan</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># the plan instance from __call__</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_require_stream_declaration</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_command_registry</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;declare_stream&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_declare_stream</span><span class="p">,</span>
            <span class="s2">&quot;create&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create</span><span class="p">,</span>
            <span class="s2">&quot;save&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_save</span><span class="p">,</span>
            <span class="s2">&quot;drop&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_drop</span><span class="p">,</span>
            <span class="s2">&quot;read&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read</span><span class="p">,</span>
            <span class="s2">&quot;locate&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_locate</span><span class="p">,</span>
            <span class="s2">&quot;monitor&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_monitor</span><span class="p">,</span>
            <span class="s2">&quot;unmonitor&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unmonitor</span><span class="p">,</span>
            <span class="s2">&quot;null&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_null</span><span class="p">,</span>
            <span class="s2">&quot;RE_class&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_RE_class</span><span class="p">,</span>
            <span class="s2">&quot;stop&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop</span><span class="p">,</span>
            <span class="s2">&quot;set&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_set</span><span class="p">,</span>
            <span class="s2">&quot;trigger&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_trigger</span><span class="p">,</span>
            <span class="s2">&quot;sleep&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sleep</span><span class="p">,</span>
            <span class="s2">&quot;wait&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait</span><span class="p">,</span>
            <span class="s2">&quot;checkpoint&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_checkpoint</span><span class="p">,</span>
            <span class="s2">&quot;clear_checkpoint&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clear_checkpoint</span><span class="p">,</span>
            <span class="s2">&quot;rewindable&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rewindable</span><span class="p">,</span>
            <span class="s2">&quot;pause&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pause</span><span class="p">,</span>
            <span class="s2">&quot;_resume_from_suspender&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resume</span><span class="p">,</span>
            <span class="s2">&quot;_start_suspender&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_start_suspender</span><span class="p">,</span>
            <span class="s2">&quot;prepare&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare</span><span class="p">,</span>
            <span class="s2">&quot;collect&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect</span><span class="p">,</span>
            <span class="s2">&quot;kickoff&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kickoff</span><span class="p">,</span>
            <span class="s2">&quot;complete&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_complete</span><span class="p">,</span>
            <span class="s2">&quot;configure&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_configure</span><span class="p">,</span>
            <span class="s2">&quot;stage&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stage</span><span class="p">,</span>
            <span class="s2">&quot;unstage&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unstage</span><span class="p">,</span>
            <span class="s2">&quot;subscribe&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subscribe</span><span class="p">,</span>
            <span class="s2">&quot;unsubscribe&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unsubscribe</span><span class="p">,</span>
            <span class="s2">&quot;open_run&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_run</span><span class="p">,</span>
            <span class="s2">&quot;close_run&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_close_run</span><span class="p">,</span>
            <span class="s2">&quot;wait_for&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for</span><span class="p">,</span>
            <span class="s2">&quot;input&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_input</span><span class="p">,</span>
            <span class="s2">&quot;install_suspender&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_install_suspender</span><span class="p">,</span>
            <span class="s2">&quot;remove_suspender&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_suspender</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># public dispatcher for callbacks</span>
        <span class="c1"># The Dispatcher&#39;s public methods are exposed through the</span>
        <span class="c1"># RunEngine for user convenience.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispatcher</span> <span class="o">=</span> <span class="n">Dispatcher</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ignore_callback_exceptions</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># aliases for back-compatibility</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subscribe_lossless</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatcher</span><span class="o">.</span><span class="n">subscribe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unsubscribe_lossless</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatcher</span><span class="o">.</span><span class="n">unsubscribe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_subscribe_lossless</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatcher</span><span class="o">.</span><span class="n">subscribe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unsubscribe_lossless</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatcher</span><span class="o">.</span><span class="n">unsubscribe</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">commands</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The list of commands available to Msg.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :meth:`RunEngine.register_command`</span>
<span class="sd">        :meth:`RunEngine.unregister_command`</span>
<span class="sd">        :meth:`RunEngine.print_command_registry`</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from bluesky import RunEngine</span>
<span class="sd">        &gt;&gt;&gt; RE = RunEngine()</span>
<span class="sd">        &gt;&gt;&gt; # to list commands</span>
<span class="sd">        &gt;&gt;&gt; RE.commands</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># return as a list, not lazy loader, no surprises...</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_command_registry</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

<div class="viewcode-block" id="RunEngine.print_command_registry">
<a class="viewcode-back" href="../../msg.html#bluesky.run_engine.RunEngine.print_command_registry">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">print_command_registry</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        This conveniently prints the command registry of available</span>
<span class="sd">        commands.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        Verbose : bool, optional</span>
<span class="sd">        verbose print. Default is False</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :meth:`RunEngine.register_command`</span>
<span class="sd">        :meth:`RunEngine.unregister_command`</span>
<span class="sd">        :attr:`RunEngine.commands`</span>

<span class="sd">        Examples</span>
<span class="sd">        --------</span>
<span class="sd">        &gt;&gt;&gt; from bluesky import RunEngine</span>
<span class="sd">        &gt;&gt;&gt; RE = RunEngine()</span>
<span class="sd">        &gt;&gt;&gt; # Print a very verbose list of currently registered commands</span>
<span class="sd">        &gt;&gt;&gt; RE.print_command_registry(verbose=True)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">commands</span> <span class="o">=</span> <span class="s2">&quot;List of available commands</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">for</span> <span class="n">command</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_command_registry</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">docstring</span> <span class="o">=</span> <span class="n">func</span><span class="o">.</span><span class="vm">__doc__</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">docstring</span> <span class="o">=</span> <span class="n">docstring</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">commands</span> <span class="o">=</span> <span class="n">commands</span> <span class="o">+</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2"> : </span><span class="si">{</span><span class="n">docstring</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">commands</span></div>


<div class="viewcode-block" id="RunEngine.subscribe">
<a class="viewcode-back" href="../../generated/bluesky.run_engine.RunEngine.subscribe.html#bluesky.run_engine.RunEngine.subscribe">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">subscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register a callback function to consume documents.</span>

<span class="sd">        .. versionchanged :: 0.10.0</span>
<span class="sd">            The order of the arguments was swapped and the ``name``</span>
<span class="sd">            argument has been given a default value, ``&#39;all&#39;``. Because the</span>
<span class="sd">            meaning of the arguments is unambiguous (they must be a callable</span>
<span class="sd">            and a string, respectively) the old order will be supported</span>
<span class="sd">            indefinitely, with a warning.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func: callable</span>
<span class="sd">            expecting signature like ``f(name, document)``</span>
<span class="sd">            where name is a string and document is a dict</span>
<span class="sd">        name : {&#39;all&#39;, &#39;start&#39;, &#39;descriptor&#39;, &#39;event&#39;, &#39;stop&#39;}, optional</span>
<span class="sd">            the type of document this function should receive (&#39;all&#39; by</span>
<span class="sd">            default)</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        token : int</span>
<span class="sd">            an integer ID that can be used to unsubscribe</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :meth:`RunEngine.unsubscribe`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pass through to the Dispatcher, spelled out verbosely here to make</span>
        <span class="c1"># sphinx happy -- tricks with __doc__ aren&#39;t enough to fool it</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatcher</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span></div>


<div class="viewcode-block" id="RunEngine.unsubscribe">
<a class="viewcode-back" href="../../generated/bluesky.run_engine.RunEngine.unsubscribe.html#bluesky.run_engine.RunEngine.unsubscribe">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">unsubscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Unregister a callback function its integer ID.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        token : int</span>
<span class="sd">            the integer ID issued by :meth:`RunEngine.subscribe`</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :meth:`RunEngine.subscribe`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># pass through to the Dispatcher, spelled out verbosely here to make</span>
        <span class="c1"># sphinx happy -- tricks with __doc__ aren&#39;t enough to fool it</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatcher</span><span class="o">.</span><span class="n">unsubscribe</span><span class="p">(</span><span class="n">token</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">rewindable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rewindable_flag</span>

    <span class="nd">@rewindable</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">rewindable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="n">cur_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rewindable_flag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rewindable_flag</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">resumable</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rewindable_flag</span> <span class="o">!=</span> <span class="n">cur_state</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reset_checkpoint_state</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">loop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">suspenders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_suspenders</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">verbose</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">disabled</span>

    <span class="nd">@verbose</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">verbose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">disabled</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">value</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">call_returns_result</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_returns_result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_clear_run_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Clean up for a new run.&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status_objs</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interruptions_desc_uid</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interruptions_counter</span> <span class="o">=</span> <span class="n">count</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="nd">@_state_locked</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_clear_call_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Clean up for a new __call__ (which may encompass multiple runs).&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_per_call</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_staged</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_objs_seen</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_movable_objs_touched</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_deferred_pause_requested</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plan_stack</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_msg_cache</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_response_stack</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exception</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uids</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exit_status</span> <span class="o">=</span> <span class="s2">&quot;success&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reason</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_task</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_task_fut</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_pardon_failures</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Event</span><span class="p">(</span><span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_loop_for_kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plan</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interrupted</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Unsubscribe for per-run callbacks.</span>
        <span class="k">for</span> <span class="n">cid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_temp_callback_ids</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unsubscribe</span><span class="p">(</span><span class="n">cid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_temp_callback_ids</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Clean up caches and unsubscribe subscriptions.</span>

<span class="sd">        Lossless subscriptions are not unsubscribed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">!=</span> <span class="s2">&quot;idle&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">halt</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clear_run_cache</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clear_call_cache</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispatcher</span><span class="o">.</span><span class="n">unsubscribe_all</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">resumable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;i.e., can the plan in progress by rewound&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_msg_cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ignore_callback_exceptions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatcher</span><span class="o">.</span><span class="n">ignore_exceptions</span>

    <span class="nd">@ignore_callback_exceptions</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ignore_callback_exceptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispatcher</span><span class="o">.</span><span class="n">ignore_exceptions</span> <span class="o">=</span> <span class="n">val</span>

<div class="viewcode-block" id="RunEngine.register_command">
<a class="viewcode-back" href="../../simulation.html#bluesky.run_engine.RunEngine.register_command">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">register_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register a new Message command.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">        func : callable</span>
<span class="sd">            This can be a function or a method. The signature is `f(msg)`.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :meth:`RunEngine.unregister_command`</span>
<span class="sd">        :meth:`RunEngine.print_command_registry`</span>
<span class="sd">        :attr:`RunEngine.commands`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_command_registry</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span></div>


<div class="viewcode-block" id="RunEngine.unregister_command">
<a class="viewcode-back" href="../../simulation.html#bluesky.run_engine.RunEngine.unregister_command">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">unregister_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Unregister a Message command.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :meth:`RunEngine.register_command`</span>
<span class="sd">        :meth:`RunEngine.print_command_registry`</span>
<span class="sd">        :attr:`RunEngine.commands`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_command_registry</span><span class="p">[</span><span class="n">name</span><span class="p">]</span></div>


<div class="viewcode-block" id="RunEngine.request_pause">
<a class="viewcode-back" href="../../state-machine.html#bluesky.run_engine.RunEngine.request_pause">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">request_pause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">defer</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Command the Run Engine to pause.</span>

<span class="sd">        This function is called by &#39;pause&#39; Messages. It can also be called</span>
<span class="sd">        by other threads. It cannot be called on the main thread during a run,</span>
<span class="sd">        but it is called by SIGINT (i.e., Ctrl+C).</span>

<span class="sd">        If there current run has no checkpoint (via the &#39;clear_checkpoint&#39;</span>
<span class="sd">        message), this will cause the run to abort.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        defer : bool, optional</span>
<span class="sd">            If False, pause immediately before processing any new messages.</span>
<span class="sd">            If True, pause at the next checkpoint.</span>
<span class="sd">            False by default.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;panicked&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;The RunEngine is panicked and cannot be recovered. You must restart bluesky.&quot;</span><span class="p">)</span>
        <span class="n">future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run_coroutine_threadsafe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_request_pause_coro</span><span class="p">(</span><span class="n">defer</span><span class="p">),</span> <span class="n">loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">)</span>
        <span class="c1"># TODO add a timeout here?</span>
        <span class="k">return</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span></div>


    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_request_pause_coro</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">defer</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># We are pausing. Cancel any deferred pause previously requested.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="o">.</span><span class="n">can_pause</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TransitionError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Run Engine is in &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="si">}</span><span class="s2">&#39; state and can not be paused.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">defer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_deferred_pause_requested</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Deferred pause acknowledged. Continuing to checkpoint.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pausing...&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_deferred_pause_requested</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interrupted</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="s2">&quot;pausing&quot;</span>
        <span class="k">for</span> <span class="n">current_run</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_bundlers</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">current_run</span><span class="o">.</span><span class="n">record_interruption</span><span class="p">(</span><span class="s2">&quot;pause&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_result</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plan_return</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Create a RunEngineResult to return from __call__, using</span>
<span class="sd">        plan_return and internal state</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">rs</span> <span class="o">=</span> <span class="n">RunEngineResult</span><span class="p">(</span>
            <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uids</span><span class="p">),</span>
            <span class="n">plan_return</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exit_status</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_interrupted</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reason</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exception</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">rs</span>

<div class="viewcode-block" id="RunEngine.__call__">
<a class="viewcode-back" href="../../generated/bluesky.run_engine.RunEngine.__call__.html#bluesky.run_engine.RunEngine.__call__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">plan</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Iterable</span><span class="p">[</span><span class="n">Msg</span><span class="p">],</span>
        <span class="n">subs</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">Subscribers</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">/</span><span class="p">,</span>
        <span class="o">**</span><span class="n">metadata_kw</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">typing</span><span class="o">.</span><span class="n">Union</span><span class="p">[</span><span class="n">RunEngineResult</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="o">...</span><span class="p">]]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute a plan.</span>

<span class="sd">        Any keyword arguments will be interpreted as metadata and recorded with</span>
<span class="sd">        any run(s) created by executing the plan. Notice that the plan</span>
<span class="sd">        (required) and extra subscriptions (optional) must be given as</span>
<span class="sd">        positional arguments.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        plan : generator (positional only)</span>
<span class="sd">            a generator or that yields ``Msg`` objects (or an iterable that</span>
<span class="sd">            returns such a generator)</span>
<span class="sd">        subs : callable, list, or dict, optional (positional only)</span>
<span class="sd">            Temporary subscriptions (a.k.a. callbacks) to be used on this run.</span>
<span class="sd">            For convenience, any of the following are accepted:</span>

<span class="sd">            * a callable, which will be subscribed to &#39;all&#39;</span>
<span class="sd">            * a list of callables, which again will be subscribed to &#39;all&#39;</span>
<span class="sd">            * a dictionary, mapping specific subscriptions to callables or</span>
<span class="sd">              lists of callables; valid keys are {&#39;all&#39;, &#39;start&#39;, &#39;stop&#39;,</span>
<span class="sd">              &#39;event&#39;, &#39;descriptor&#39;}</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        uids : tuple</span>
<span class="sd">            list of uids (i.e. RunStart Document uids) of run(s)</span>
<span class="sd">            if :attr:`RunEngine._call_returns_result` is ``False``</span>
<span class="sd">        result : :class:`RunEngineResult`</span>
<span class="sd">            if :attr:`RunEngine._call_returns_result` is ``True``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;panicked&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;The RunEngine is panicked and cannot be recovered. You must restart bluesky.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s2">&quot;raise_if_interrupted&quot;</span> <span class="ow">in</span> <span class="n">metadata_kw</span><span class="p">:</span>
            <span class="n">warn</span><span class="p">(</span>  <span class="c1"># noqa: B028</span>
                <span class="s2">&quot;The &#39;raise_if_interrupted&#39; flag has been removed. The &quot;</span>
                <span class="s2">&quot;RunEngine now always raises RunEngineInterrupted if it is &quot;</span>
                <span class="s2">&quot;interrupted. The &#39;raise_if_interrupted&#39; keyword argument, &quot;</span>
                <span class="s2">&quot;like all keyword arguments, will be interpreted as &quot;</span>
                <span class="s2">&quot;metadata.&quot;</span>
            <span class="p">)</span>
        <span class="c1"># Check that the RE is not being called from inside a function.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">frame</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span>
            <span class="n">depth</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">inspect</span><span class="o">.</span><span class="n">getouterframes</span><span class="p">(</span><span class="n">frame</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span><span class="p">:</span>
                <span class="n">text</span> <span class="o">=</span> <span class="n">MAX_DEPTH_EXCEEDED_ERR_MSG</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">max_depth</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>

        <span class="c1"># If we are in the wrong state, raise.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">is_idle</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The RunEngine is in a </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="si">}</span><span class="s2"> state&quot;</span><span class="p">)</span>

        <span class="n">futs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">tripped_justifications</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sup</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">suspenders</span><span class="p">:</span>
            <span class="n">f_lst</span><span class="p">,</span> <span class="n">justification</span> <span class="o">=</span> <span class="n">sup</span><span class="o">.</span><span class="n">get_futures</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">f_lst</span><span class="p">:</span>
                <span class="n">futs</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">f_lst</span><span class="p">)</span>
                <span class="n">tripped_justifications</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">justification</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">tripped_justifications</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;At least one suspender has tripped. The plan will begin &quot;</span>
                <span class="s2">&quot;when all suspenders are ready. Justification:&quot;</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">justification</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tripped_justifications</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;    </span><span class="si">{</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">justification</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">()</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Suspending... To get to the prompt, hit Ctrl-C twice to pause.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_clear_call_cache</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clear_run_cache</span><span class="p">()</span>  <span class="c1"># paranoia, in case of previous bad exit</span>

        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">funcs</span> <span class="ow">in</span> <span class="n">normalize_subs_input</span><span class="p">(</span><span class="n">subs</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">funcs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_temp_callback_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">name</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_plan</span> <span class="o">=</span> <span class="n">plan</span>  <span class="c1"># this ref is just used for metadata introspection</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_per_call</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">metadata_kw</span><span class="p">)</span>

        <span class="n">gen</span> <span class="o">=</span> <span class="n">ensure_generator</span><span class="p">(</span><span class="n">plan</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">wrapper_func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocessors</span><span class="p">:</span>
            <span class="n">gen</span> <span class="o">=</span> <span class="n">wrapper_func</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_plan_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_response_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">futs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plan_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">single_gen</span><span class="p">(</span><span class="n">Msg</span><span class="p">(</span><span class="s2">&quot;wait_for&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">futs</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Executing plan </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plan</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_build_task</span><span class="p">():</span>
            <span class="c1"># make sure _run will block at the top</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_permit</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_blocking_event</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_task_fut</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run_coroutine_threadsafe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_run</span><span class="p">(),</span> <span class="n">loop</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">)</span>

            <span class="k">def</span><span class="w"> </span><span class="nf">set_blocking_event</span><span class="p">(</span><span class="n">future</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_blocking_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_task_fut</span><span class="o">.</span><span class="n">add_done_callback</span><span class="p">(</span><span class="n">set_blocking_event</span><span class="p">)</span>

        <span class="n">plan_return</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resume_task</span><span class="p">(</span><span class="n">init_func</span><span class="o">=</span><span class="n">_build_task</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interrupted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RunEngineInterrupted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pause_msg</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_returns_result</span><span class="p">:</span>
            <span class="n">run_engine_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_result</span><span class="p">(</span><span class="n">plan_return</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">run_engine_result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uids</span><span class="p">)</span></div>


<div class="viewcode-block" id="RunEngine.resume">
<a class="viewcode-back" href="../../generated/bluesky.run_engine.RunEngine.resume.html#bluesky.run_engine.RunEngine.resume">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">resume</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Resume a paused plan from the last checkpoint.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        uids : list</span>
<span class="sd">            list of uids (i.e. RunStart Document uids) of run(s)</span>
<span class="sd">            if :attr:`RunEngine._call_returns_result` is ``False``</span>
<span class="sd">        result : :class:`RunEngineResult`</span>
<span class="sd">            if :attr:`RunEngine._call_returns_result` is ``True``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;panicked&quot;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;The RunEngine is panicked and cannot be recovered. You must restart bluesky.&quot;</span><span class="p">)</span>

        <span class="c1"># The state machine does not capture the whole picture.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">is_paused</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TransitionError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The RunEngine is the </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="si">}</span><span class="s2"> state. You can only resume for the paused state.&quot;</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_interrupted</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">current_run</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_bundlers</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">current_run</span><span class="o">.</span><span class="n">record_interruption</span><span class="p">(</span><span class="s2">&quot;resume&quot;</span><span class="p">)</span>
        <span class="n">new_plan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rewind</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plan_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_plan</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_response_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="c1"># Notify Devices of the resume in case they want to clean up.</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_objs_seen</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Pausable</span><span class="p">):</span>
                <span class="n">fut</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run_coroutine_threadsafe</span><span class="p">(</span><span class="n">maybe_await</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">resume</span><span class="p">()),</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="p">)</span>
                <span class="n">fut</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
        <span class="n">plan_return</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resume_task</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_interrupted</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">RunEngineInterrupted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pause_msg</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_returns_result</span><span class="p">:</span>
            <span class="n">run_engine_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_result</span><span class="p">(</span><span class="n">plan_return</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">run_engine_result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uids</span><span class="p">)</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_rewind</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clean up in preparation for resuming from a pause or suspension.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        new_plan : generator</span>
<span class="sd">             A new plan made from the messages in the message cache</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">len_msg_cache</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_msg_cache</span><span class="p">)</span>
        <span class="n">new_plan</span> <span class="o">=</span> <span class="n">ensure_generator</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_msg_cache</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_msg_cache</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">len_msg_cache</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">current_run</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_bundlers</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">current_run</span><span class="o">.</span><span class="n">rewind</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">new_plan</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_resume_task</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">init_func</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># Clear the blocking Event so that we can wait on it below.</span>
        <span class="c1"># The task will set it when it is done, as it was previously</span>
        <span class="c1"># configured to do it __call__.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_blocking_event</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="c1"># Handle all context managers</span>
        <span class="k">with</span> <span class="n">ExitStack</span><span class="p">()</span> <span class="k">as</span> <span class="n">stack</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">mgr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_managers</span><span class="p">:</span>
                <span class="n">stack</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="n">mgr</span><span class="p">(</span><span class="bp">self</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">init_func</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">init_func</span><span class="p">()</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task_fut</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task_fut</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task_fut</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                <span class="k">except</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">NO_PLAN_RETURN</span>
            <span class="c1"># The _run task is waiting on this Event. Let is continue.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">call_soon_threadsafe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_permit</span><span class="o">.</span><span class="n">set</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Block until plan is complete or exception is raised.</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_during_task</span><span class="o">.</span><span class="n">block</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_blocking_event</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                    <span class="kn">import</span><span class="w"> </span><span class="nn">ctypes</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_interrupted</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># we can not interrupt a python thread from the outside</span>
                    <span class="c1"># but there is an API to schedule an exception to be raised</span>
                    <span class="c1"># the next time that thread would interpret byte code.</span>
                    <span class="c1"># The documentation of this function includes the sentence</span>
                    <span class="c1">#</span>
                    <span class="c1">#   To prevent naive misuse, you must write your</span>
                    <span class="c1">#   own C extension to call this.</span>
                    <span class="c1">#</span>
                    <span class="c1"># Here we cheat a bit and use ctypes.</span>
                    <span class="n">num_threads</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">pythonapi</span><span class="o">.</span><span class="n">PyThreadState_SetAsyncExc</span><span class="p">(</span>
                        <span class="n">ctypes</span><span class="o">.</span><span class="n">c_ulong</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_th</span><span class="o">.</span><span class="n">ident</span><span class="p">),</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">py_object</span><span class="p">(</span><span class="n">_RunEnginePanic</span><span class="p">)</span>
                    <span class="p">)</span>
                    <span class="c1"># however, if the thread is in a system call (such</span>
                    <span class="c1"># as sleep or I/O) there is no way to interrupt it</span>
                    <span class="c1"># (per decree of Guido) thus we give it a second</span>
                    <span class="c1"># to sort it&#39;s self out</span>
                    <span class="n">task_finished</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_blocking_event</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="c1"># before giving up and putting the RE in a</span>
                    <span class="c1"># non-recoverable panicked state.</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">task_finished</span> <span class="ow">or</span> <span class="n">num_threads</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="s2">&quot;panicked&quot;</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">raised_er</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">halt</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_interrupted</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">raise</span> <span class="n">raised_er</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task_fut</span><span class="o">.</span><span class="n">done</span><span class="p">():</span>
                    <span class="c1"># get exceptions from the main task</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">exc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task_fut</span><span class="o">.</span><span class="n">exception</span><span class="p">()</span>
                    <span class="k">except</span> <span class="p">(</span><span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">,</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">):</span>
                        <span class="n">exc</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="c1"># Only try to get a result if there wasn&#39;t an error,</span>
                    <span class="c1"># (other than a cancelled error)</span>
                    <span class="k">if</span> <span class="n">exc</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">plan_return</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_task_fut</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                        <span class="k">except</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
                            <span class="n">plan_return</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NO_PLAN_RETURN</span>
                    <span class="c1"># we have something in exc</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># special case the panic exception that we put in above</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">_RunEnginePanic</span><span class="p">):</span>
                            <span class="n">plan_return</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NO_PLAN_RETURN</span>
                        <span class="c1"># otherwise re-raise it</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="n">exc</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">plan_return</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">return</span> <span class="n">plan_return</span>

<div class="viewcode-block" id="RunEngine.install_suspender">
<a class="viewcode-back" href="../../state-machine.html#bluesky.run_engine.RunEngine.install_suspender">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">install_suspender</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">suspender</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Install a &#39;suspender&#39;, which can suspend and resume execution.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        suspender : `bluesky.suspenders.SuspenderBase`</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :meth:`RunEngine.remove_suspender`</span>
<span class="sd">        :meth:`RunEngine.clear_suspenders`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_suspenders</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">suspender</span><span class="p">)</span>
        <span class="n">suspender</span><span class="o">.</span><span class="n">install</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span></div>


    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_install_suspender</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        See :meth: `RunEngine.install_suspender`</span>

<span class="sd">        Expected message object is:</span>

<span class="sd">            Msg(&#39;install_suspender&#39;, None, suspender)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">suspender</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">install_suspender</span><span class="p">(</span><span class="n">suspender</span><span class="p">)</span>

<div class="viewcode-block" id="RunEngine.remove_suspender">
<a class="viewcode-back" href="../../state-machine.html#bluesky.run_engine.RunEngine.remove_suspender">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">remove_suspender</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">suspender</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Uninstall a suspender.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        suspender : `bluesky.suspenders.SuspenderBase`</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :meth:`RunEngine.install_suspender`</span>
<span class="sd">        :meth:`RunEngine.clear_suspenders`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">suspender</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_suspenders</span><span class="p">:</span>
            <span class="n">suspender</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_suspenders</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">suspender</span><span class="p">)</span></div>


    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_remove_suspender</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        See :meth: `RunEngine.remove_suspender`</span>

<span class="sd">        Expected message object is:</span>

<span class="sd">            Msg(&#39;remove_suspender&#39;, None, suspender)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">suspender</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remove_suspender</span><span class="p">(</span><span class="n">suspender</span><span class="p">)</span>

<div class="viewcode-block" id="RunEngine.clear_suspenders">
<a class="viewcode-back" href="../../state-machine.html#bluesky.run_engine.RunEngine.clear_suspenders">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clear_suspenders</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Uninstall all suspenders.</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :meth:`RunEngine.install_suspender`</span>
<span class="sd">        :meth:`RunEngine.remove_suspender`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">sus</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">suspenders</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">remove_suspender</span><span class="p">(</span><span class="n">sus</span><span class="p">)</span></div>


<div class="viewcode-block" id="RunEngine.request_suspend">
<a class="viewcode-back" href="../../state-machine.html#bluesky.run_engine.RunEngine.request_suspend">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">request_suspend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fut</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">pre_plan</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">post_plan</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">justification</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Request that the run suspend itself until the future is finished.</span>

<span class="sd">        The two plans will be run before and after waiting for the future.</span>
<span class="sd">        This enable doing things like opening and closing shutters and</span>
<span class="sd">        resetting cameras around a suspend.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        fut : asyncio.Future</span>

<span class="sd">        pre_plan : iterable or callable, optional</span>
<span class="sd">           Plan to execute just before suspending. If callable, must</span>
<span class="sd">           take no arguments.</span>

<span class="sd">        post_plan : iterable or callable, optional</span>
<span class="sd">            Plan to execute just before resuming. If callable, must</span>
<span class="sd">            take no arguments.</span>

<span class="sd">        justification : str, optional</span>
<span class="sd">            explanation of why the suspension has been requested</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Suspending....To get prompt hit Ctrl-C twice to pause.&quot;</span><span class="p">)</span>
        <span class="n">ts</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Suspension occurred at </span><span class="si">{</span><span class="n">ts</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_request_suspend</span><span class="p">(</span><span class="n">pre_plan</span><span class="p">,</span> <span class="n">post_plan</span><span class="p">,</span> <span class="n">justification</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">resumable</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;No checkpoint; cannot suspend.&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Aborting: running cleanup and marking exit_status as &#39;abort&#39;...&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_interrupted</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_lock</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_exception</span> <span class="o">=</span> <span class="n">FailedPause</span><span class="p">()</span>
                <span class="n">was_paused</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="s2">&quot;paused&quot;</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="s2">&quot;aborting&quot;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">was_paused</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">justification</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Justification for this suspension:</span><span class="se">\n</span><span class="si">{</span><span class="n">justification</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># add starting the suspender logic to the stack</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_plan_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">single_gen</span><span class="p">(</span><span class="n">Msg</span><span class="p">(</span><span class="s2">&quot;_start_suspender&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">pre_plan</span><span class="p">,</span> <span class="n">post_plan</span><span class="p">,</span> <span class="n">justification</span><span class="p">,</span> <span class="n">fut</span><span class="p">))</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_response_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

            <span class="c1"># The event loop is still running. The pre_plan will be processed,</span>
            <span class="c1"># and then the RunEngine will be hung up on processing the</span>
            <span class="c1"># &#39;wait_for&#39; message until `fut` is set.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="s2">&quot;paused&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="s2">&quot;suspending&quot;</span>
                <span class="c1"># bump the _run task out of what ever it is awaiting</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">call_soon_threadsafe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">,</span> <span class="n">_request_suspend</span><span class="p">(</span><span class="n">pre_plan</span><span class="p">,</span> <span class="n">post_plan</span><span class="p">,</span> <span class="n">justification</span><span class="p">))</span></div>


    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_start_suspender</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        An internal message to do the initial work of starting a suspender</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pre_plan</span><span class="p">,</span> <span class="n">post_plan</span><span class="p">,</span> <span class="n">justification</span><span class="p">,</span> <span class="n">fut</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">args</span>
        <span class="k">for</span> <span class="n">current_run</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_bundlers</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">current_run</span><span class="o">.</span><span class="n">record_interruption</span><span class="p">(</span><span class="n">justification</span> <span class="k">if</span> <span class="n">justification</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;suspended&quot;</span><span class="p">)</span>
        <span class="c1"># During suspend, all motors should be stopped. Call stop() on</span>
        <span class="c1"># every object we ever set().</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_movable_objects</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># Notify Devices of the pause in case they want to clean up.</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_objs_seen</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;pause&quot;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">maybe_await</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">pause</span><span class="p">())</span>
                <span class="k">except</span> <span class="n">NoReplayAllowed</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_reset_checkpoint_state_meth</span><span class="p">()</span>
        <span class="c1"># rewind to the last checkpoint</span>
        <span class="n">rewind_plan</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rewind</span><span class="p">()</span>
        <span class="n">was_rewindable</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rewindable</span>

        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">pre_plan</span><span class="p">):</span>
            <span class="n">pre_plan</span> <span class="o">=</span> <span class="n">pre_plan</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">post_plan</span><span class="p">):</span>
            <span class="n">post_plan</span> <span class="o">=</span> <span class="n">post_plan</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">suspender_helper_inner_plan</span><span class="p">():</span>
            <span class="c1"># none of this should run again.</span>
            <span class="k">yield</span> <span class="n">Msg</span><span class="p">(</span><span class="s2">&quot;rewindable&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="c1"># if there is a pre plan add on top of the wait</span>
            <span class="k">if</span> <span class="n">pre_plan</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">yield from</span> <span class="n">ensure_generator</span><span class="p">(</span><span class="n">pre_plan</span><span class="p">)</span>
            <span class="c1"># wait for the future from the suspender to be released</span>
            <span class="k">yield</span> <span class="n">Msg</span><span class="p">(</span>
                <span class="s2">&quot;wait_for&quot;</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
                <span class="p">[</span>
                    <span class="n">fut</span><span class="p">,</span>
                <span class="p">],</span>
            <span class="p">)</span>
            <span class="c1"># do the work we need to do to resume</span>
            <span class="k">yield</span> <span class="n">Msg</span><span class="p">(</span>
                <span class="s2">&quot;_resume_from_suspender&quot;</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="c1"># if there is a post plan, run it</span>
            <span class="k">if</span> <span class="n">post_plan</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">yield from</span> <span class="n">ensure_generator</span><span class="p">(</span><span class="n">post_plan</span><span class="p">)</span>
            <span class="c1"># put rewindable back the way it was</span>
            <span class="k">yield</span> <span class="n">Msg</span><span class="p">(</span><span class="s2">&quot;rewindable&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">was_rewindable</span><span class="p">)</span>
            <span class="k">yield from</span> <span class="n">rewind_plan</span>

        <span class="c1"># add the above helper to the plan stack</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_plan_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">suspender_helper_inner_plan</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_response_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

<div class="viewcode-block" id="RunEngine.abort">
<a class="viewcode-back" href="../../generated/bluesky.run_engine.RunEngine.abort.html#bluesky.run_engine.RunEngine.abort">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">abort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop a running or paused plan and mark it as aborted.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        uids : tuple</span>
<span class="sd">            list of uids (i.e. RunStart Document uids) of run(s)</span>
<span class="sd">            if :attr:`RunEngine._call_returns_result` is ``False``</span>
<span class="sd">        result : :class:`RunEngineResult`</span>
<span class="sd">            if :attr:`RunEngine._call_returns_result` is ``True``</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :meth:`RunEngine.halt`</span>
<span class="sd">        :meth:`RunEngine.stop`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__interrupter_helper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_abort_coro</span><span class="p">(</span><span class="n">reason</span><span class="p">))</span></div>


    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_abort_coro</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reason</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">is_idle</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TransitionError</span><span class="p">(</span><span class="s2">&quot;RunEngine is already idle.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Aborting: running cleanup and marking exit_status as &#39;abort&#39;...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interrupted</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reason</span> <span class="o">=</span> <span class="n">reason</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_exit_status</span> <span class="o">=</span> <span class="s2">&quot;abort&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_destroy_open_run_tracing_spans</span><span class="p">()</span>

        <span class="n">was_paused</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="s2">&quot;paused&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="s2">&quot;aborting&quot;</span>
        <span class="k">if</span> <span class="n">was_paused</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_lock</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_exception</span> <span class="o">=</span> <span class="n">RequestAbort</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_returns_result</span><span class="p">:</span>
            <span class="n">plan_return</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NO_PLAN_RETURN</span>
            <span class="n">run_engine_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_result</span><span class="p">(</span><span class="n">plan_return</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">run_engine_result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uids</span><span class="p">)</span>

<div class="viewcode-block" id="RunEngine.stop">
<a class="viewcode-back" href="../../generated/bluesky.run_engine.RunEngine.stop.html#bluesky.run_engine.RunEngine.stop">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop a running or paused plan, but mark it as successful (not aborted).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        uids : tuple</span>
<span class="sd">            list of uids (i.e. RunStart Document uids) of run(s)</span>
<span class="sd">            if :attr:`RunEngine._call_returns_result` is ``False``</span>
<span class="sd">        result : :class:`RunEngineResult`</span>
<span class="sd">            if :attr:`RunEngine._call_returns_result` is ``True``</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :meth:`RunEngine.abort`</span>
<span class="sd">        :meth:`RunEngine.halt`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__interrupter_helper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_stop_coro</span><span class="p">())</span></div>


    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_stop_coro</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">is_idle</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TransitionError</span><span class="p">(</span><span class="s2">&quot;RunEngine is already idle.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Stopping: running cleanup and marking exit_status as &#39;success&#39;...&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_interrupted</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">was_paused</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="s2">&quot;paused&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="s2">&quot;stopping&quot;</span>
        <span class="k">if</span> <span class="n">was_paused</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_lock</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_exception</span> <span class="o">=</span> <span class="n">RequestStop</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_returns_result</span><span class="p">:</span>
            <span class="n">plan_return</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NO_PLAN_RETURN</span>
            <span class="n">run_engine_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_result</span><span class="p">(</span><span class="n">plan_return</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">run_engine_result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uids</span><span class="p">)</span>

<div class="viewcode-block" id="RunEngine.halt">
<a class="viewcode-back" href="../../generated/bluesky.run_engine.RunEngine.halt.html#bluesky.run_engine.RunEngine.halt">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">halt</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop the running plan and do not allow the plan a chance to clean up.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        uids : tuple</span>
<span class="sd">            list of uids (i.e. RunStart Document uids) of run(s)</span>
<span class="sd">            if :attr:`RunEngine._call_returns_result` is ``False``</span>
<span class="sd">        result : :class:`RunEngineResult`</span>
<span class="sd">            if :attr:`RunEngine._call_returns_result` is ``True``</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :meth:`RunEngine.abort`</span>
<span class="sd">        :meth:`RunEngine.stop`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">__interrupter_helper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_halt_coro</span><span class="p">())</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">__interrupter_helper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">coro</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">state</span> <span class="o">==</span> <span class="s2">&quot;panicked&quot;</span><span class="p">:</span>
            <span class="n">coro</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;The RunEngine is panicked and cannot be recovered. You must restart bluesky.&quot;</span><span class="p">)</span>

        <span class="n">coro_event</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Event</span><span class="p">()</span>
        <span class="n">task</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">end_cb</span><span class="p">(</span><span class="n">fut</span><span class="p">):</span>
            <span class="n">coro_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">start_task</span><span class="p">():</span>
            <span class="k">nonlocal</span> <span class="n">task</span>
            <span class="n">task</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">coro</span><span class="p">)</span>
            <span class="n">task</span><span class="o">.</span><span class="n">add_done_callback</span><span class="p">(</span><span class="n">end_cb</span><span class="p">)</span>

        <span class="n">was_paused</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="s2">&quot;paused&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="o">.</span><span class="n">call_soon_threadsafe</span><span class="p">(</span><span class="n">start_task</span><span class="p">)</span>
        <span class="n">coro_event</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">was_paused</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_resume_task</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">task</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_halt_coro</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">is_idle</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">TransitionError</span><span class="p">(</span><span class="s2">&quot;RunEngine is already idle.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Halting: skipping cleanup and marking exit_status as &#39;abort&#39;...&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_destroy_open_run_tracing_spans</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_interrupted</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">was_paused</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="s2">&quot;paused&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="s2">&quot;halting&quot;</span>
        <span class="k">if</span> <span class="n">was_paused</span><span class="p">:</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_lock</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_exception</span> <span class="o">=</span> <span class="n">PlanHalt</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_exit_status</span> <span class="o">=</span> <span class="s2">&quot;abort&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_call_returns_result</span><span class="p">:</span>
            <span class="n">plan_return</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NO_PLAN_RETURN</span>
            <span class="n">run_engine_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_result</span><span class="p">(</span><span class="n">plan_return</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">run_engine_result</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">tuple</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uids</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_stop_movable_objects</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="s2">&quot;Call obj.stop() for all objects we have moved. Log any exceptions.&quot;</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_movable_objs_touched</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Stoppable</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">await</span> <span class="n">maybe_await</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">stop</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="n">success</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed to stop </span><span class="si">%r</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;No &#39;stop&#39; method available on </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_destroy_open_run_tracing_spans</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_run_tracing_spans</span><span class="p">):</span>
            <span class="n">_span</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_tracing_spans</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">_span</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;exit_status&quot;</span><span class="p">,</span> <span class="s2">&quot;aborted&quot;</span><span class="p">)</span>
            <span class="n">_span</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Pull messages from the plan, process them, send results back.</span>

<span class="sd">        Upon exit, clean up.</span>
<span class="sd">        - Call stop() on all objects that were &#39;set&#39; or &#39;kickoff&#39;.</span>
<span class="sd">        - Try to collect any uncollected flyers.</span>
<span class="sd">        - Try to unstage any devices left staged by the plan.</span>
<span class="sd">        - Try to remove any monitoring subscriptions left on by the plan.</span>
<span class="sd">        - If interrupting the middle of a run, try to emit a RunStop document.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_permit</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="c1"># grab the current task.  We need to do this here because the</span>
        <span class="c1"># object returned by `run_coroutine_threadsafe` is a future</span>
        <span class="c1"># that acts as a proxy that does not have the correct behavior</span>
        <span class="c1"># when `.cancel` is called on it.</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_lock</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_task</span> <span class="o">=</span> <span class="n">current_task</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">)</span>
        <span class="n">stashed_exception</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">debug</span> <span class="o">=</span> <span class="n">msg_logger</span><span class="o">.</span><span class="n">debug</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reason</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="c1"># sentinel to decide if need to add to the response stack or not</span>
        <span class="n">sentinel</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>
        <span class="n">plan_return</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">NO_PLAN_RETURN</span>
        <span class="n">exit_reason</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="s2">&quot;running&quot;</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;pausing&quot;</span><span class="p">,</span> <span class="s2">&quot;suspending&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">resumable</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_run_permit</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
                        <span class="n">stashed_exception</span> <span class="o">=</span> <span class="n">FailedPause</span><span class="p">()</span>

                        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="s2">&quot;aborting&quot;</span>
                        <span class="k">continue</span>
                <span class="c1"># currently only using &#39;suspending&#39; to get us into the</span>
                <span class="c1"># block above, we do not have a &#39;suspended&#39; state</span>
                <span class="c1"># (yet)</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="s2">&quot;suspending&quot;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="s2">&quot;running&quot;</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_permit</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
                    <span class="c1"># A pause has been requested. First, put everything in a</span>
                    <span class="c1"># resting state.</span>
                    <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="s2">&quot;pausing&quot;</span>
                    <span class="c1"># Remove any monitoring callbacks, but keep refs in</span>
                    <span class="c1"># self._monitor_params to re-instate them later.</span>
                    <span class="k">for</span> <span class="n">current_run</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_bundlers</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                        <span class="k">await</span> <span class="n">current_run</span><span class="o">.</span><span class="n">suspend_monitors</span><span class="p">()</span>
                    <span class="c1"># During pause, all motors should be stopped. Call stop()</span>
                    <span class="c1"># on every object we ever set().</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_movable_objects</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="c1"># Notify Devices of the pause in case they want to</span>
                    <span class="c1"># clean up.</span>
                    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_objs_seen</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Pausable</span><span class="p">):</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="k">await</span> <span class="n">maybe_await</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">pause</span><span class="p">())</span>
                            <span class="k">except</span> <span class="n">NoReplayAllowed</span><span class="p">:</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_reset_checkpoint_state_meth</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="s2">&quot;paused&quot;</span>
                    <span class="c1"># Let RunEngine.__call__ return...</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_blocking_event</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>

                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_permit</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
                    <span class="c1"># Restore any monitors</span>
                    <span class="k">for</span> <span class="n">current_run</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_bundlers</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                        <span class="k">await</span> <span class="n">current_run</span><span class="o">.</span><span class="n">restore_monitors</span><span class="p">()</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="s2">&quot;paused&quot;</span><span class="p">:</span>
                        <span class="c1"># may be called by &#39;resume&#39;, &#39;stop&#39;, &#39;abort&#39;, &#39;halt&#39;</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="s2">&quot;running&quot;</span>

                    <span class="c1"># If we are here, we have come back to life either to</span>
                    <span class="c1"># continue (resume) or to clean up before exiting.</span>

                <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_response_stack</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_plan_stack</span><span class="p">)</span>
                <span class="c1"># set resp to the sentinel so that if we fail in the sleep</span>
                <span class="c1"># we do not add an extra response</span>
                <span class="n">resp</span> <span class="o">=</span> <span class="n">sentinel</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># the new response to be added</span>
                    <span class="n">new_response</span> <span class="o">=</span> <span class="kc">None</span>

                    <span class="c1"># This &#39;await&#39; must be here to ensure that this coroutine</span>
                    <span class="c1"># breaks out of its current behavior before trying to get</span>
                    <span class="c1"># the next message from the top of the generator stack in</span>
                    <span class="c1"># case there has been a pause requested.  Without this the</span>
                    <span class="c1"># next message after the pause may be processed first on</span>
                    <span class="c1"># resume (instead of the first message in self._msg_cache).</span>
                    <span class="c1"># This await also gives the co-routine for requesting</span>
                    <span class="c1"># suspends a chance to run.</span>

                    <span class="c1"># This sleep has to be inside of this try block so that any</span>
                    <span class="c1"># of the &#39;async&#39; exceptions get thrown in the correct</span>
                    <span class="c1"># place.</span>

                    <span class="c1"># If we are handling an exception, then burn through the</span>
                    <span class="c1"># current plan stack before rather than allowing a pause or</span>
                    <span class="c1"># suspension to try and finish firing.</span>
                    <span class="k">if</span> <span class="n">stashed_exception</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_loop_for_kwargs</span><span class="p">)</span>
                    <span class="c1"># always pop off a result, we are either sending it back in</span>
                    <span class="c1"># or throwing an exception in, in either case the left hand</span>
                    <span class="c1"># side of the yield in the plan will be moved past</span>
                    <span class="n">resp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="c1"># if any status tasks have failed, grab the exceptions.</span>
                    <span class="c1"># give priority to things pushed in from outside</span>
                    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_lock</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exception</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">stashed_exception</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exception</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_exception</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="c1"># The case where we have a stashed exception</span>
                    <span class="k">if</span> <span class="n">stashed_exception</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resp</span><span class="p">,</span> <span class="ne">Exception</span><span class="p">):</span>
                        <span class="c1"># throw the exception at the current plan</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plan_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">throw</span><span class="p">(</span><span class="n">stashed_exception</span> <span class="ow">or</span> <span class="n">resp</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="c1"># The current plan did not handle it,</span>
                            <span class="c1"># maybe the next plan (if any) would like</span>
                            <span class="c1"># to try</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_plan_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                            <span class="c1"># we have killed the current plan, do not give</span>
                            <span class="c1"># it a new response</span>
                            <span class="n">resp</span> <span class="o">=</span> <span class="n">sentinel</span>
                            <span class="c1"># If there is at least one plan left in the stack,</span>
                            <span class="c1"># stash the new exception go back to top</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_plan_stack</span><span class="p">):</span>
                                <span class="n">stashed_exception</span> <span class="o">=</span> <span class="n">e</span>
                                <span class="k">continue</span>
                            <span class="c1"># no plans left and still an unhandled exception</span>
                            <span class="c1"># re-raise to exit the infinite loop</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">raise</span>
                        <span class="c1"># clear the stashed exception, the top plan</span>
                        <span class="c1"># handled it.</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">stashed_exception</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="c1"># The normal case of clean operation</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plan_stack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">resp</span><span class="p">)</span>
                        <span class="c1"># We have exhausted the top generator</span>
                        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
                            <span class="c1"># pop the dead generator go back to the top</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_plan_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                            <span class="c1"># we have killed the current plan, do not give</span>
                            <span class="c1"># it a new response</span>
                            <span class="n">resp</span> <span class="o">=</span> <span class="n">sentinel</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_plan_stack</span><span class="p">):</span>
                                <span class="k">continue</span>
                            <span class="c1"># or reraise to get out of the infinite loop</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">raise</span>
                        <span class="c1"># Any other exception that comes out of the plan</span>
                        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                            <span class="c1"># pop the dead plan, stash the exception and</span>
                            <span class="c1"># go to the top of the loop</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_plan_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                            <span class="c1"># we have killed the current plan, do not give</span>
                            <span class="c1"># it a new response</span>
                            <span class="n">resp</span> <span class="o">=</span> <span class="n">sentinel</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_plan_stack</span><span class="p">):</span>
                                <span class="n">stashed_exception</span> <span class="o">=</span> <span class="n">e</span>
                                <span class="k">continue</span>
                            <span class="c1"># or reraise to get out of the infinite loop</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="k">raise</span>

                    <span class="c1"># if we have a message hook, call it</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">msg_hook</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">msg_hook</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                    <span class="n">debug</span><span class="p">(</span>
                        <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">(</span><span class="si">%r</span><span class="s2">, *</span><span class="si">%r</span><span class="s2"> **</span><span class="si">%r</span><span class="s2">, run=</span><span class="si">%r</span><span class="s2">)&quot;</span><span class="p">,</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">command</span><span class="p">,</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">args</span><span class="p">,</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">kwargs</span><span class="p">,</span>
                        <span class="n">msg</span><span class="o">.</span><span class="n">run</span><span class="p">,</span>
                        <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;msg_command&quot;</span><span class="p">:</span> <span class="n">msg</span><span class="o">.</span><span class="n">command</span><span class="p">},</span>
                    <span class="p">)</span>

                    <span class="c1"># update the running set of all objects we have seen</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_objs_seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">obj</span><span class="p">)</span>

                    <span class="c1"># if this message can be cached for rewinding, cache it</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_msg_cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
                        <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rewindable_flag</span>
                        <span class="ow">and</span> <span class="n">msg</span><span class="o">.</span><span class="n">command</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_UNCACHEABLE_COMMANDS</span>
                    <span class="p">):</span>
                        <span class="c1"># We have a checkpoint.</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_msg_cache</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                    <span class="c1"># try to look up the coroutine to execute the command</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">coro</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_command_registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">command</span><span class="p">,</span> <span class="n">key_absence_sentinel</span> <span class="o">:=</span> <span class="nb">object</span><span class="p">())</span>
                    <span class="p">)</span> <span class="ow">is</span> <span class="n">key_absence_sentinel</span><span class="p">:</span>
                        <span class="c1"># flag invalid command</span>
                        <span class="c1"># and return to the top of the loop</span>
                        <span class="n">new_response</span> <span class="o">=</span> <span class="n">InvalidCommand</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">command</span><span class="p">)</span>
                        <span class="k">continue</span>

                    <span class="c1"># try to finally run the command the user asked for</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># this is one of two places that &#39;async&#39;</span>
                        <span class="c1"># exceptions (coming in via throw) can be</span>
                        <span class="c1"># raised</span>
                        <span class="n">new_response</span> <span class="o">=</span> <span class="k">await</span> <span class="n">coro</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

                    <span class="c1"># special case `CancelledError` and let the outer</span>
                    <span class="c1"># exception block deal with it.</span>
                    <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">:</span>
                        <span class="k">raise</span>
                    <span class="c1"># any other exception, stash it and go to the top of loop</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">new_response</span> <span class="o">=</span> <span class="n">e</span>
                        <span class="k">continue</span>
                    <span class="c1"># normal use, if it runs cleanly, stash the response and</span>
                    <span class="c1"># go to the top of the loop</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">continue</span>

                <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                    <span class="c1"># This only happens if some external code captures SIGINT</span>
                    <span class="c1"># -- overriding the RunEngine -- and then raises instead</span>
                    <span class="c1"># of (properly) calling the RunEngine&#39;s handler.</span>
                    <span class="c1"># See https://github.com/NSLS-II/bluesky/pull/242</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;An unknown external library has improperly raised &quot;</span>
                        <span class="s2">&quot;KeyboardInterrupt. Intercepting and triggering &quot;</span>
                        <span class="s2">&quot;a HALT.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_halt_coro</span><span class="p">()</span>
                <span class="k">except</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="s2">&quot;pausing&quot;</span><span class="p">:</span>
                        <span class="c1"># if we got a CancelledError and we are in the</span>
                        <span class="c1"># &#39;pausing&#39; state clear the run permit and</span>
                        <span class="c1"># bounce to the top</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_run_permit</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;halting&quot;</span><span class="p">,</span> <span class="s2">&quot;stopping&quot;</span><span class="p">,</span> <span class="s2">&quot;aborting&quot;</span><span class="p">):</span>
                        <span class="c1"># if we got this while just keep going in tear-down</span>
                        <span class="n">exception_map</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;halting&quot;</span><span class="p">:</span> <span class="n">PlanHalt</span><span class="p">,</span> <span class="s2">&quot;stopping&quot;</span><span class="p">:</span> <span class="n">RequestStop</span><span class="p">,</span> <span class="s2">&quot;aborting&quot;</span><span class="p">:</span> <span class="n">RequestAbort</span><span class="p">}</span>
                        <span class="c1"># if the exception is not set bounce to the top</span>
                        <span class="k">if</span> <span class="n">stashed_exception</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">stashed_exception</span> <span class="o">=</span> <span class="n">exception_map</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">state</span><span class="p">]</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">==</span> <span class="s2">&quot;suspending&quot;</span><span class="p">:</span>
                        <span class="c1"># just bounce to the top</span>
                        <span class="k">continue</span>
                    <span class="c1"># if we are handling this twice, raise and leave the plans</span>
                    <span class="c1"># alone</span>
                    <span class="k">if</span> <span class="n">stashed_exception</span> <span class="ow">is</span> <span class="n">e</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">e</span>
                    <span class="c1"># the case where FailedPause, RequestAbort or a coro</span>
                    <span class="c1"># raised error is not already stashed in _exception</span>
                    <span class="k">if</span> <span class="n">stashed_exception</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">stashed_exception</span> <span class="o">=</span> <span class="n">e</span>
                <span class="k">finally</span><span class="p">:</span>
                    <span class="c1"># if we poped a response and did not pop a plan, we need</span>
                    <span class="c1"># to put the new response back on the stack</span>
                    <span class="k">if</span> <span class="n">resp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">sentinel</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_response_stack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_response</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">StopIteration</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exit_status</span> <span class="o">=</span> <span class="s2">&quot;success&quot;</span>
            <span class="n">plan_return</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">value</span>
            <span class="c1"># TODO Is the sleep here necessary?</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_loop_for_kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">RequestStop</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exit_status</span> <span class="o">=</span> <span class="s2">&quot;success&quot;</span>
            <span class="c1"># TODO Is the sleep here necessary?</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_loop_for_kwargs</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">FailedPause</span><span class="p">,</span> <span class="n">RequestAbort</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">,</span> <span class="n">PlanHalt</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exit_status</span> <span class="o">=</span> <span class="s2">&quot;abort&quot;</span>
            <span class="c1"># TODO Is the sleep here necessary?</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_loop_for_kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Run aborted&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">GeneratorExit</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exit_status</span> <span class="o">=</span> <span class="s2">&quot;fail&quot;</span>  <span class="c1"># Exception raises during &#39;running&#39;</span>
            <span class="n">exit_reason</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span> <span class="kn">from</span><span class="w"> </span><span class="nn">err</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_exit_status</span> <span class="o">=</span> <span class="s2">&quot;fail&quot;</span>  <span class="c1"># Exception raises during &#39;running&#39;</span>
            <span class="n">exit_reason</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Run aborted&quot;</span><span class="p">)</span>
            <span class="k">raise</span> <span class="n">err</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">exit_reason</span><span class="p">:</span>
                <span class="n">exit_reason</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reason</span>
            <span class="c1"># Some done_callbacks may still be alive in other threads.</span>
            <span class="c1"># Block them from creating new &#39;failed status&#39; tasks on the loop.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pardon_failures</span><span class="o">.</span><span class="n">set</span><span class="p">()</span>
            <span class="c1"># call stop() on every movable object we ever set()</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_stop_movable_objects</span><span class="p">(</span><span class="n">success</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">current_run</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_bundlers</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="c1"># Clear any uncleared monitoring callbacks.</span>
                <span class="n">current_run</span><span class="o">.</span><span class="n">clear_monitors</span><span class="p">()</span>
                <span class="c1"># Try to collect any flyers that were kicked off but</span>
                <span class="c1"># not finished.  Some might not support partial</span>
                <span class="c1"># collection. We swallow errors.</span>
                <span class="k">await</span> <span class="n">current_run</span><span class="o">.</span><span class="n">backstop_collect</span><span class="p">()</span>
            <span class="c1"># in case we were interrupted between &#39;stage&#39; and &#39;unstage&#39;</span>
            <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_staged</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">obj</span><span class="o">.</span><span class="n">unstage</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed to unstage </span><span class="si">%r</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_staged</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="c1"># Emit RunStop if necessary.</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">current_run</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_bundlers</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">current_run</span><span class="o">.</span><span class="n">run_is_open</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">await</span> <span class="n">current_run</span><span class="o">.</span><span class="n">close_run</span><span class="p">(</span>
                            <span class="n">Msg</span><span class="p">(</span><span class="s2">&quot;close_run&quot;</span><span class="p">,</span> <span class="n">exit_status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_exit_status</span><span class="p">,</span> <span class="n">reason</span><span class="o">=</span><span class="n">exit_reason</span><span class="p">,</span> <span class="n">run_id</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Failed to close run </span><span class="si">%r</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">current_run</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_run_bundlers</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plan_stack</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The plan </span><span class="si">{</span><span class="n">p</span><span class="si">!r}</span><span class="s2"> tried to yield a value on close.  Please fix your plan.&quot;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_state</span> <span class="o">=</span> <span class="s2">&quot;idle&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Cleaned up from plan </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plan</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">stashed_exception</span><span class="p">,</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">CancelledError</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">stashed_exception</span>
        <span class="k">return</span> <span class="n">plan_return</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_wait_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Instruct the RunEngine to wait for futures and return the resulting tasks.</span>

<span class="sd">        Expected message object is:</span>

<span class="sd">            Msg(&#39;wait_for&#39;, None, awaitable_factories, **kwargs)</span>

<span class="sd">        The keyword arguments will be passed through to `asyncio.wait`.</span>

<span class="sd">        The callables in awaitable_factories must have the signature ::</span>

<span class="sd">           def fut_fac() -&gt; awaitable:</span>
<span class="sd">               &#39;This must work multiple times&#39;</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="p">(</span><span class="n">futs</span><span class="p">,)</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">args</span>
        <span class="n">futs</span> <span class="o">=</span> <span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span><span class="n">f</span><span class="p">())</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">futs</span><span class="p">]</span>
        <span class="n">completed</span><span class="p">,</span> <span class="n">pending</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">futs</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_loop_for_kwargs</span><span class="p">,</span> <span class="o">**</span><span class="n">msg</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pending</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">WaitForTimeoutError</span><span class="p">(</span><span class="s2">&quot;Plan failed to complete in the specified time&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">futs</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_open_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Instruct the RunEngine to start a new &quot;run&quot;</span>

<span class="sd">        Expected message object is:</span>

<span class="sd">            Msg(&#39;open_run&#39;, None, **kwargs)</span>

<span class="sd">        where **kwargs are any additional metadata that should go into</span>
<span class="sd">        the RunStart document</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_span</span> <span class="o">=</span> <span class="n">tracer</span><span class="o">.</span><span class="n">start_span</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_SPAN_NAME_PREFIX</span><span class="si">}</span><span class="s2"> run&quot;</span><span class="p">)</span>
        <span class="n">_set_span_msg_attributes</span><span class="p">(</span><span class="n">_span</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_run_tracing_spans</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_span</span><span class="p">)</span>

        <span class="c1"># TODO extract this from the Msg</span>
        <span class="n">run_key</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">run</span>
        <span class="k">if</span> <span class="n">run_key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_bundlers</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">IllegalMessageSequence</span><span class="p">(</span><span class="s2">&quot;A &#39;close_run&#39; message was not received before the &#39;open_run&#39; message&quot;</span><span class="p">)</span>

        <span class="c1"># Run scan_id calculation method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="s2">&quot;scan_id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="k">await</span> <span class="n">maybe_await</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scan_id_source</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">md</span><span class="p">))</span>

        <span class="c1"># For metadata below, info about plan passed to self.__call__ for.</span>
        <span class="n">plan_type</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_plan</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">plan_name</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_plan</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="c1"># Combine metadata, in order of decreasing precedence:</span>
        <span class="n">md</span> <span class="o">=</span> <span class="n">ChainMap</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_per_call</span><span class="p">,</span>  <span class="c1"># from kwargs to self.__call__</span>
            <span class="n">msg</span><span class="o">.</span><span class="n">kwargs</span><span class="p">,</span>  <span class="c1"># from &#39;open_run&#39; Msg</span>
            <span class="p">{</span>
                <span class="s2">&quot;plan_type&quot;</span><span class="p">:</span> <span class="n">plan_type</span><span class="p">,</span>  <span class="c1"># computed from self._plan</span>
                <span class="s2">&quot;plan_name&quot;</span><span class="p">:</span> <span class="n">plan_name</span><span class="p">,</span>
            <span class="p">},</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">md</span><span class="p">,</span>
        <span class="p">)</span>  <span class="c1"># stateful, persistent metadata</span>
        <span class="c1"># The metadata is final. Validate it now, at the last moment.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">md_validator</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">md</span><span class="p">))</span>

        <span class="c1"># Apply normalizer at the same level of the validator</span>
        <span class="n">validated</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">md_normalizer</span><span class="p">(</span><span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">md</span><span class="p">))</span>

        <span class="n">current_run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_bundlers</span><span class="p">[</span><span class="n">run_key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">RunBundler</span><span class="p">(</span>
            <span class="n">validated</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">record_interruptions</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emit_sync</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">,</span>
            <span class="n">strict_pre_declare</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_require_stream_declaration</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">new_uid</span> <span class="o">=</span> <span class="k">await</span> <span class="n">current_run</span><span class="o">.</span><span class="n">open_run</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_run_start_uids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_uid</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">new_uid</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_close_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Instruct the RunEngine to write the RunStop document</span>

<span class="sd">        Expected message object is:</span>

<span class="sd">            Msg(&#39;close_run&#39;, None, exit_status=None, reason=None)</span>

<span class="sd">        if *exit_stats* and *reason* are not provided, use the values</span>
<span class="sd">        stashed on the RE.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO extract this from the Msg</span>
        <span class="n">run_key</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">run</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">current_run</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_bundlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">run_key</span><span class="p">,</span> <span class="n">key_absence_sentinel</span> <span class="o">:=</span> <span class="nb">object</span><span class="p">)</span>
        <span class="p">)</span> <span class="ow">is</span> <span class="n">key_absence_sentinel</span><span class="p">:</span>
            <span class="n">ims_msg</span> <span class="o">=</span> <span class="s2">&quot;A &#39;close_run&#39; message was not received before the &#39;open_run&#39; message&quot;</span>
            <span class="k">raise</span> <span class="n">IllegalMessageSequence</span><span class="p">(</span><span class="n">ims_msg</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="k">await</span> <span class="n">current_run</span><span class="o">.</span><span class="n">close_run</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_bundlers</span><span class="p">[</span><span class="n">run_key</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_close_run_trace</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_close_run_trace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Msg</span><span class="p">):</span>
        <span class="n">exit_status</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;exit_status&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exit_status</span><span class="p">)</span>
        <span class="n">reason</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;reason&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reason</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">_span</span><span class="p">:</span> <span class="n">Span</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_tracing_spans</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">_span</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;exit_status&quot;</span><span class="p">,</span> <span class="n">exit_status</span><span class="p">)</span>
            <span class="n">_span</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;reason&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="p">)</span>
            <span class="n">_span</span><span class="o">.</span><span class="n">end</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;No open traces left to close!&quot;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_create</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trigger the run engine to start bundling future obj.read() calls for</span>
<span class="sd">         an Event document</span>

<span class="sd">        Expected message object is:</span>

<span class="sd">            Msg(&#39;create&#39;, None, name=&#39;primary&#39;)</span>
<span class="sd">            Msg(&#39;create&#39;, name=&#39;primary&#39;)</span>

<span class="sd">        Note that the `name` kwarg will be the &#39;name&#39; field of the resulting</span>
<span class="sd">        descriptor. So descriptor[&#39;name&#39;] = msg.kwargs[&#39;name&#39;].</span>

<span class="sd">        Also note that changing the &#39;name&#39; of the Event will create a new</span>
<span class="sd">        Descriptor document.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">run_key</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">run</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">current_run</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_bundlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">run_key</span><span class="p">,</span> <span class="n">key_absence_sentinel</span> <span class="o">:=</span> <span class="nb">object</span><span class="p">())</span>
        <span class="p">)</span> <span class="ow">is</span> <span class="n">key_absence_sentinel</span><span class="p">:</span>
            <span class="n">ims_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Cannot bundle readings without an open run. That is, &#39;create&#39; must be preceded by &#39;open_run&#39;.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">IllegalMessageSequence</span><span class="p">(</span><span class="n">ims_msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">current_run</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_declare_stream</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Trigger the run engine to start bundling future obj.describe() calls for</span>
<span class="sd">         an Event document</span>

<span class="sd">        Expected message object is:</span>

<span class="sd">            Msg(&#39;declare_stream&#39;, None, name=&#39;primary&#39;)</span>
<span class="sd">            Msg(&#39;declare_stream&#39;, name=&#39;primary&#39;)</span>
<span class="sd">            Msg(&#39;create&#39;, name=&#39;primary&#39;, collect=True)</span>

<span class="sd">        Note that the `name` kwarg will be the &#39;name&#39; field of the resulting</span>
<span class="sd">        descriptor. So descriptor[&#39;name&#39;] = msg.kwargs[&#39;name&#39;].</span>

<span class="sd">        If `collect` is set to True (default false) then `describe_collect` will be called</span>
<span class="sd">        on declare_stream, rather than `describe`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">run_key</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">run</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">current_run</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_bundlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">run_key</span><span class="p">,</span> <span class="n">key_absence_sentinel</span> <span class="o">:=</span> <span class="nb">object</span><span class="p">())</span>
        <span class="p">)</span> <span class="ow">is</span> <span class="n">key_absence_sentinel</span><span class="p">:</span>
            <span class="n">ims_msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="s2">&quot;Cannot bundle readings without an open run. That is, &#39;create&#39; must be preceded by &#39;open_run&#39;.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="n">IllegalMessageSequence</span><span class="p">(</span><span class="n">ims_msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">current_run</span><span class="o">.</span><span class="n">declare_stream</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a reading to the open event bundle.</span>

<span class="sd">        Expected message object is:</span>

<span class="sd">            Msg(&#39;read&#39;, obj)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">check_supports</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">Readable</span><span class="p">)</span>
        <span class="c1"># actually _read_ the object</span>
        <span class="n">warn_if_msg_args_or_kwargs</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">read</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="k">await</span> <span class="n">maybe_await</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="o">*</span><span class="n">msg</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">msg</span><span class="o">.</span><span class="n">kwargs</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The read of </span><span class="si">{</span><span class="n">obj</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2"> returned None. &quot;</span>
                <span class="s2">&quot;This is a bug in your object implementation, &quot;</span>
                <span class="s2">&quot;`read` must return a dictionary.&quot;</span>
            <span class="p">)</span>
        <span class="n">run_key</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">run</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">current_run</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_bundlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">run_key</span><span class="p">,</span> <span class="n">key_absence_sentinel</span> <span class="o">:=</span> <span class="nb">object</span><span class="p">())</span>
        <span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">key_absence_sentinel</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">current_run</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ret</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_locate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Locate some Movables and return their locations.</span>

<span class="sd">        Expected message object is:</span>

<span class="sd">            Msg(&#39;locate&#39;, obj1, ..., objn, squeeze=True)</span>

<span class="sd">        If a single obj is passed, obj.locate() is returned. If multiple objs</span>
<span class="sd">        are passed, obj.locate() is called in parallel for all objs and a list</span>
<span class="sd">        of the results returned. If squeeze is supplied and is False then it</span>
<span class="sd">        will always return a list of results even with a single object.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">objs</span> <span class="o">=</span> <span class="p">[</span><span class="n">check_supports</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Locatable</span><span class="p">)</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">obj</span><span class="p">,)</span> <span class="o">+</span> <span class="n">msg</span><span class="o">.</span><span class="n">args</span><span class="p">]</span>
        <span class="c1"># actually _locate_ the objects</span>
        <span class="n">coros</span> <span class="o">=</span> <span class="p">[</span><span class="n">maybe_await</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">locate</span><span class="p">())</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objs</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">coros</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="n">msg</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;squeeze&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="k">return</span> <span class="k">await</span> <span class="n">coros</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">coros</span><span class="p">))</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_monitor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Monitor a signal. Emit event documents asynchronously.</span>

<span class="sd">        A descriptor document is emitted immediately. Then, a closure is</span>
<span class="sd">        defined that emits Event documents associated with that descriptor</span>
<span class="sd">        from a separate thread. This process is not related to the main</span>
<span class="sd">        bundling process (create/read/save).</span>

<span class="sd">        Expected message object is:</span>

<span class="sd">            Msg(&#39;monitor&#39;, obj, **kwargs)</span>
<span class="sd">            Msg(&#39;monitor&#39;, obj, name=&#39;event-stream-name&#39;, **kwargs)</span>

<span class="sd">        where kwargs are passed through to ``obj.subscribe()``</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">run_key</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">run</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">current_run</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_bundlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">run_key</span><span class="p">,</span> <span class="n">key_absence_sentinel</span> <span class="o">:=</span> <span class="nb">object</span><span class="p">())</span>
        <span class="p">)</span> <span class="ow">is</span> <span class="n">key_absence_sentinel</span><span class="p">:</span>
            <span class="n">ims_msg</span> <span class="o">=</span> <span class="s2">&quot;A &#39;monitor&#39; message was sent but no run is open.&quot;</span>
            <span class="k">raise</span> <span class="n">IllegalMessageSequence</span><span class="p">(</span><span class="n">ims_msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">current_run</span><span class="o">.</span><span class="n">monitor</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reset_checkpoint_state_coro</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_unmonitor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop monitoring; i.e., remove the callback emitting event documents.</span>

<span class="sd">        Expected message object is:</span>

<span class="sd">            Msg(&#39;unmonitor&#39;, obj)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">run_key</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">run</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">current_run</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_bundlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">run_key</span><span class="p">,</span> <span class="n">key_absence_sentinel</span> <span class="o">:=</span> <span class="nb">object</span><span class="p">())</span>
        <span class="p">)</span> <span class="ow">is</span> <span class="n">key_absence_sentinel</span><span class="p">:</span>
            <span class="n">ims_msg</span> <span class="o">=</span> <span class="s2">&quot;An &#39;unmonitor&#39; message was sent but no run is open.&quot;</span>
            <span class="k">raise</span> <span class="n">IllegalMessageSequence</span><span class="p">(</span><span class="n">ims_msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">current_run</span><span class="o">.</span><span class="n">unmonitor</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reset_checkpoint_state_coro</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Save the event that is currently being bundled</span>

<span class="sd">        Expected message object is:</span>

<span class="sd">            Msg(&#39;save&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">run_key</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">run</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">current_run</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_bundlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">run_key</span><span class="p">,</span> <span class="n">key_absence_sentinel</span> <span class="o">:=</span> <span class="nb">object</span><span class="p">())</span>
        <span class="p">)</span> <span class="ow">is</span> <span class="n">key_absence_sentinel</span><span class="p">:</span>
            <span class="c1"># sanity check -- this should be caught by &#39;create&#39; which makes</span>
            <span class="c1"># this code path impossible</span>
            <span class="n">ims_msg</span> <span class="o">=</span> <span class="s2">&quot;A &#39;save&#39; message was sent but no run is open.&quot;</span>
            <span class="k">raise</span> <span class="n">IllegalMessageSequence</span><span class="p">(</span><span class="n">ims_msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">current_run</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_drop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Drop the event that is currently being bundled</span>

<span class="sd">        Expected message object is:</span>

<span class="sd">            Msg(&#39;drop&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">run_key</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">run</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">current_run</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_bundlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">run_key</span><span class="p">,</span> <span class="n">key_absence_sentinel</span> <span class="o">:=</span> <span class="nb">object</span><span class="p">())</span>
        <span class="p">)</span> <span class="ow">is</span> <span class="n">key_absence_sentinel</span><span class="p">:</span>
            <span class="n">ims_msg</span> <span class="o">=</span> <span class="s2">&quot;A &#39;drop&#39; message was sent but no run is open.&quot;</span>
            <span class="k">raise</span> <span class="n">IllegalMessageSequence</span><span class="p">(</span><span class="n">ims_msg</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">current_run</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_prepare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Prepare a flyer for a flyscan</span>

<span class="sd">        Expected message object is:</span>

<span class="sd">        If `flyer_object` obeys the Preparable protocol, it should have a .prepare</span>
<span class="sd">        method that takes an argument to be set:</span>

<span class="sd">            Msg(&#39;prepare&#39;, flyer_object, value)</span>

<span class="sd">        Where value represents an initial state to move the flyer to.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">check_supports</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">Preparable</span><span class="p">)</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;group&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">prepare</span><span class="p">(</span><span class="o">*</span><span class="n">msg</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_add_status_to_group</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="n">status_object</span><span class="o">=</span><span class="n">ret</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;prepare&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_kickoff</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start a flyscan object</span>

<span class="sd">        Special kwargs for the &#39;Msg&#39; object in this function:</span>
<span class="sd">        group : str</span>
<span class="sd">            The blocking group to this flyer to</span>

<span class="sd">        Expected message object is:</span>

<span class="sd">        If `flyer_object` has a `kickoff` function that takes no arguments:</span>

<span class="sd">            Msg(&#39;kickoff&#39;, flyer_object)</span>
<span class="sd">            Msg(&#39;kickoff&#39;, flyer_object, group=&lt;name&gt;)</span>

<span class="sd">        If `flyer_object` has a `kickoff` function that takes</span>
<span class="sd">        `(start, stop, steps)` as its function arguments:</span>

<span class="sd">            Msg(&#39;kickoff&#39;, flyer_object, start, stop, step)</span>
<span class="sd">            Msg(&#39;kickoff&#39;, flyer_object, start, stop, step, group=&lt;name&gt;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">run_key</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">run</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">current_run</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_bundlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">run_key</span><span class="p">,</span> <span class="n">key_absence_sentinel</span> <span class="o">:=</span> <span class="nb">object</span><span class="p">())</span>
        <span class="p">)</span> <span class="ow">is</span> <span class="n">key_absence_sentinel</span><span class="p">:</span>
            <span class="n">ims_msg</span> <span class="o">=</span> <span class="s2">&quot;A &#39;kickoff&#39; message was sent but no run is open.&quot;</span>
            <span class="k">raise</span> <span class="n">IllegalMessageSequence</span><span class="p">(</span><span class="n">ims_msg</span><span class="p">)</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">msg</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">check_supports</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Flyable</span><span class="p">)</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;group&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">warn_if_msg_args_or_kwargs</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">kickoff</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">kickoff</span><span class="p">(</span><span class="o">*</span><span class="n">msg</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">await</span> <span class="n">current_run</span><span class="o">.</span><span class="n">kickoff</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_add_status_to_group</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="n">status_object</span><span class="o">=</span><span class="n">ret</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;kickoff&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ret</span>

    <span class="nd">@tracer</span><span class="o">.</span><span class="n">start_as_current_span</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_SPAN_NAME_PREFIX</span><span class="si">}</span><span class="s2"> complete&quot;</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Tell a flyer, &#39;stop collecting, whenever you are ready&#39;.</span>

<span class="sd">        The flyer returns a status object. Some flyers respond to this</span>
<span class="sd">        command by stopping collection and returning a finished status</span>
<span class="sd">        object immediately. Other flyers finish their given course and</span>
<span class="sd">        finish whenever they finish, irrespective of when this command is</span>
<span class="sd">        issued.</span>

<span class="sd">        Expected message object is:</span>

<span class="sd">            Msg(&#39;complete&#39;, flyer, group=&lt;GROUP&gt;)</span>

<span class="sd">        where &lt;GROUP&gt; is a hashable identifier.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_set_span_msg_attributes</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">get_current_span</span><span class="p">(),</span> <span class="n">msg</span><span class="p">)</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;group&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">check_supports</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">Flyable</span><span class="p">)</span>
        <span class="n">warn_if_msg_args_or_kwargs</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">complete</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">complete</span><span class="p">(</span><span class="o">*</span><span class="n">msg</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_add_status_to_group</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="n">status_object</span><span class="o">=</span><span class="n">ret</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;complete&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ret</span>

    <span class="nd">@tracer</span><span class="o">.</span><span class="n">start_as_current_span</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_SPAN_NAME_PREFIX</span><span class="si">}</span><span class="s2"> collect&quot;</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_collect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Collect data cached by a flyer and emit documents</span>

<span class="sd">        Expected message object is:</span>

<span class="sd">            Msg(&#39;collect&#39;, flyer_object)</span>
<span class="sd">            Msg(&#39;collect&#39;, flyer_object, stream=True, return_payload=False, name=&quot;a_name&quot;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_set_span_msg_attributes</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">get_current_span</span><span class="p">(),</span> <span class="n">msg</span><span class="p">)</span>
        <span class="n">run_key</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">run</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">current_run</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_bundlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">run_key</span><span class="p">,</span> <span class="n">key_absence_sentinel</span> <span class="o">:=</span> <span class="nb">object</span><span class="p">())</span>
        <span class="p">)</span> <span class="ow">is</span> <span class="n">key_absence_sentinel</span><span class="p">:</span>
            <span class="c1"># TODO add test exercising this path</span>
            <span class="n">ims_msg</span> <span class="o">=</span> <span class="s2">&quot;A &#39;collect&#39; message was sent but no run is open.&quot;</span>
            <span class="k">raise</span> <span class="n">IllegalMessageSequence</span><span class="p">(</span><span class="n">ims_msg</span><span class="p">)</span>

        <span class="k">return</span> <span class="k">await</span> <span class="n">current_run</span><span class="o">.</span><span class="n">collect</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_null</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A no-op message, mainly for debugging and testing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_RE_class</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        A no-op message, mainly for debugging and testing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@tracer</span><span class="o">.</span><span class="n">start_as_current_span</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_SPAN_NAME_PREFIX</span><span class="si">}</span><span class="s2"> set&quot;</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set a device and cache the returned status object.</span>

<span class="sd">        Also, note that the device has been touched so it can be stopped upon</span>
<span class="sd">        exit.</span>

<span class="sd">        Expected message object is</span>

<span class="sd">            Msg(&#39;set&#39;, obj, *args, **kwargs)</span>

<span class="sd">        where arguments are passed through to `obj.set(*args, **kwargs)`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_set_span_msg_attributes</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">get_current_span</span><span class="p">(),</span> <span class="n">msg</span><span class="p">)</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">check_supports</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">Movable</span><span class="p">)</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;group&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_movable_objs_touched</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="o">*</span><span class="n">msg</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_add_status_to_group</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="n">status_object</span><span class="o">=</span><span class="n">ret</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;set&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Trigger a device and cache the returned status object.</span>

<span class="sd">        Expected message object is:</span>

<span class="sd">            Msg(&#39;trigger&#39;, obj)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">check_supports</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">Triggerable</span><span class="p">)</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;group&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">warn_if_msg_args_or_kwargs</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">trigger</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">trigger</span><span class="p">(</span><span class="o">*</span><span class="n">msg</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_add_status_to_group</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="n">status_object</span><span class="o">=</span><span class="n">ret</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;trigger&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_call_waiting_hook</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">waiting_hook</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">waiting_hook</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@tracer</span><span class="o">.</span><span class="n">start_as_current_span</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">_SPAN_NAME_PREFIX</span><span class="si">}</span><span class="s2"> wait&quot;</span><span class="p">)</span>
    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_wait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Msg</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Block progress until every object that was triggered or set</span>
<span class="sd">        with the keyword argument `group=&lt;GROUP&gt;` is done. Returns a boolean that is</span>
<span class="sd">        true when all triggered objects are done. When the keyword argument</span>
<span class="sd">        `error_on_timeout=&lt;error_on_timeout&gt;` is false, this method can return before all objects are done</span>
<span class="sd">        after a flush period given by the `timeout=&lt;TIMEOUT&gt;` keyword argument.</span>

<span class="sd">        Expected message object is:</span>

<span class="sd">            Msg(&#39;wait&#39;, group=&lt;GROUP&gt;, error_on_timeout=&lt;ERROR_ON_TIMEOUT&gt;)</span>

<span class="sd">        where ``&lt;GROUP&gt;`` is any hashable key and ``&lt;ERROR_ON_TIMEOUT&gt;`` is a boolean.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_set_span_msg_attributes</span><span class="p">(</span><span class="n">trace</span><span class="o">.</span><span class="n">get_current_span</span><span class="p">(),</span> <span class="n">msg</span><span class="p">)</span>
        <span class="n">done</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># boolean that tracks whether waiting is complete</span>
        <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="p">(</span><span class="n">group</span><span class="p">,)</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">args</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">kwargs</span><span class="p">[</span><span class="s2">&quot;group&quot;</span><span class="p">]</span>
        <span class="n">error_on_timeout</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;error_on_timeout&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">watch</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;watch&quot;</span><span class="p">,</span> <span class="p">())</span>
        <span class="n">watch_task</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Task</span> <span class="o">|</span> <span class="kc">None</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">group</span><span class="p">:</span>
            <span class="n">trace</span><span class="o">.</span><span class="n">get_current_span</span><span class="p">()</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;group&quot;</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">trace</span><span class="o">.</span><span class="n">get_current_span</span><span class="p">()</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;no_group_given&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">futs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">group</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">futs</span><span class="p">:</span>
            <span class="n">status_objs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_status_objs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">error_on_timeout</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_seen_wait_and_move_on_keys</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_seen_wait_and_move_on_keys</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_call_waiting_hook</span><span class="p">(</span><span class="n">status_objs</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>  <span class="c1"># if error_on_timeout False</span>
                    <span class="c1"># Notify the waiting_hook function that the RunEngine is</span>
                    <span class="c1"># waiting for these status_objs to complete. Users can use</span>
                    <span class="c1"># the information these encapsulate to create a progress</span>
                    <span class="c1"># bar.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_call_waiting_hook</span><span class="p">(</span><span class="n">status_objs</span><span class="p">)</span>

                <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">wait_for_first_exception</span><span class="p">(</span><span class="n">futures</span><span class="p">:</span> <span class="nb">set</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">]:</span>
                    <span class="k">return</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wait_for</span><span class="p">(</span>
                        <span class="n">Msg</span><span class="p">(</span>
                            <span class="s2">&quot;wait_for&quot;</span><span class="p">,</span>
                            <span class="kc">None</span><span class="p">,</span>
                            <span class="n">futures</span><span class="p">,</span>
                            <span class="n">return_when</span><span class="o">=</span><span class="n">asyncio</span><span class="o">.</span><span class="n">FIRST_EXCEPTION</span><span class="p">,</span>
                            <span class="n">timeout</span><span class="o">=</span><span class="n">msg</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                        <span class="p">)</span>
                    <span class="p">)</span>

                <span class="c1"># Create the task waiting for the given group of statuses to complete</span>
                <span class="c1"># or one of them to fail</span>
                <span class="n">status_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">wait_for_first_exception</span><span class="p">(</span><span class="n">futs</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">watch</span><span class="p">:</span>
                    <span class="c1"># Create a task that waits for an exception on any watch group</span>
                    <span class="c1"># so we know whether to stop the wait early because of a watcher failure</span>
                    <span class="n">watch_futs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
                    <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="n">watch</span><span class="p">:</span>
                        <span class="n">watch_futs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_groups</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="nb">set</span><span class="p">()))</span>
                    <span class="n">watch_task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span><span class="n">wait_for_first_exception</span><span class="p">(</span><span class="n">watch_futs</span><span class="p">))</span>

                    <span class="k">def</span><span class="w"> </span><span class="nf">cancel_status_task_if_error</span><span class="p">(</span><span class="n">fut</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">[</span><span class="nb">list</span><span class="p">[</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">]]):</span>
                        <span class="c1"># If _wait_for raised an exception, or if any of the status</span>
                        <span class="c1"># objects in the watch groups failed, cancel the status_task.</span>
                        <span class="k">if</span> <span class="n">fut</span><span class="o">.</span><span class="n">exception</span><span class="p">()</span> <span class="ow">or</span> <span class="nb">any</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">exception</span><span class="p">()</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fut</span><span class="o">.</span><span class="n">result</span><span class="p">()):</span>
                            <span class="n">status_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>

                    <span class="n">watch_task</span><span class="o">.</span><span class="n">add_done_callback</span><span class="p">(</span><span class="n">cancel_status_task_if_error</span><span class="p">)</span>
                <span class="k">await</span> <span class="n">status_task</span>
            <span class="k">except</span> <span class="n">WaitForTimeoutError</span><span class="p">:</span>
                <span class="c1"># We might wait to call wait again, so put the futures and status objects back in</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">futs</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_status_objs</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">status_objs</span>
                <span class="k">if</span> <span class="n">error_on_timeout</span><span class="p">:</span>
                    <span class="k">raise</span>
            <span class="k">finally</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">watch_task</span><span class="p">:</span>
                    <span class="n">watch_task</span><span class="o">.</span><span class="n">cancel</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">error_on_timeout</span><span class="p">:</span>
                    <span class="c1"># Notify the waiting_hook function that we have moved on by</span>
                    <span class="c1"># sending it `None`. If all goes well, it could have</span>
                    <span class="c1"># inferred this from the status_obj, but there are edge</span>
                    <span class="c1"># cases.</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_call_waiting_hook</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                    <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">done</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">done</span> <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">status_objs</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">done</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_call_waiting_hook</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_seen_wait_and_move_on_keys</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">done</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="n">done</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_status_object_completed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">fut</span><span class="p">:</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">Future</span><span class="p">,</span> <span class="n">pardon_failures</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Task to run when a status object is finished.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ret : status object</span>
<span class="sd">        p_event : asyncio.Event</span>
<span class="sd">            held in the RunEngine&#39;s self._groups cache for waiting</span>
<span class="sd">        pardon_failuers : asyncio.Event</span>
<span class="sd">            tells us whether the __call__ this status object is over</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ret</span><span class="o">.</span><span class="n">success</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">pardon_failures</span><span class="o">.</span><span class="n">is_set</span><span class="p">():</span>
            <span class="c1"># TODO: need a better channel to move this information back</span>
            <span class="c1"># to the run task.</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state_lock</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">exc</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="k">raise</span> <span class="n">FailedStatus</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">exc</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_exception</span> <span class="o">=</span> <span class="n">e</span>
                    <span class="n">fut</span><span class="o">.</span><span class="n">set_exception</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fut</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_sleep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Sleep the event loop.</span>

<span class="sd">        Expected message object is:</span>

<span class="sd">            Msg(&#39;sleep&#39;, None, sleep_time)</span>

<span class="sd">        where `sleep_time` is in seconds</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="o">*</span><span class="n">msg</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_loop_for_kwargs</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_pause</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Request the run engine to pause</span>

<span class="sd">        Expected message object is:</span>

<span class="sd">            Msg(&#39;pause&#39;, defer=False, name=None, callback=None)</span>

<span class="sd">        See RunEngine.request_pause() docstring for explanation of the three</span>
<span class="sd">        keyword arguments in the `Msg` signature</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request_pause_coro</span><span class="p">(</span><span class="o">*</span><span class="n">msg</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">msg</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_resume</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Request the run engine to resume</span>

<span class="sd">        Expected message object is:</span>

<span class="sd">            Msg(&#39;resume&#39;, defer=False, name=None, callback=None)</span>

<span class="sd">        See RunEngine.resume() docstring for explanation of the three</span>
<span class="sd">        keyword arguments in the `Msg` signature</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Re-instate monitoring callbacks.</span>
        <span class="k">for</span> <span class="n">current_run</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_bundlers</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">await</span> <span class="n">current_run</span><span class="o">.</span><span class="n">restore_monitors</span><span class="p">()</span>
        <span class="c1"># Notify Devices of the resume in case they want to clean up.</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_objs_seen</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Pausable</span><span class="p">):</span>
                <span class="k">await</span> <span class="n">maybe_await</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">resume</span><span class="p">())</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Instruct the RunEngine to create a checkpoint so that we can rewind</span>
<span class="sd">        to this point if necessary</span>

<span class="sd">        Expected message object is:</span>

<span class="sd">            Msg(&#39;checkpoint&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">current_run</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_bundlers</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">current_run</span><span class="o">.</span><span class="n">bundling</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">IllegalMessageSequence</span><span class="p">(</span><span class="s2">&quot;Cannot &#39;checkpoint&#39; after &#39;create&#39; and before &#39;save&#39;. Aborting!&quot;</span><span class="p">)</span>

        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reset_checkpoint_state_coro</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deferred_pause_requested</span><span class="p">:</span>
            <span class="c1"># We are at a checkpoint; we are done deferring the pause.</span>
            <span class="c1"># Give the _check_for_signals coroutine time to look for</span>
            <span class="c1"># additional SIGINTs that would trigger an abort.</span>
            <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">_loop_for_kwargs</span><span class="p">)</span>
            <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request_pause_coro</span><span class="p">(</span><span class="n">defer</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_reset_checkpoint_state</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_checkpoint_state_meth</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_reset_checkpoint_state_meth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_msg_cache</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_msg_cache</span> <span class="o">=</span> <span class="n">deque</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">current_run</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_bundlers</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">current_run</span><span class="o">.</span><span class="n">reset_checkpoint_state</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_reset_checkpoint_state_coro</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_checkpoint_state</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_clear_checkpoint</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear a set checkpoint</span>

<span class="sd">        Expected message object is:</span>

<span class="sd">            Msg(&#39;clear_checkpoint&#39;)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># clear message cache</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_msg_cache</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="c1"># clear stashed</span>
        <span class="k">for</span> <span class="n">current_run</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_bundlers</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">await</span> <span class="n">current_run</span><span class="o">.</span><span class="n">clear_checkpoint</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_rewindable</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set rewindable state of RunEngine</span>

<span class="sd">        Expected message object is:</span>

<span class="sd">            Msg(&#39;rewindable&#39;, None, bool or None)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="p">(</span><span class="n">rw_flag</span><span class="p">,)</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">args</span>
        <span class="k">if</span> <span class="n">rw_flag</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rewindable</span> <span class="o">=</span> <span class="n">rw_flag</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">rewindable</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Configure an object</span>

<span class="sd">        Expected message object is:</span>

<span class="sd">            Msg(&#39;configure&#39;, object, *args, **kwargs)</span>

<span class="sd">        which results in this call:</span>

<span class="sd">            object.configure(*args, **kwargs)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">run_key</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">run</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="n">current_run</span> <span class="o">:=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_bundlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">run_key</span><span class="p">,</span> <span class="n">key_absence_sentinel</span> <span class="o">:=</span> <span class="nb">object</span><span class="p">())</span>
        <span class="p">)</span> <span class="ow">is</span> <span class="n">key_absence_sentinel</span><span class="p">:</span>
            <span class="n">current_run</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">elif</span> <span class="n">current_run</span><span class="o">.</span><span class="n">bundling</span><span class="p">:</span>
            <span class="n">ims_msg</span> <span class="o">=</span> <span class="s2">&quot;Cannot configure after &#39;create&#39; but before &#39;save&#39; Aborting!&quot;</span>
            <span class="k">raise</span> <span class="n">IllegalMessageSequence</span><span class="p">(</span><span class="n">ims_msg</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">msg</span>

        <span class="n">old</span><span class="p">,</span> <span class="n">new</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">current_run</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">current_run</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">old</span><span class="p">,</span> <span class="n">new</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_add_status_to_group</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span><span class="p">,</span> <span class="n">status_object</span><span class="p">:</span> <span class="n">Status</span><span class="p">,</span> <span class="n">group</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">action</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">fut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="o">.</span><span class="n">create_future</span><span class="p">()</span>
        <span class="n">pardon_failures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pardon_failures</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">done_callback</span><span class="p">(</span><span class="n">status</span><span class="p">:</span> <span class="n">Status</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;The object </span><span class="si">%r</span><span class="s2"> reports </span><span class="si">%r</span><span class="s2"> is done with status </span><span class="si">%r</span><span class="s2">.&quot;</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">status_object</span><span class="o">.</span><span class="n">success</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_loop</span><span class="o">.</span><span class="n">call_soon_threadsafe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_status_object_completed</span><span class="p">,</span> <span class="n">status_object</span><span class="p">,</span> <span class="n">fut</span><span class="p">,</span> <span class="n">pardon_failures</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">status_object</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="n">done_callback</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c1"># for ophyd &lt; v0.8.0</span>
            <span class="n">status_object</span><span class="o">.</span><span class="n">finished_cb</span> <span class="o">=</span> <span class="n">done_callback</span>  <span class="c1"># type: ignore</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_groups</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="k">lambda</span><span class="p">:</span> <span class="n">fut</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_status_objs</span><span class="p">[</span><span class="n">group</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">status_object</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_stage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Instruct the RunEngine to stage the object</span>

<span class="sd">        Expected message object is:</span>

<span class="sd">            Msg(&#39;stage&#39;, object)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">msg</span>
        <span class="c1"># If an object has no &#39;stage&#39; method, assume there is nothing to do.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Stageable</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;group&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">stage</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_staged</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>  <span class="c1"># add first in case of failure below</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reset_checkpoint_state_coro</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">Status</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">ret</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_add_status_to_group</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="n">status_object</span><span class="o">=</span><span class="n">ret</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;stage&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_unstage</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Instruct the RunEngine to unstage the object</span>

<span class="sd">        Expected message object is:</span>

<span class="sd">            Msg(&#39;unstage&#39;, object)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">msg</span>
        <span class="c1"># If an object has no &#39;unstage&#39; method, assume there is nothing to do.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Stageable</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;group&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">unstage</span><span class="p">()</span>
        <span class="c1"># use `discard()` to ignore objects that are not in the staged set.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_staged</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reset_checkpoint_state_coro</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">Status</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">ret</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_add_status_to_group</span><span class="p">(</span><span class="n">obj</span><span class="o">=</span><span class="n">obj</span><span class="p">,</span> <span class="n">status_object</span><span class="o">=</span><span class="n">ret</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="n">group</span><span class="p">,</span> <span class="n">action</span><span class="o">=</span><span class="s2">&quot;unstage&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop a device.</span>

<span class="sd">        Expected message object is:</span>

<span class="sd">            Msg(&#39;stop&#39;, obj)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">check_supports</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">Stoppable</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">maybe_await</span><span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">stop</span><span class="p">())</span>  <span class="c1"># nominally, this returns None</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_subscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add a subscription after the run has started.</span>

<span class="sd">        This, like subscriptions passed to __call__, will be removed at the</span>
<span class="sd">        end by the RunEngine.</span>

<span class="sd">        Expected message object is:</span>

<span class="sd">            Msg(&#39;subscribe&#39;, None, callback_function, document_name)</span>

<span class="sd">        where `document_name` is one of:</span>

<span class="sd">            {&#39;start&#39;, &#39;descriptor&#39;, &#39;event&#39;, &#39;stop&#39;, &#39;all&#39;}</span>

<span class="sd">        and `callback_function` is expected to have a signature of:</span>

<span class="sd">            ``f(name, document)``</span>

<span class="sd">            where name is one of the ``document_name`` options and ``document``</span>
<span class="sd">            is one of the document dictionaries in the event model.</span>

<span class="sd">        See the docstring of bluesky.run_engine.Dispatcher.subscribe() for more</span>
<span class="sd">        information.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Adding subscription </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">msg</span>
        <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_temp_callback_ids</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reset_checkpoint_state_coro</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">token</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_unsubscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove a subscription during a call -- useful for a multi-run call</span>
<span class="sd">        where subscriptions are wanted for some runs but not others.</span>

<span class="sd">        Expected message object is:</span>

<span class="sd">            Msg(&#39;unsubscribe&#39;, None, TOKEN)</span>
<span class="sd">            Msg(&#39;unsubscribe&#39;, token=TOKEN)</span>

<span class="sd">        where ``TOKEN`` is the return value from ``RunEngine._subscribe()``</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Removing subscription </span><span class="si">%r</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">msg</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">token</span> <span class="o">:=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;token&quot;</span><span class="p">,</span> <span class="n">key_absence_sentinel</span> <span class="o">:=</span> <span class="nb">object</span><span class="p">()))</span> <span class="ow">is</span> <span class="n">key_absence_sentinel</span><span class="p">:</span>
            <span class="p">(</span><span class="n">token</span><span class="p">,)</span> <span class="o">=</span> <span class="n">arg</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">unsubscribe</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_temp_callback_ids</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
        <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reset_checkpoint_state_coro</span><span class="p">()</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process a &#39;input&#39; Msg. Expected Msg:</span>

<span class="sd">            Msg(&#39;input&#39;, None)</span>
<span class="sd">            Msg(&#39;input&#39;, None, prompt=&#39;&gt;&#39;)  # customize prompt</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;prompt&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">async_input</span> <span class="o">=</span> <span class="n">AsyncInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">loop</span><span class="p">)</span>
        <span class="n">async_input</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span><span class="n">async_input</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">flush</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">return</span> <span class="k">await</span> <span class="n">async_input</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">emit_sync</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">doc</span><span class="p">):</span>
        <span class="s2">&quot;Process blocking callbacks and schedule non-blocking callbacks.&quot;</span>

        <span class="c1"># Process the doc, already validated against the schema in event-model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dispatcher</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">emit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">doc</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emit_sync</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span></div>



<div class="viewcode-block" id="Dispatcher">
<a class="viewcode-back" href="../../generated/bluesky.run_engine.Dispatcher.html#bluesky.run_engine.Dispatcher">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Dispatcher</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Dispatch documents to user-defined consumers on the main thread.&quot;&quot;&quot;</span>

<div class="viewcode-block" id="Dispatcher.__init__">
<a class="viewcode-back" href="../../generated/bluesky.run_engine.Dispatcher.html#bluesky.run_engine.Dispatcher.__init__">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cb_registry</span> <span class="o">=</span> <span class="n">CallbackRegistry</span><span class="p">(</span><span class="n">allowed_sigs</span><span class="o">=</span><span class="n">DocumentNames</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_counter</span> <span class="o">=</span> <span class="n">count</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_token_mapping</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>  <span class="c1"># noqa: C408</span></div>


<div class="viewcode-block" id="Dispatcher.process">
<a class="viewcode-back" href="../../generated/bluesky.run_engine.Dispatcher.process.html#bluesky.run_engine.Dispatcher.process">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">doc</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Dispatch document ``doc`` of type ``name`` to the callback registry.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : {&#39;start&#39;, &#39;descriptor&#39;, &#39;event&#39;, &#39;stop&#39;}</span>
<span class="sd">        doc : dict</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">exceptions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cb_registry</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">doc</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">exc</span><span class="p">,</span> <span class="n">traceback</span> <span class="ow">in</span> <span class="n">exceptions</span><span class="p">:</span>  <span class="c1"># noqa: B007</span>
            <span class="n">warn</span><span class="p">(</span>  <span class="c1"># noqa: B028</span>
                <span class="s2">&quot;A </span><span class="si">%r</span><span class="s2"> was raised during the processing of a </span><span class="si">%s</span><span class="s2"> &quot;</span>  <span class="c1"># noqa: UP031</span>
                <span class="s2">&quot;Document. The error will be ignored to avoid &quot;</span>
                <span class="s2">&quot;interrupting data collection. To investigate, &quot;</span>
                <span class="s2">&quot;set RunEngine.ignore_callback_exceptions = False &quot;</span>
                <span class="s2">&quot;and run again.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">name</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
            <span class="p">)</span></div>


<div class="viewcode-block" id="Dispatcher.subscribe">
<a class="viewcode-back" href="../../generated/bluesky.run_engine.Dispatcher.subscribe.html#bluesky.run_engine.Dispatcher.subscribe">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">subscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Register a callback function to consume documents.</span>

<span class="sd">        .. versionchanged :: 0.10.0</span>
<span class="sd">            The order of the arguments was swapped and the ``name``</span>
<span class="sd">            argument has been given a default value, ``&#39;all&#39;``. Because the</span>
<span class="sd">            meaning of the arguments is unambiguous (they must be a callable</span>
<span class="sd">            and a string, respectively) the old order will be supported</span>
<span class="sd">            indefinitely, with a warning.</span>

<span class="sd">        .. versionchanged :: 0.10.0</span>
<span class="sd">            The order of the arguments was swapped and the ``name``</span>
<span class="sd">            argument has been given a default value, ``&#39;all&#39;``. Because the</span>
<span class="sd">            meaning of the arguments is unambiguous (they must be a callable</span>
<span class="sd">            and a string, respectively) the old order will be supported</span>
<span class="sd">            indefinitely, with a warning.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        func: callable</span>
<span class="sd">            expecting signature like ``f(name, document)``</span>
<span class="sd">            where name is a string and document is a dict</span>
<span class="sd">        name : {&#39;all&#39;, &#39;start&#39;, &#39;descriptor&#39;, &#39;event&#39;, &#39;stop&#39;}, optional</span>
<span class="sd">            the type of document this function should receive (&#39;all&#39; by</span>
<span class="sd">            default).</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        token : int</span>
<span class="sd">            an integer ID that can be used to unsubscribe</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :meth:`Dispatcher.unsubscribe`</span>
<span class="sd">            an integer token that can be used to unsubscribe</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">func</span> <span class="o">=</span> <span class="n">func</span><span class="p">,</span> <span class="n">name</span>
            <span class="n">warn</span><span class="p">(</span>  <span class="c1"># noqa: B028</span>
                <span class="s2">&quot;The order of the arguments has been changed. Because the &quot;</span>
                <span class="s2">&quot;meaning of the arguments is unambiguous, the old usage will &quot;</span>
                <span class="s2">&quot;continue to work indefinitely, but the new usage is &quot;</span>
                <span class="s2">&quot;encouraged: call subscribe(func, name) instead of &quot;</span>
                <span class="s2">&quot;subscribe(name, func). Additionally, the &#39;name&#39; argument &quot;</span>
                <span class="s2">&quot;has become optional. Its default value is &#39;all&#39;.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span><span class="p">:</span>
            <span class="n">private_tokens</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">DocumentNames</span><span class="p">:</span>
                <span class="n">private_tokens</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cb_registry</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">func</span><span class="p">))</span>
            <span class="n">public_token</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_counter</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_token_mapping</span><span class="p">[</span><span class="n">public_token</span><span class="p">]</span> <span class="o">=</span> <span class="n">private_tokens</span>
            <span class="k">return</span> <span class="n">public_token</span>

        <span class="n">name</span> <span class="o">=</span> <span class="n">DocumentNames</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="n">private_token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cb_registry</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">func</span><span class="p">)</span>
        <span class="n">public_token</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_counter</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_token_mapping</span><span class="p">[</span><span class="n">public_token</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">private_token</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">public_token</span></div>


<div class="viewcode-block" id="Dispatcher.unsubscribe">
<a class="viewcode-back" href="../../generated/bluesky.run_engine.Dispatcher.unsubscribe.html#bluesky.run_engine.Dispatcher.unsubscribe">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">unsubscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">token</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Unregister a callback function using its integer ID.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        token : int</span>
<span class="sd">            the integer ID issued by :meth:`Dispatcher.subscribe`</span>

<span class="sd">        See Also</span>
<span class="sd">        --------</span>
<span class="sd">        :meth:`Dispatcher.subscribe`</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">private_token</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_token_mapping</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cb_registry</span><span class="o">.</span><span class="n">disconnect</span><span class="p">(</span><span class="n">private_token</span><span class="p">)</span></div>


<div class="viewcode-block" id="Dispatcher.unsubscribe_all">
<a class="viewcode-back" href="../../generated/bluesky.run_engine.Dispatcher.unsubscribe_all.html#bluesky.run_engine.Dispatcher.unsubscribe_all">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">unsubscribe_all</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Unregister all callbacks from the dispatcher.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">public_token</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_token_mapping</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">unsubscribe</span><span class="p">(</span><span class="n">public_token</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ignore_exceptions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cb_registry</span><span class="o">.</span><span class="n">ignore_exceptions</span>

    <span class="nd">@ignore_exceptions</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ignore_exceptions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">val</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cb_registry</span><span class="o">.</span><span class="n">ignore_exceptions</span> <span class="o">=</span> <span class="n">val</span></div>



<span class="n">PAUSE_MSG</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">Your RunEngine is entering a paused state. These are your options for changing</span>
<span class="s2">the state of the RunEngine:</span>

<span class="s2">RE.resume()    Resume the plan.</span>
<span class="s2">RE.abort()     Perform cleanup, then kill plan. Mark exit_stats=&#39;aborted&#39;.</span>
<span class="s2">RE.stop()      Perform cleanup, then kill plan. Mark exit_status=&#39;success&#39;.</span>
<span class="s2">RE.halt()      Emergency Stop: Do not perform cleanup --- just stop.</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="n">MAX_DEPTH_EXCEEDED_ERR_MSG</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">RunEngine.max_depth is set to </span><span class="si">{}</span><span class="s2">; depth of </span><span class="si">{}</span><span class="s2"> was detected.</span>

<span class="s2">The RunEngine should not be called from inside another function. Doing so</span>
<span class="s2">breaks introspection tools and can result in unexpected behavior in the event</span>
<span class="s2">of an interruption. See documentation for more information and what to do</span>
<span class="s2">instead:</span>

<span class="s2">http://nsls-ii.github.io/bluesky/plans_intro.html#combining-plans</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_set_span_msg_attributes</span><span class="p">(</span><span class="n">span</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
    <span class="n">span</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;msg.command&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">command</span><span class="p">)</span>
    <span class="n">span</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;msg.args&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
    <span class="n">span</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;msg.kwargs&quot;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="nb">repr</span><span class="p">))</span>
    <span class="n">span</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;msg.obj&quot;</span><span class="p">,</span> <span class="nb">repr</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">obj</span><span class="p">))</span> <span class="k">if</span> <span class="n">msg</span><span class="o">.</span><span class="n">obj</span> <span class="k">else</span> <span class="n">span</span><span class="o">.</span><span class="n">set_attribute</span><span class="p">(</span><span class="s2">&quot;msg.no_obj_given&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_default_md_validator</span><span class="p">(</span><span class="n">md</span><span class="p">):</span>
    <span class="k">if</span> <span class="s2">&quot;sample&quot;</span> <span class="ow">in</span> <span class="n">md</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">md</span><span class="p">[</span><span class="s2">&quot;sample&quot;</span><span class="p">],</span> <span class="s2">&quot;keys&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">md</span><span class="p">[</span><span class="s2">&quot;sample&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s2">&quot;You specified &#39;sample&#39; metadata. We give this field special &quot;</span>
            <span class="s2">&quot;significance in order to make your data easily searchable. &quot;</span>
            <span class="s2">&quot;Therefore, you must make &#39;sample&#39; a string or a  &quot;</span>
            <span class="s2">&quot;dictionary, like so: &quot;</span>
            <span class="s2">&quot;GOOD: sample=&#39;dirt&#39; &quot;</span>
            <span class="s2">&quot;GOOD: sample={&#39;color&#39;: &#39;red&#39;, &#39;number&#39;: 5} &quot;</span>
            <span class="s2">&quot;BAD: sample=[1, 2] &quot;</span>
        <span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_default_md_normalizer</span><span class="p">(</span><span class="n">md</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">md</span>


<span class="k">def</span><span class="w"> </span><span class="nf">_ensure_event_loop_running</span><span class="p">(</span><span class="n">loop</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run an asyncio event loop forever on a background thread.</span>

<span class="sd">    This is idempotent: if the loop is already running nothing will be done.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">loop</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
        <span class="n">th</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="n">loop</span><span class="o">.</span><span class="n">run_forever</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;bluesky-run-engine&quot;</span><span class="p">)</span>
        <span class="n">th</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="n">_ensure_event_loop_running</span><span class="o">.</span><span class="n">loop_to_thread</span><span class="p">[</span><span class="n">loop</span><span class="p">]</span> <span class="o">=</span> <span class="n">th</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">th</span> <span class="o">=</span> <span class="n">_ensure_event_loop_running</span><span class="o">.</span><span class="n">loop_to_thread</span><span class="p">[</span><span class="n">loop</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">th</span>


<span class="n">_ensure_event_loop_running</span><span class="o">.</span><span class="n">loop_to_thread</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">()</span>  <span class="c1"># type: ignore</span>

<span class="n">_bluesky_event_loop</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">def</span><span class="w"> </span><span class="nf">get_bluesky_event_loop</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">_bluesky_event_loop</span>


<span class="k">def</span><span class="w"> </span><span class="nf">set_bluesky_event_loop</span><span class="p">(</span><span class="n">loop</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">_bluesky_event_loop</span>
    <span class="n">_bluesky_event_loop</span> <span class="o">=</span> <span class="n">loop</span>


<span class="k">def</span><span class="w"> </span><span class="nf">in_bluesky_event_loop</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">loop</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_running_loop</span><span class="p">()</span>
    <span class="k">except</span> <span class="ne">RuntimeError</span><span class="p">:</span>
        <span class="c1"># Ok, no running loop</span>
        <span class="k">return</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Check if running loop is bluesky event loop</span>
        <span class="k">return</span> <span class="n">loop</span> <span class="ow">is</span> <span class="n">_bluesky_event_loop</span>


<span class="k">def</span><span class="w"> </span><span class="nf">call_in_bluesky_event_loop</span><span class="p">(</span><span class="n">coro</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Awaitable</span><span class="p">[</span><span class="n">T</span><span class="p">],</span> <span class="n">timeout</span><span class="p">:</span> <span class="n">typing</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">T</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">_bluesky_event_loop</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">_bluesky_event_loop</span><span class="o">.</span><span class="n">is_running</span><span class="p">():</span>
        <span class="c1"># Quell &quot;coroutine never awaited&quot; warnings</span>
        <span class="k">if</span> <span class="n">iscoroutine</span><span class="p">(</span><span class="n">coro</span><span class="p">):</span>
            <span class="n">coro</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Bluesky event loop not running&quot;</span><span class="p">)</span>
    <span class="n">fut</span><span class="p">:</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">Future</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">run_coroutine_threadsafe</span><span class="p">(</span>
        <span class="n">coro</span><span class="p">,</span>  <span class="c1"># type: ignore</span>
        <span class="n">loop</span><span class="o">=</span><span class="n">_bluesky_event_loop</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">fut</span><span class="o">.</span><span class="n">result</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>


<span class="k">def</span><span class="w"> </span><span class="nf">autoawait_in_bluesky_event_loop</span><span class="p">(</span><span class="n">ip</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">ip</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">IPython</span>

        <span class="n">ip</span> <span class="o">=</span> <span class="n">IPython</span><span class="o">.</span><span class="n">get_ipython</span><span class="p">()</span>  <span class="c1"># type: ignore</span>
    <span class="k">assert</span> <span class="n">ip</span><span class="p">,</span> <span class="s2">&quot;Couldn&#39;t import IPython&quot;</span>
    <span class="n">ip</span><span class="o">.</span><span class="n">loop_runner</span> <span class="o">=</span> <span class="n">call_in_bluesky_event_loop</span>
</pre></div>

                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="../../_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="../../_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
       Copyright 2015, Brookhaven National Lab.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>