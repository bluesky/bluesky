<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Recording Metadata &mdash; bluesky 1.13.0a4.dev38+gff57ab4d documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="_static/plot_directive.css" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/documentation_options.js?v=af119964"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Live Visualization and Processing" href="callbacks.html" />
    <link rel="prev" title="Documents" href="documents.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            bluesky
          </a>
              <div class="version">
                1.13.0a4.dev38+gff57ab4d
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">User Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="tutorial.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="plans.html">Plans</a></li>
<li class="toctree-l1"><a class="reference internal" href="documents.html">Documents</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Recording Metadata</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#adding-to-the-start-document">Adding to the Start Document</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#interactively-for-one-use">1. Interactively, for One Use</a></li>
<li class="toctree-l3"><a class="reference internal" href="#through-a-plan">2. Through a plan</a></li>
<li class="toctree-l3"><a class="reference internal" href="#automatically">3. Automatically</a></li>
<li class="toctree-l3"><a class="reference internal" href="#interactively-for-repeated-use">4. Interactively, for Repeated Use</a></li>
<li class="toctree-l3"><a class="reference internal" href="#persistence-between-sessions">Persistence Between Sessions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#allowed-data-types">Allowed Data Types</a></li>
<li class="toctree-l3"><a class="reference internal" href="#required-fields">Required Fields</a></li>
<li class="toctree-l3"><a class="reference internal" href="#special-fields">Special Fields</a></li>
<li class="toctree-l3"><a class="reference internal" href="#validation">Validation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="callbacks.html">Live Visualization and Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="state-machine.html">Interruptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="simulation.html">Simulation and Error Checking</a></li>
<li class="toctree-l1"><a class="reference internal" href="progress-bar.html">Progress Bar</a></li>
<li class="toctree-l1"><a class="reference internal" href="event_descriptors.html">Event Descriptors</a></li>
<li class="toctree-l1"><a class="reference internal" href="async.html">Asynchronous Acquisition</a></li>
<li class="toctree-l1"><a class="reference internal" href="multi_run_plans.html">Multi-Run Plans</a></li>
<li class="toctree-l1"><a class="reference internal" href="debugging.html">Debugging and Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="run_engine_api.html">RunEngine API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="utils.html">Utility classes and functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="magics.html">IPython ‘Magics’ [Experimental]</a></li>
<li class="toctree-l1"><a class="reference internal" href="from-pyepics-to-bluesky.html">Translating Direct PyEpics Code to Bluesky Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="comparison-with-spec.html">Comparison with SPEC</a></li>
<li class="toctree-l1"><a class="reference internal" href="hardware-interfaces.html">Hardware Interface Packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="appendix.html">Appendix</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="hardware.html">How Bluesky Interfaces with Hardware</a></li>
<li class="toctree-l1"><a class="reference internal" href="msg.html">Message Protocol</a></li>
<li class="toctree-l1"><a class="reference internal" href="run_engine.html">The RunEngine run loop</a></li>
<li class="toctree-l1"><a class="reference internal" href="api_changes.html">Release History</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Data Collection</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://blueskyproject.io/bluesky">bluesky</a></li>
<li class="toctree-l1"><a class="reference external" href="https://blueskyproject.io/ophyd">ophyd</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Data Access and Management</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://blueskyproject.io/databroker">databroker</a></li>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/amostra">amostra</a></li>
<li class="toctree-l1"><a class="reference external" href="https://nsls-ii.github.io/datamuxer">datamuxer</a></li>
<li class="toctree-l1"><a class="reference external" href="https://blueskyproject.io/suitcase">suitcase</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">GitHub Links</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://github.com/NSLS-II/">NSLS-II Repositories</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/NSLS-II/Bug-Reports/issues">Bug Reports</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">bluesky</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Recording Metadata</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/metadata.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="recording-metadata">
<h1>Recording Metadata<a class="headerlink" href="#recording-metadata" title="Link to this heading">¶</a></h1>
<p>Capturing useful metadata is the main objective of bluesky. The more
information you can provide about what you are doing and why you are
doing it, the more useful bluesky and downstream data search and
analysis tools can be.</p>
<p>The term “metadata” can be a controversial term, one scientist’s
“data” is another’s “metadata” and classification is context- dependent.
The same exact information can be “data” in one
experiment, but “metadata” in a different experiment done on the exact
same hardware.
The <a class="reference external" href="https://blueskyproject.io/event-model/data-model.html">Document Model</a> provides a framework
for deciding _where_ to record a particular piece of information.</p>
<p>There are some things that we know <em>a priori</em> before doing an experiment;
where are we? who is the user? what sample are we looking at? what did
the user just ask us to do?  These are all things that we can, in
principle, know independent of the control system.  These are the
prime candidates for inclusion in the <a class="reference external" href="https://blueskyproject.io/event-model/data-model.html#run-start-document">Start Document</a>.
Downstream DataBroker provides tools to do rich searches on this data.
The more information you can include the better.</p>
<p>There is some information that we need that is nominally independent of
any particular device but we need to consult the controls system
about.  For example the location of important, but un-scanned motors
or the configuration of beam attenuators.  If the values <em>should</em> be fixed over
the course of the experiment then this it is a good candidate for
being a “baseline device” either via the <a class="reference external" href="https://blueskyproject.io/bluesky/tutorial.html#baseline-readings-and-other-supplemental-data">Supplemental pre-processor</a>
or explicitly in custom plans.  This will put the readings in a separate stream
(which is a peer to the “primary” data).  In principle, these values <em>could</em> be
read from the control system once and put into the Start document along with
the <em>a priori</em> information, however that has several draw backs:</p>
<ol class="arabic simple">
<li><p>There is only ever 1 reading of the values so if they do drift during
data acquisition, you will never know.</p></li>
<li><p>We cannot automatically capture information about the device like
we do for data in Events.  This includes things like the datatype,
units, and shape of the value and any configuration information about the
hardware it is being read from.</p></li>
</ol>
<p>A third class of information that can be called “metadata” is
configuration information of pieces of hardware.  These are things
like the velocity of a motor or the integration time of a detector.
These readings are embedded in the <a class="reference external" href="https://blueskyproject.io/event-model/data-model.html#event-descriptor">Descriptor</a>
and are extracted from the hardware via the <a class="reference external" href="https://blueskyproject.io/bluesky/hardware.html#ReadableDevice.read_configuration">read_configuration</a>
method of the hardware.  We expect that these values will not change over
the course of the experiment so only read them once.</p>
<p>Information that does not fall into one of these categories, because
you expect it to change during the experiment,
should be treated as “data”, either as an explicit part of the
experimental plan or via <a class="reference internal" href="async.html#async-monitoring"><span class="std std-ref">Monitoring</span></a>.</p>
<section id="adding-to-the-start-document">
<h2>Adding to the Start Document<a class="headerlink" href="#adding-to-the-start-document" title="Link to this heading">¶</a></h2>
<p>When the RunEngine mints a Start document it includes structured data.  That
information can be injected in via several mechanisms:</p>
<ol class="arabic simple">
<li><p>entered interactively by the user at execution time</p></li>
<li><p>provided in the code of the <em>plan</em></p></li>
<li><p>automatically inferred</p></li>
<li><p>entered by user once and stashed for reuse on all future plans</p></li>
</ol>
<p>If there is a conflict between these sources, the higher entry in this
list wins.  The “closer” to a user the information originated the
higher priority it has.</p>
<section id="interactively-for-one-use">
<h3>1. Interactively, for One Use<a class="headerlink" href="#interactively-for-one-use" title="Link to this heading">¶</a></h3>
<p>Suppose we are executing some custom plan called <code class="docutils literal notranslate"><span class="pre">plan</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">plan</span><span class="p">())</span>
</pre></div>
</div>
<p>If we give arbitrary extra keyword arguments to <code class="docutils literal notranslate"><span class="pre">RE</span></code>, they will be
interpreted as metadata.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">plan</span><span class="p">(),</span> <span class="n">sample_id</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="s1">&#39;calibration&#39;</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="s1">&#39;Dan&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="documents.html#run-overview"><span class="std std-ref">run(s)</span></a> — i.e., datasets — generated by <code class="docutils literal notranslate"><span class="pre">plan()</span></code>
will include the custom metadata:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="s1">&#39;sample_id&#39;</span><span class="p">:</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span>
<span class="s1">&#39;purpose&#39;</span><span class="p">:</span> <span class="s1">&#39;calibration&#39;</span><span class="o">.</span>
<span class="s1">&#39;operator&#39;</span><span class="p">:</span> <span class="s1">&#39;Dan&#39;</span><span class="p">,</span>
<span class="o">...</span>
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">plan</span></code> generates more that one run, all the runs will get this metadata.
For example, this plan generates three different runs.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bluesky.plans</span> <span class="kn">import</span> <span class="n">count</span><span class="p">,</span> <span class="n">scan</span>
<span class="kn">from</span> <span class="nn">ophyd.sim</span> <span class="n">det1</span><span class="p">,</span> <span class="n">det2</span><span class="p">,</span> <span class="n">motor</span>  <span class="c1"># simulated detectors, motor</span>

<span class="k">def</span> <span class="nf">plan</span><span class="p">():</span>
    <span class="k">yield from</span> <span class="n">count</span><span class="p">([</span><span class="n">det</span><span class="p">])</span>
    <span class="k">yield from</span> <span class="n">scan</span><span class="p">([</span><span class="n">det</span><span class="p">],</span> <span class="n">motor</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="k">yield from</span> <span class="n">count</span><span class="p">([</span><span class="n">det</span><span class="p">])</span>
</pre></div>
</div>
<p>If executed as above:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">plan</span><span class="p">(),</span> <span class="n">sample_id</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">purpose</span><span class="o">=</span><span class="s1">&#39;calibration&#39;</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="s1">&#39;Dan&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>each run will get a copy of the sample_id, purpose and operator metadata.</p>
</section>
<section id="through-a-plan">
<h3>2. Through a plan<a class="headerlink" href="#through-a-plan" title="Link to this heading">¶</a></h3>
<p>Revisiting the previous example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plan</span><span class="p">():</span>
    <span class="k">yield from</span> <span class="n">count</span><span class="p">([</span><span class="n">det</span><span class="p">])</span>
    <span class="k">yield from</span> <span class="n">scan</span><span class="p">([</span><span class="n">det</span><span class="p">],</span> <span class="n">motor</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="k">yield from</span> <span class="n">count</span><span class="p">([</span><span class="n">det</span><span class="p">])</span>
</pre></div>
</div>
<p>we can pass different metadata for each run. Every
<a class="reference internal" href="plans.html#preassembled-plans"><span class="std std-ref">built-in pre-assembled plan</span></a> accepts a parameter
<code class="docutils literal notranslate"><span class="pre">md</span></code>, which you can use to inject metadata that applies only to that plan.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plan</span><span class="p">():</span>
    <span class="k">yield from</span> <span class="n">count</span><span class="p">([</span><span class="n">det</span><span class="p">],</span> <span class="n">md</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;purpose&#39;</span><span class="p">:</span> <span class="s1">&#39;calibration&#39;</span><span class="p">})</span>  <span class="c1"># one</span>
    <span class="k">yield from</span> <span class="n">scan</span><span class="p">([</span><span class="n">det</span><span class="p">],</span> <span class="n">motor</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">md</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;purpose&#39;</span><span class="p">:</span> <span class="s1">&#39;good data&#39;</span><span class="p">})</span>  <span class="c1"># two</span>
    <span class="k">yield from</span> <span class="n">count</span><span class="p">([</span><span class="n">det</span><span class="p">],</span> <span class="n">md</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;purpose&#39;</span><span class="p">:</span> <span class="s1">&#39;sanity check&#39;</span><span class="p">})</span>  <span class="c1"># three</span>
</pre></div>
</div>
<p>The metadata passed into <code class="docutils literal notranslate"><span class="pre">RE</span></code> is combined with the metadata passed in to each
plan. Thus, calling</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">plan</span><span class="p">(),</span> <span class="n">sample_id</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="n">operator</span><span class="o">=</span><span class="s1">&#39;Dan&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>generates these three sets of metadata:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># one</span>
<span class="o">...</span>
<span class="s1">&#39;sample_id&#39;</span><span class="p">:</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span>
<span class="s1">&#39;purpose&#39;</span><span class="p">:</span> <span class="s1">&#39;calibration&#39;</span><span class="o">.</span>
<span class="s1">&#39;operator&#39;</span><span class="p">:</span> <span class="s1">&#39;Dan&#39;</span><span class="p">,</span>
<span class="o">...</span>

<span class="c1"># two</span>
<span class="o">...</span>
<span class="s1">&#39;sample_id&#39;</span><span class="p">:</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span>
<span class="s1">&#39;purpose&#39;</span><span class="p">:</span> <span class="s1">&#39;good data&#39;</span><span class="o">.</span>
<span class="s1">&#39;operator&#39;</span><span class="p">:</span> <span class="s1">&#39;Dan&#39;</span><span class="p">,</span>
<span class="o">...</span>

<span class="c1"># three</span>
<span class="o">...</span>
<span class="s1">&#39;sample_id&#39;</span><span class="p">:</span> <span class="s1">&#39;A&#39;</span><span class="p">,</span>
<span class="s1">&#39;purpose&#39;</span><span class="p">:</span> <span class="s1">&#39;sanity check&#39;</span><span class="o">.</span>
<span class="s1">&#39;operator&#39;</span><span class="p">:</span> <span class="s1">&#39;Dan&#39;</span><span class="p">,</span>
<span class="o">...</span>
</pre></div>
</div>
<p>If there is a conflict, <code class="docutils literal notranslate"><span class="pre">RE</span></code> keywords takes precedence. So</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">plan</span><span class="p">(),</span> <span class="n">purpose</span><span class="o">=</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>would override the individual ‘purpose’ metadata from the plan, marking all
three as purpose=test.</p>
<p>If you define your own plans, it is best practice have them take a keyword only
argument <code class="docutils literal notranslate"><span class="pre">md=None</span></code>.  This allows the hard-coded meta-data to be over-ridden
later:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plan</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">md</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">md</span> <span class="o">=</span> <span class="n">md</span> <span class="ow">or</span> <span class="p">{}</span>  <span class="c1"># handle the default case</span>
    <span class="c1"># putting unpacking **md at the end means it &quot;wins&quot;</span>
    <span class="c1"># and if the user calls</span>
    <span class="c1">#    yield from plan(md={&#39;purpose&#39;: bob})</span>
    <span class="c1"># it will over-ride these values</span>
    <span class="k">yield from</span> <span class="n">count</span><span class="p">([</span><span class="n">det</span><span class="p">],</span> <span class="n">md</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;purpose&#39;</span><span class="p">:</span> <span class="s1">&#39;calibration&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">md</span><span class="p">})</span>
    <span class="k">yield from</span> <span class="n">scan</span><span class="p">([</span><span class="n">det</span><span class="p">],</span> <span class="n">motor</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">md</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;purpose&#39;</span><span class="p">:</span> <span class="s1">&#39;good data&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">md</span><span class="p">})</span>
    <span class="k">yield from</span> <span class="n">count</span><span class="p">([</span><span class="n">det</span><span class="p">],</span> <span class="n">md</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;purpose&#39;</span><span class="p">:</span> <span class="s1">&#39;sanity check&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">md</span><span class="p">})</span>
</pre></div>
</div>
<p>This is consistent with all of the <a class="reference internal" href="plans.html#preassembled-plans"><span class="std std-ref">Pre-assembled Plans</span></a>.</p>
<p>For more on injecting metadata via plans, refer to
<a class="reference internal" href="tutorial.html#tutorial-plan-metadata"><span class="std std-ref">this section</span></a> of the tutorial.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>All of the built-in plans provide certain metadata automatically. Custom
plans are not <em>required</em> to provide any of this, but it is a nice pattern
to follow.</p>
<ul class="simple">
<li><p>plan_name — e.g., <code class="docutils literal notranslate"><span class="pre">'scan'</span></code></p></li>
<li><p>detectors — a list of the names of the detectors</p></li>
<li><p>motors — a list of the names of the motors</p></li>
<li><p>plan_args — dict of keyword arguments passed to the plan</p></li>
<li><p>plan_pattern – function used to create the trajectory</p></li>
<li><p>plan_pattern_module — Python module where <code class="docutils literal notranslate"><span class="pre">plan_pattern</span></code> is defined</p></li>
<li><p>plan_pattern_args — dict of keyword arguments passed to
<code class="docutils literal notranslate"><span class="pre">plan_pattern</span></code> to create the trajectory</p></li>
</ul>
<p>The <code class="docutils literal notranslate"><span class="pre">plan_name</span></code> and <code class="docutils literal notranslate"><span class="pre">plan_args</span></code> together should provide sufficient
information to recreate the plan. The <code class="docutils literal notranslate"><span class="pre">detectors</span></code> and <code class="docutils literal notranslate"><span class="pre">motors</span></code> are
convenient keys to search on later.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">plan_pattern*</span></code> entries provide lower-level, more explicit
information about the <em>trajectory</em> (“pattern”) generated by the plan,
separate from the specific detectors and motors involved. For complex
trajectories like spirals, this is especially useful. As a simple example,
here is the pattern-related metadata for <a class="reference internal" href="generated/bluesky.plans.scan.html#bluesky.plans.scan" title="bluesky.plans.scan"><code class="xref py py-func docutils literal notranslate"><span class="pre">scan()</span></code></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="o">...</span>
<span class="s1">&#39;plan_pattern&#39;</span><span class="p">:</span> <span class="s1">&#39;linspace&#39;</span><span class="p">,</span>
<span class="s1">&#39;plan_pattern_module&#39;</span><span class="p">:</span> <span class="s1">&#39;numpy&#39;</span><span class="p">,</span>
<span class="s1">&#39;plan_pattern_args&#39;</span><span class="p">:</span> <span class="nb">dict</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="p">)</span>
<span class="o">...</span>
</pre></div>
</div>
<p>Thus, one can re-create the “pattern” (trajectory) like so:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">numpy</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">**</span><span class="nb">dict</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">=</span><span class="n">stop</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="n">num</span><span class="p">))</span>
</pre></div>
</div>
</div>
</section>
<section id="automatically">
<h3>3. Automatically<a class="headerlink" href="#automatically" title="Link to this heading">¶</a></h3>
<p>For each run, the RunEngine automatically records:</p>
<ul class="simple">
<li><p>‘time’ — In this context, the start time. (Other times are also recorded.)</p></li>
<li><p>‘uid’ — a globally unique ID for this run</p></li>
<li><p>‘plan_name’ — the function or class name of <code class="docutils literal notranslate"><span class="pre">plan</span></code> (e.g., ‘count’)</p></li>
<li><p>‘plan_type’— e.g., the Python type of <code class="docutils literal notranslate"><span class="pre">plan</span></code> (e.g., ‘generator’)</p></li>
</ul>
<p>The last two can be overridden by any of the methods above. The first two
cannot be overridden by the user.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If some custom plan does not specify a ‘plan_name’ and ‘plan_type’, the
RunEngine infers them as follows:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">plan_name</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="n">plan</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>
<span class="n">plan_type</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="s1">&#39;__name__&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>These may be more or less informative depending on what <code class="docutils literal notranslate"><span class="pre">plan</span></code> is. They
are just heuristics to provide <em>some</em> information by default if the plan
itself and the user do not provide it.</p>
</div>
</section>
<section id="interactively-for-repeated-use">
<h3>4. Interactively, for Repeated Use<a class="headerlink" href="#interactively-for-repeated-use" title="Link to this heading">¶</a></h3>
<p>Each time a plan is executed, the current contents of <code class="docutils literal notranslate"><span class="pre">RE.md</span></code> are copied into
the metadata for all runs generated by the plan.  To enter metadata once to
reuse on all plans, add it to <code class="docutils literal notranslate"><span class="pre">RE.md</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="s1">&#39;proposal_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">123456</span>
<span class="n">RE</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="s1">&#39;project&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;flying cars&#39;</span>
<span class="n">RE</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="s1">&#39;dimensions&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
<p>View its current contents,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="o">.</span><span class="n">md</span>
</pre></div>
</div>
<p>delete a key you want to stop using,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">del</span> <span class="n">RE</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="s1">&#39;project&#39;</span><span class="p">]</span>   <span class="c1"># delete a key</span>
</pre></div>
</div>
<p>or use any of the standard methods that apply to
<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#typesmapping">dictionaries in Python</a>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>In general we recommend against putting device readings in the Start
document. (The Start document is for who/what/why/when, things you
know before you start communicating with hardware.) It is <em>especially</em>
critical that you do not put device readings in the <code class="docutils literal notranslate"><span class="pre">RE.md</span></code> dictionary.
The value will remain until you change it and not track the state of the
hardware.  This will result in recording out-of-date, incorrect data!</p>
<p>This can be particularly dangerous if <code class="docutils literal notranslate"><span class="pre">RE.md</span></code> is backed by a
persistent data store (see next section) because out-of-date readings will
last across sessions.</p>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">scan_id</span></code>, an integer that the RunEngine automatically increments at the
beginning of each scan, is stored in <code class="docutils literal notranslate"><span class="pre">RE.md['scan_id']</span></code>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Clearing all keys, like so:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>  <span class="c1"># clear *all* keys</span>
</pre></div>
</div>
<p>will reset the <code class="docutils literal notranslate"><span class="pre">scan_id</span></code>. The next time a plan is executed, the
RunEngine will start with a <code class="docutils literal notranslate"><span class="pre">scan_id</span></code> of 1 and set</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="s1">&#39;scan_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
</pre></div>
</div>
<p>Some readers may prefer to reset the scan ID to 1 at the beginning of a new
experiment; others way wish to maintain a single unbroken sequence of scan
IDs forever.</p>
<p>From a technical standpoint, it is fine to have duplicate scan IDs. All
runs also have randomly-generated ‘uid’ (“unique ID”) which is globally
unique forever.</p>
</div>
</section>
<section id="persistence-between-sessions">
<span id="md-persistence"></span><h3>Persistence Between Sessions<a class="headerlink" href="#persistence-between-sessions" title="Link to this heading">¶</a></h3>
<p>We provide a way to save the contents of the metadata stash <code class="docutils literal notranslate"><span class="pre">RE.md</span></code> between
sessions (e.g., exiting and re-opening IPython).</p>
<p>In general, the <code class="docutils literal notranslate"><span class="pre">RE.md</span></code> attribute may be anything that supports the
dictionary interface. The simplest is just a plain Python dictionary.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="o">.</span><span class="n">md</span> <span class="o">=</span> <span class="p">{}</span>
</pre></div>
</div>
<p>To persist metadata between sessions, bluesky recommends
<a class="reference internal" href="generated/bluesky.utils.PersistentDict.html#bluesky.utils.PersistentDict" title="bluesky.utils.PersistentDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">bluesky.utils.PersistentDict</span></code></a> — a Python dictionary synced with a
directory of files on disk. Any changes made to <code class="docutils literal notranslate"><span class="pre">RE.md</span></code> are synced to the
file, so the contents of <code class="docutils literal notranslate"><span class="pre">RE.md</span></code> can persist between sessions.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bluesky.utils</span> <span class="kn">import</span> <span class="n">PersistentDict</span>
<span class="n">RE</span><span class="o">.</span><span class="n">md</span> <span class="o">=</span> <span class="n">PersistentDict</span><span class="p">(</span><span class="s1">&#39;some/path/here&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Bluesky does not provide a strong recommendation on that path; that a detail
left to the local deployment.</p>
<p>Bluesky formerly recommended using <code class="xref py py-class docutils literal notranslate"><span class="pre">HistoryDict</span></code> — a
Python dictionary backed by a sqlite database file. This approach proved
problematic with the threading introduced in bluesky v1.6.0, so it is no longer
recommended. If you have been following that recommendation, you should migrate
your metadata from <cite>~historydict.HistoryDict</cite> to
<a class="reference internal" href="generated/bluesky.utils.PersistentDict.html#bluesky.utils.PersistentDict" title="bluesky.utils.PersistentDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">PersistentDict</span></code></a>. First, update your configuration to
make <code class="docutils literal notranslate"><span class="pre">RE.md</span></code> a <a class="reference internal" href="generated/bluesky.utils.PersistentDict.html#bluesky.utils.PersistentDict" title="bluesky.utils.PersistentDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">PersistentDict</span></code></a> as shown above. Then,
migrate like so:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bluesky.utils</span> <span class="kn">import</span> <span class="n">get_history</span>
<span class="n">old_md</span> <span class="o">=</span> <span class="n">get_history</span><span class="p">()</span>
<span class="n">RE</span><span class="o">.</span><span class="n">md</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">old_md</span><span class="p">)</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="generated/bluesky.utils.PersistentDict.html#bluesky.utils.PersistentDict" title="bluesky.utils.PersistentDict"><code class="xref py py-class docutils literal notranslate"><span class="pre">PersistentDict</span></code></a> object has been back-ported to
bluesky v1.5.6 as well. It is not available in 1.4.x or older, so once you move
to the new system, you must run bluesky v1.5.6 or higher.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The <code class="docutils literal notranslate"><span class="pre">RE.md</span></code> object can also be set when the RunEngine is instantiated:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># This:</span>
<span class="n">RE</span> <span class="o">=</span> <span class="n">RunEngine</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>

<span class="c1"># is equivalent to this:</span>
<span class="n">RE</span> <span class="o">=</span> <span class="n">RunEngine</span><span class="p">({})</span>
<span class="n">RE</span><span class="o">.</span><span class="n">md</span> <span class="o">=</span> <span class="o">...</span>
</pre></div>
</div>
<p>As we stated
<a class="reference internal" href="tutorial.html#tutorial-run-engine-setup"><span class="std std-ref">at the start of the tutorial</span></a>, if you are
using bluesky at a user facility or with shared configuration, your
<code class="docutils literal notranslate"><span class="pre">RE</span></code> may already be configured, and defining a new <code class="docutils literal notranslate"><span class="pre">RE</span></code> as above can
result in data loss! If you aren’t sure, it’s safer to use <code class="docutils literal notranslate"><span class="pre">RE.md</span> <span class="pre">=</span> <span class="pre">...</span></code>.</p>
</div>
</section>
<section id="allowed-data-types">
<h3>Allowed Data Types<a class="headerlink" href="#allowed-data-types" title="Link to this heading">¶</a></h3>
<p>Custom metadata keywords can be mapped to:</p>
<ul class="simple">
<li><p>strings — e.g., <code class="docutils literal notranslate"><span class="pre">task='calibration'</span></code></p></li>
<li><p>numbers — e.g., <code class="docutils literal notranslate"><span class="pre">attempt=5</span></code></p></li>
<li><p>lists or tuples — e.g., <code class="docutils literal notranslate"><span class="pre">dimensions=[1,</span> <span class="pre">3]</span></code></p></li>
<li><p>(nested) dictionaries — e.g., <code class="docutils literal notranslate"><span class="pre">dimensions={'width':</span> <span class="pre">1,</span> <span class="pre">'height':</span> <span class="pre">3}</span></code></p></li>
</ul>
</section>
<section id="required-fields">
<h3>Required Fields<a class="headerlink" href="#required-fields" title="Link to this heading">¶</a></h3>
<p>The fields:</p>
<ul class="simple">
<li><p><strong>uid</strong></p></li>
<li><p><strong>time</strong></p></li>
</ul>
<p>are reserved by the document model and cannot be set by the user.</p>
<p>In current versions of bluesky, <strong>no fields are universally required by bluesky
itself</strong>. It is possible specify your own required fields in local
configuration. See <a class="reference internal" href="#md-validator"><span class="std std-ref">Validation</span></a>. (At NSLS-II, there are facility-wide
requirements coming soon.)</p>
</section>
<section id="special-fields">
<h3>Special Fields<a class="headerlink" href="#special-fields" title="Link to this heading">¶</a></h3>
<p>Arbitrary custom fields are allowed — you can invent any names that are
useful to you.</p>
<p>But certain fields are given special significance by bluesky’s document model,
and are either disallowed are required to be a certain type.</p>
<p>The fields:</p>
<ul class="simple">
<li><p><strong>owner</strong></p></li>
<li><p><strong>group</strong></p></li>
<li><p><strong>project</strong></p></li>
</ul>
<p>are optional but, to facilitate searchability, if they are not blank they must
be strings. A non-string, like <code class="docutils literal notranslate"><span class="pre">owner=5</span></code> will produce an error that will
interrupt scan execution immediately after it starts.</p>
<p>Similarly, the keyword <strong>sample</strong> has special significance. It must be either a
string or a dictionary.</p>
<p>The <strong>scan_id</strong> field is expected to be an integer, and it is automatically
incremented between runs. If a scan_id is not provided by the user or stashed
in the persistent metadata from the previous run, it defaults to 1.</p>
</section>
<section id="validation">
<span id="md-validator"></span><h3>Validation<a class="headerlink" href="#validation" title="Link to this heading">¶</a></h3>
<p>Additional, customized metadata validation can be added to the RunEngine.
For example, to ensure that a run will not be executed unless the parameter
‘sample_number’ is specified, define a function that accepts a dictionary
argument and raises if ‘sample_number’ is not found.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">ensure_sample_number</span><span class="p">(</span><span class="n">md</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;sample_number&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">md</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;You forgot the sample number.&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>Apply this function by setting</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="o">.</span><span class="n">md_validator</span> <span class="o">=</span> <span class="n">ensure_sample_number</span>
</pre></div>
</div>
<p>The function will be executed immediately before each new run in opened.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="documents.html" class="btn btn-neutral float-left" title="Documents" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="callbacks.html" class="btn btn-neutral float-right" title="Live Visualization and Processing" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2015, Brookhaven National Lab.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>