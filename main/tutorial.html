
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Tutorial &#8212; bluesky 1.14.3.dev4+gd2e3cb7a documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/plot_directive.css" />
  
  <!-- So that users can add custom icons -->
  <script src="_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="_static/documentation_options.js?v=0ca3cc5c"></script>
    <script src="_static/doctools.js?v=888ff710"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'tutorial';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.16.1';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://blueskyproject.io/bluesky/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = '1.14.3.dev4+gd2e3cb7a';
        DOCUMENTATION_OPTIONS.show_version_warning_banner =
            false;
        </script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Plans" href="plans.html" />
    <link rel="prev" title="User Documentation" href="userindex.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="1.14.3.dev4+gd2e3cb7a" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/bluesky-logo-dark.svg" class="logo__image only-light" alt=""/>
    <img src="_static/bluesky-logo-dark.svg" class="logo__image only-dark pst-js-only" alt=""/>
  
  
    <p class="title logo__title">bluesky</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="userindex.html">
    User Documentation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="devindex.html">
    Developer Documentation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://blueskyproject.io/bluesky">
    bluesky
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://blueskyproject.io/ophyd">
    ophyd
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://blueskyproject.io/databroker">
    databroker
  </a>
</li>

            <li class="nav-item dropdown">
                <button class="btn dropdown-toggle nav-item" type="button"
                data-bs-toggle="dropdown" aria-expanded="false"
                aria-controls="pst-nav-more-links">
                    More
                </button>
                <ul id="pst-nav-more-links" class="dropdown-menu">
                    
<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://nsls-ii.github.io/amostra">
    amostra
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://nsls-ii.github.io/datamuxer">
    datamuxer
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://blueskyproject.io/suitcase">
    suitcase
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://github.com/NSLS-II/">
    NSLS-II Repositories
  </a>
</li>


<li class=" ">
  <a class="nav-link dropdown-item nav-external" href="https://github.com/NSLS-II/Bug-Reports/issues">
    Bug Reports
  </a>
</li>

                </ul>
            </li>
            
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/bluesky/bluesky" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/bluesky" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fas fa-cube fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
      
        <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-2"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-2"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-2"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-2">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
    <button class="pst-navbar-icon sidebar-toggle secondary-toggle" aria-label="On this page">
      <span class="fa-solid fa-outdent"></span>
    </button>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item current active">
  <a class="nav-link nav-internal" href="userindex.html">
    User Documentation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="devindex.html">
    Developer Documentation
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://blueskyproject.io/bluesky">
    bluesky
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://blueskyproject.io/ophyd">
    ophyd
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://blueskyproject.io/databroker">
    databroker
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://nsls-ii.github.io/amostra">
    amostra
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://nsls-ii.github.io/datamuxer">
    datamuxer
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://blueskyproject.io/suitcase">
    suitcase
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://github.com/NSLS-II/">
    NSLS-II Repositories
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-external" href="https://github.com/NSLS-II/Bug-Reports/issues">
    Bug Reports
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/bluesky/bluesky" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/bluesky" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fas fa-cube fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
        
          <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-3"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-3"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-3"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-3">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="plans.html">Plans</a></li>
<li class="toctree-l1"><a class="reference internal" href="documents.html">Documents</a></li>
<li class="toctree-l1"><a class="reference internal" href="metadata.html">Recording Metadata</a></li>
<li class="toctree-l1"><a class="reference internal" href="callbacks.html">Live Visualization and Processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="state-machine.html">Interruptions</a></li>
<li class="toctree-l1"><a class="reference internal" href="simulation.html">Simulation and Error Checking</a></li>
<li class="toctree-l1"><a class="reference internal" href="progress-bar.html">Progress Bar</a></li>
<li class="toctree-l1"><a class="reference internal" href="event_descriptors.html">Event Descriptors</a></li>
<li class="toctree-l1"><a class="reference internal" href="async.html">Asynchronous Acquisition</a></li>
<li class="toctree-l1"><a class="reference internal" href="multi_run_plans.html">Multi-Run Plans</a></li>
<li class="toctree-l1"><a class="reference internal" href="debugging.html">Debugging and Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="run_engine_api.html">RunEngine API Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="utils.html">Utility classes and functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="magics.html">IPython ‘Magics’ [Experimental]</a></li>
<li class="toctree-l1"><a class="reference internal" href="otel-tracing.html">Tracing with Opentelemetry</a></li>
<li class="toctree-l1"><a class="reference internal" href="from-pyepics-to-bluesky.html">Translating Direct PyEpics Code to Bluesky Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="comparison-with-spec.html">Comparison with SPEC</a></li>
<li class="toctree-l1"><a class="reference internal" href="hardware-interfaces.html">Hardware Interface Packages</a></li>
<li class="toctree-l1"><a class="reference internal" href="tiled-writer.html">Integration with Tiled</a></li>
<li class="toctree-l1"><a class="reference internal" href="appendix.html">Appendix</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">

<nav aria-label="Breadcrumb" class="d-print-none">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="userindex.html" class="nav-link">User Documentation</a></li>
    
    <li class="breadcrumb-item active" aria-current="page"><span class="ellipsis">Tutorial</span></li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="tutorial">
<h1>Tutorial<a class="headerlink" href="#tutorial" title="Link to this heading">#</a></h1>
<section id="before-you-begin">
<h2>Before You Begin<a class="headerlink" href="#before-you-begin" title="Link to this heading">#</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>NSLS-II deploys a free, public “sandbox” for trying the software in the
browser using Jupyter notebooks. There will be no need to install any
software, and you can skip the rest of this section.  Go to
<a class="reference external" href="https://try.nsls2.bnl.gov">https://try.nsls2.bnl.gov</a>.</p>
</div>
<ul>
<li><p>You will need Python 3.9 or newer. From a shell (“Terminal” on OSX,
“Command Prompt” on Windows), check your current Python version.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python3<span class="w"> </span>--version
</pre></div>
</div>
<p>If that version is less than 3.9, you must update it.</p>
<p>We recommend install bluesky into a “virtual environment” so this
installation will not interfere with any existing Python software:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python3<span class="w"> </span>-m<span class="w"> </span>venv<span class="w"> </span>~/bluesky-tutorial
<span class="nb">source</span><span class="w"> </span>~/bluesky-tutorial/bin/activate
</pre></div>
</div>
<p>Alternatively, if you are a
<a class="reference external" href="https://conda.io/docs/user-guide/install/download.html">conda</a> user,
you can create a conda environment:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda<span class="w"> </span>create<span class="w"> </span>-n<span class="w"> </span>bluesky-tutorial<span class="w"> </span><span class="s2">&quot;python&gt;=3.9&quot;</span>
conda<span class="w"> </span>activate<span class="w"> </span>bluesky-tutorial
</pre></div>
</div>
</li>
<li><p>Install the latest versions of bluesky and ophyd. Also install the databroker
unless you plan to skip the sections about accessing saved data. If you want
to follow along with the visualization examples, install matplotlib and
PyQt5. Finally, install IPython (a Python interpreter designed by scientists
for scientists).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>python3<span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>--upgrade<span class="w"> </span>bluesky<span class="w"> </span>ophyd<span class="w"> </span>databroker<span class="w"> </span>matplotlib<span class="w"> </span>pyqt5<span class="w"> </span>ipython<span class="w"> </span>pyepics
</pre></div>
</div>
<p>Alternatively, if you are a conda user and you prefer conda packages, you can
use:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>conda<span class="w"> </span>install<span class="w"> </span>-c<span class="w"> </span>conda-forge<span class="w"> </span>bluesky<span class="w"> </span>ophyd<span class="w"> </span>databroker<span class="w"> </span>matplotlib<span class="w"> </span><span class="nv">pyqt</span><span class="o">=</span><span class="m">5</span><span class="w"> </span>ipython
</pre></div>
</div>
</li>
<li><p>Start IPython:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ipython</span> <span class="o">--</span><span class="n">matplotlib</span><span class="o">=</span><span class="n">qt5</span>
</pre></div>
</div>
<p>The flag <code class="docutils literal notranslate"><span class="pre">--matplotlib=qt5</span></code> is necessary for live-updating plots to work.</p>
<p>Or, if you wish you use bluesky from a Jupyter notebook, install a kernel like
so:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ipython</span> <span class="n">kernel</span> <span class="n">install</span> <span class="o">--</span><span class="n">user</span> <span class="o">--</span><span class="n">name</span><span class="o">=</span><span class="n">bluesky</span><span class="o">-</span><span class="n">tutorial</span> <span class="o">--</span><span class="n">display</span><span class="o">-</span><span class="n">name</span> <span class="s2">&quot;Python (bluesky)&quot;</span>
</pre></div>
</div>
<p>You may start Jupyter from any environment where it is already installed, or
install it in this environment alongside bluesky and run it from there:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">pip</span> <span class="n">install</span> <span class="n">notebook</span>
<span class="n">jupyter</span> <span class="n">notebook</span>
</pre></div>
</div>
</li>
</ul>
</section>
<section id="if-you-get-lost-or-confused">
<h2>If you get lost or confused…<a class="headerlink" href="#if-you-get-lost-or-confused" title="Link to this heading">#</a></h2>
<p>…then we want to know! We have a friendly
<a class="reference external" href="https://gitter.im/NSLS-II/DAMA">chat channel</a>, or you can
<a class="reference external" href="https://github.com/NSLS-II/Bug-Reports/issues">file a bug</a> to let us know
where our documentation could be made more clear.</p>
</section>
<section id="the-runengine">
<span id="tutorial-run-engine-setup"></span><h2>The RunEngine<a class="headerlink" href="#the-runengine" title="Link to this heading">#</a></h2>
<p>Bluesky encodes an experimental procedure as a <em>plan</em>, a sequence of
atomic instructions. The <em>RunEngine</em> is an interpreter for plans. It lets
us focus on the logic of our experimental procedure while it handles important
technical details consistently: it communicates with hardware, monitors for
interruptions, organizes metadata and data, coordinates I/O, and ensures that
the hardware is left in a safe state at exit time.</p>
<p>This separation of the executor (the RunEngine) from the instruction set (the
plan) pays off in several ways, as we will see in the examples that follow.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you are a visiting user at a facility that runs bluesky, you can skip
this section and go straight to <a class="reference internal" href="#common-experiments"><span class="std std-ref">Common Experiments (“Plans”)</span></a>. A RunEngine will
have already been configured for you. <strong>If you ignore this and define your
own, you may be overriding pre-configured defaults, which can result in
data loss.</strong></p>
<p>To check, type <code class="docutils literal notranslate"><span class="pre">RE</span></code>. If a RunEngine has already been configured, you
should get something like:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [1]: </span><span class="n">RE</span>
<span class="gh">Out[1]: </span><span class="go">&lt;bluesky.run_engine.RunEngine at 0x10fd1d978&gt;</span>
</pre></div>
</div>
<p>and you should skip the rest of this section. But if this gives you a
<code class="docutils literal notranslate"><span class="pre">NameError</span></code>, you’ll need to finish this section.</p>
</div>
<p>Create a RunEngine:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bluesky</span><span class="w"> </span><span class="kn">import</span> <span class="n">RunEngine</span>

<span class="n">RE</span> <span class="o">=</span> <span class="n">RunEngine</span><span class="p">({})</span>
</pre></div>
</div>
<p>This RunEngine is ready to use — but if you care about visualizing or saving
your data, there is more to do first….</p>
<p>During data acquisition, the RunEngine dispatches a live stream of metadata and
data to one or more consumers (“callbacks”) for in-line data processing and
visualization and long-term storage. Example consumers include a live-updating
plot, a curve-fitting algorithm, a database, a message queue, or a file in your
preferred format. See <a class="reference internal" href="callbacks.html"><span class="doc">Live Visualization and Processing</span></a> for more detail.</p>
<section id="prepare-live-visualization">
<h3>Prepare Live Visualization<a class="headerlink" href="#prepare-live-visualization" title="Link to this heading">#</a></h3>
<p>To start, let’s use the all-purpose
<code class="xref py py-class docutils literal notranslate"><span class="pre">BestEffortCallback</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bluesky.callbacks.best_effort</span><span class="w"> </span><span class="kn">import</span> <span class="n">BestEffortCallback</span>
<span class="n">bec</span> <span class="o">=</span> <span class="n">BestEffortCallback</span><span class="p">()</span>

<span class="c1"># Send all metadata/data captured to the BestEffortCallback.</span>
<span class="n">RE</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">bec</span><span class="p">)</span>
</pre></div>
</div>
<p>The <code class="xref py py-class docutils literal notranslate"><span class="pre">BestEffortCallback</span></code> will receive the
metadata/data in real time and produce plots and text, doing its best to
provide live feedback that strikes the right balance between “comprehensive”
and “overwhelming.”</p>
<p>For more tailored feedback, customized to a particular experiment, you may
configure custom callbacks. Start by reading up on <a class="reference internal" href="documents.html"><span class="doc">Documents</span></a>, the
structure into which bluesky organized metadata and data captured during an
experiment. But for this tutorial and for many real experiments, the
<code class="xref py py-class docutils literal notranslate"><span class="pre">BestEffortCallback</span></code> will suffice.</p>
</section>
<section id="prepare-data-storage">
<h3>Prepare Data Storage<a class="headerlink" href="#prepare-data-storage" title="Link to this heading">#</a></h3>
<p id="databroker-setup">The <a class="reference external" href="https://nsls-ii.github.io">databroker</a>, a library developed in tandem
with bluesky, is an interface to searchable storage for metadata and data
generated by bluesky. For this tutorial, we will spin up a databroker backed by
temporary files.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">databroker</span><span class="w"> </span><span class="kn">import</span> <span class="n">Broker</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">Broker</span><span class="o">.</span><span class="n">named</span><span class="p">(</span><span class="s1">&#39;temp&#39;</span><span class="p">)</span>

<span class="c1"># Insert all metadata/data captured into db.</span>
<span class="n">RE</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">insert</span><span class="p">)</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>This example makes a temporary database. Do not use it for important
data.</strong> The data will become difficult to access once Python exits or the
variable <code class="docutils literal notranslate"><span class="pre">db</span></code> is deleted. Running <code class="docutils literal notranslate"><span class="pre">Broker.named('temp')</span></code> a second time
creates a fresh, separate temporary database.</p>
</div>
</section>
<section id="add-a-progress-bar">
<h3>Add a Progress Bar<a class="headerlink" href="#add-a-progress-bar" title="Link to this heading">#</a></h3>
<p>Optionally, you can configure a progress bar.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bluesky.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">ProgressBarManager</span>
<span class="n">RE</span><span class="o">.</span><span class="n">waiting_hook</span> <span class="o">=</span> <span class="n">ProgressBarManager</span><span class="p">()</span>
</pre></div>
</div>
<p>See <a class="reference internal" href="progress-bar.html"><span class="doc">Progress Bar</span></a> for more details and configuration.</p>
<p>Let’s take some data!</p>
</section>
</section>
<section id="common-experiments-plans">
<span id="common-experiments"></span><h2>Common Experiments (“Plans”)<a class="headerlink" href="#common-experiments-plans" title="Link to this heading">#</a></h2>
<section id="read-some-detectors">
<h3>Read Some Detectors<a class="headerlink" href="#read-some-detectors" title="Link to this heading">#</a></h3>
<p>Begin with a very simple experiment: trigger and read some detectors. Bluesky
calls this “counting”, a term of art inherited from the spectroscopy
community.</p>
<p>For this tutorial, we will not assume that you have access to real detectors or
motors. In the examples that follow, we will use simulated hardware from
<a class="reference external" href="https://nsls-ii.github.io/ophyd">ophyd</a>, a library developed in tandem with
bluesky. In a <a class="reference internal" href="#tutorial-device"><span class="std std-ref">later section</span></a> we will see what it looks
like to configure <em>real</em> hardware with ophyd.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ophyd.sim</span><span class="w"> </span><span class="kn">import</span> <span class="n">det1</span><span class="p">,</span> <span class="n">det2</span>  <span class="c1"># two simulated detectors</span>
</pre></div>
</div>
<p>Using the RunEngine, <code class="docutils literal notranslate"><span class="pre">RE</span></code>, “count” the detectors:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bluesky.plans</span><span class="w"> </span><span class="kn">import</span> <span class="n">count</span>
<span class="n">dets</span> <span class="o">=</span> <span class="p">[</span><span class="n">det1</span><span class="p">,</span> <span class="n">det2</span><span class="p">]</span>   <span class="c1"># a list of any number of detectors</span>

<span class="n">RE</span><span class="p">(</span><span class="n">count</span><span class="p">(</span><span class="n">dets</span><span class="p">))</span>
</pre></div>
</div>
<p>Demo:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [2]: </span><span class="n">RE</span><span class="p">(</span><span class="n">count</span><span class="p">(</span><span class="n">dets</span><span class="p">))</span>


<span class="go">Transient Scan ID: 1     Time: 2025-06-14 23:17:28</span>
<span class="go">Persistent Unique Scan ID: &#39;028ae080-be41-4fb5-b78b-b0d9aba52357&#39;</span>
<span class="go">New stream: &#39;primary&#39;</span>
<span class="go">+-----------+------------+------------+------------+</span>
<span class="go">|   seq_num |       time |       det2 |       det1 |</span>
<span class="go">+-----------+------------+------------+------------+</span>
<span class="go">|         1 | 23:17:28.6 |      1.213 |      0.000 |</span>
<span class="go">+-----------+------------+------------+------------+</span>
<span class="go">generator count [&#39;028ae080&#39;] (scan num: 1)</span>



<span class="gh">Out[2]: </span><span class="go">(&#39;028ae080-be41-4fb5-b78b-b0d9aba52357&#39;,)</span>
</pre></div>
</div>
<p>A key feature of bluesky is that these detectors could be simple photodiodes or
complex CCDs. All of those details are captured in the implementation of the
Device. From the point of view of bluesky, detectors are just Python objects
with certain methods.</p>
<p>See <a class="reference internal" href="generated/bluesky.plans.count.html#bluesky.plans.count" title="bluesky.plans.count"><code class="xref py py-func docutils literal notranslate"><span class="pre">count()</span></code></a> for more options. You can also view this
documentation in IPython by typing <code class="docutils literal notranslate"><span class="pre">count?</span></code>.</p>
<p>Try the following variations:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># five consecutive readings</span>
<span class="n">RE</span><span class="p">(</span><span class="n">count</span><span class="p">(</span><span class="n">dets</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">5</span><span class="p">))</span>

<span class="c1"># five sequential readings separated by a 1-second delay</span>
<span class="n">RE</span><span class="p">(</span><span class="n">count</span><span class="p">(</span><span class="n">dets</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

<span class="c1"># a variable delay</span>
<span class="n">RE</span><span class="p">(</span><span class="n">count</span><span class="p">(</span><span class="n">dets</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">]))</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="generated/bluesky.plans.count.html#bluesky.plans.count" title="bluesky.plans.count"><code class="xref py py-func docutils literal notranslate"><span class="pre">count()</span></code></a> function (more precisely, Python <em>generator
function</em>) is an example of a <em>plan</em>, a sequence of instructions encoding an
experimental procedure. We’ll get a better sense for why this design is useful
as we continue. Briefly, it empowers us to:</p>
<ul class="simple">
<li><p>Introspect the instructions before we execute them, checking for accuracy,
safety, estimated duration, etc.</p></li>
<li><p>Interrupt and “rewind” the instructions to a safe point to resume from,
both interactively and automatically (e.g. in the middle of the night).</p></li>
<li><p>Reuse a generic set of instructions on different hardware.</p></li>
<li><p>Modify the instructions programmatically, such as inserting a set of
baseline readings to be taken automatically before every experiment.</p></li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Notice that entering a plan by itself doesn’t do anything:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [3]: </span><span class="n">count</span><span class="p">(</span><span class="n">dets</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="gh">Out[3]: </span><span class="go">&lt;generator object count at 0x7f2d9f69e200&gt;</span>
</pre></div>
</div>
<p>If we mean to <em>execute</em> the plan, we must use the RunEngine:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [4]: </span><span class="n">RE</span><span class="p">(</span><span class="n">count</span><span class="p">(</span><span class="n">dets</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>


<span class="go">Transient Scan ID: 2     Time: 2025-06-14 23:17:28</span>
<span class="go">Persistent Unique Scan ID: &#39;dbcef5f5-9702-484e-96f0-5fd495773769&#39;</span>
<span class="go">New stream: &#39;primary&#39;</span>
<span class="go">+-----------+------------+------------+</span>
<span class="go">|   seq_num |       time |        det |</span>
<span class="go">+-----------+------------+------------+</span>
<span class="go">|         1 | 23:17:28.8 |      0.000 |</span>
<span class="go">|         2 | 23:17:28.8 |      0.000 |</span>
<span class="go">|         3 | 23:17:28.9 |      0.000 |</span>
<span class="go">+-----------+------------+------------+</span>
<span class="go">generator count [&#39;dbcef5f5&#39;] (scan num: 2)</span>



<span class="gh">Out[4]: </span><span class="go">(&#39;dbcef5f5-9702-484e-96f0-5fd495773769&#39;,)</span>
</pre></div>
</div>
</div>
</section>
<section id="scan">
<h3>Scan<a class="headerlink" href="#scan" title="Link to this heading">#</a></h3>
<p>Use <a class="reference internal" href="generated/bluesky.plans.scan.html#bluesky.plans.scan" title="bluesky.plans.scan"><code class="xref py py-func docutils literal notranslate"><span class="pre">scan()</span></code></a> to scan <code class="docutils literal notranslate"><span class="pre">motor</span></code> from <code class="docutils literal notranslate"><span class="pre">-1</span></code> to <code class="docutils literal notranslate"><span class="pre">1</span></code> in ten
equally-spaced steps, wait for it to arrive at each step, and then trigger and
read some detector, <code class="docutils literal notranslate"><span class="pre">det</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ophyd.sim</span><span class="w"> </span><span class="kn">import</span> <span class="n">det</span><span class="p">,</span> <span class="n">motor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bluesky.plans</span><span class="w"> </span><span class="kn">import</span> <span class="n">scan</span>
<span class="n">dets</span> <span class="o">=</span> <span class="p">[</span><span class="n">det</span><span class="p">]</span>   <span class="c1"># just one in this case, but it could be more than one</span>

<span class="n">RE</span><span class="p">(</span><span class="n">scan</span><span class="p">(</span><span class="n">dets</span><span class="p">,</span> <span class="n">motor</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [5]: </span><span class="n">RE</span><span class="p">(</span><span class="n">scan</span><span class="p">(</span><span class="n">dets</span><span class="p">,</span> <span class="n">motor</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>


<span class="go">Transient Scan ID: 3     Time: 2025-06-14 23:17:29</span>
<span class="go">Persistent Unique Scan ID: &#39;ab5f1eb0-8948-45f8-a050-308e1c6cb0d0&#39;</span>
<span class="go">New stream: &#39;primary&#39;</span>
<span class="go">+-----------+------------+------------+------------+</span>
<span class="go">|   seq_num |       time |      motor |        det |</span>
<span class="go">+-----------+------------+------------+------------+</span>
<span class="go">|         1 | 23:17:29.1 |     -1.000 |      0.607 |</span>
<span class="go">|         2 | 23:17:29.2 |     -0.778 |      0.739 |</span>
<span class="go">|         3 | 23:17:29.2 |     -0.556 |      0.857 |</span>
<span class="go">|         4 | 23:17:29.3 |     -0.333 |      0.946 |</span>
<span class="go">|         5 | 23:17:29.3 |     -0.111 |      0.994 |</span>
<span class="go">|         6 | 23:17:29.4 |      0.111 |      0.994 |</span>
<span class="go">|         7 | 23:17:29.4 |      0.333 |      0.946 |</span>
<span class="go">|         8 | 23:17:29.5 |      0.556 |      0.857 |</span>
<span class="go">|         9 | 23:17:29.5 |      0.778 |      0.739 |</span>
<span class="go">|        10 | 23:17:29.6 |      1.000 |      0.607 |</span>
<span class="go">+-----------+------------+------------+------------+</span>
<span class="go">generator scan [&#39;ab5f1eb0&#39;] (scan num: 3)</span>



<span class="gh">Out[5]: </span><span class="go">(&#39;ab5f1eb0-8948-45f8-a050-308e1c6cb0d0&#39;,)</span>
</pre></div>
</div>
<figure class="align-default">
<img alt="_images/tutorial-1.png" class="plot-directive" src="_images/tutorial-1.png" />
</figure>
<p>Again, a key feature of bluesky is that <code class="docutils literal notranslate"><span class="pre">motor</span></code> may be any “movable” device,
including a temperature controller, a sample changer, or some pseudo-axis. From
the point of view of bluesky and the RunEngine, all of these are just objects
in Python with certain methods.</p>
<p>In addition the producing a table and plot, the
<code class="xref py py-class docutils literal notranslate"><span class="pre">BestEffortCallback</span></code> computes basic peak
statistics. Click on the plot area and press Shift+P (“peaks”) to visualize
them over the data. The numbers (center of mass, max, etc.) are available in a
dictionary stashed as <code class="docutils literal notranslate"><span class="pre">bec.peaks</span></code>. This is updated at the end of each run.
Of course, if peak statistics are not applicable, you may just ignore this
feature.</p>
<p>Use <a class="reference internal" href="generated/bluesky.plans.rel_scan.html#bluesky.plans.rel_scan" title="bluesky.plans.rel_scan"><code class="xref py py-func docutils literal notranslate"><span class="pre">rel_scan()</span></code></a> to scan from <code class="docutils literal notranslate"><span class="pre">-1</span></code> to <code class="docutils literal notranslate"><span class="pre">1</span></code> <em>relative to
the current position</em>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bluesky.plans</span><span class="w"> </span><span class="kn">import</span> <span class="n">rel_scan</span>

<span class="n">RE</span><span class="p">(</span><span class="n">rel_scan</span><span class="p">(</span><span class="n">dets</span><span class="p">,</span> <span class="n">motor</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
<p>Use <a class="reference internal" href="generated/bluesky.plans.list_scan.html#bluesky.plans.list_scan" title="bluesky.plans.list_scan"><code class="xref py py-func docutils literal notranslate"><span class="pre">list_scan()</span></code></a> to scan points with some arbitrary
spacing.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bluesky.plans</span><span class="w"> </span><span class="kn">import</span> <span class="n">list_scan</span>

<span class="n">points</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">13</span><span class="p">]</span>

<span class="n">RE</span><span class="p">(</span><span class="n">list_scan</span><span class="p">(</span><span class="n">dets</span><span class="p">,</span> <span class="n">motor</span><span class="p">,</span> <span class="n">points</span><span class="p">))</span>
</pre></div>
</div>
<p>For a complete list of scan variations and other plans, see <a class="reference internal" href="plans.html"><span class="doc">Plans</span></a>.</p>
</section>
<section id="scan-multiple-motors-together">
<span id="tutorial-multiple-motors"></span><h3>Scan Multiple Motors Together<a class="headerlink" href="#scan-multiple-motors-together" title="Link to this heading">#</a></h3>
<p>There are two different things we might mean by the phrase “scan multiple
motors ‘together’”. In this case we mean that we move N motors along a line in
M steps, such as moving X and Y motors along a diagonal. In the other case, we
move N motors through an (M_1 x M_2 x … x M_N) grid; that is addressed in the
next section.</p>
<p>SPEC users may recognize this case as analogous to an “a2scan” or “d2scan”, but
with an arbitrary number of dimensions, not just two.</p>
<p>We’ll use the same plans that we used in the previous section. (If you already
imported them, there is no need to do so again.)</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bluesky.plans</span><span class="w"> </span><span class="kn">import</span> <span class="n">scan</span><span class="p">,</span> <span class="n">rel_scan</span>
</pre></div>
</div>
<p>We’ll use two new motors and a new detector that is coupled to them via
a simulation. It simulates a 2D Gaussian peak centered at <code class="docutils literal notranslate"><span class="pre">(0,</span> <span class="pre">0)</span></code>.
Again, we emphasize that these “motors” could be anything that can be “set”
(temperature controller, pseudo-axis, sample changer).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ophyd.sim</span><span class="w"> </span><span class="kn">import</span> <span class="n">det4</span><span class="p">,</span> <span class="n">motor1</span><span class="p">,</span> <span class="n">motor2</span>
<span class="n">dets</span> <span class="o">=</span> <span class="p">[</span><span class="n">det4</span><span class="p">]</span>   <span class="c1"># just one in this case, but it could be more than one</span>
</pre></div>
</div>
<p>The plans <a class="reference internal" href="generated/bluesky.plans.scan.html#bluesky.plans.scan" title="bluesky.plans.scan"><code class="xref py py-func docutils literal notranslate"><span class="pre">scan()</span></code></a> and  <a class="reference internal" href="generated/bluesky.plans.rel_scan.html#bluesky.plans.rel_scan" title="bluesky.plans.rel_scan"><code class="xref py py-func docutils literal notranslate"><span class="pre">rel_scan()</span></code></a>
accept multiple motors.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">scan</span><span class="p">(</span><span class="n">dets</span><span class="p">,</span>
        <span class="n">motor1</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span>  <span class="c1"># scan motor1 from -1.5 to 1.5</span>
        <span class="n">motor2</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span>  <span class="c1"># ...while scanning motor2 from -0.1 to 0.1</span>
        <span class="mi">11</span><span class="p">))</span>  <span class="c1"># ...both in 11 steps</span>
</pre></div>
</div>
<p>The line breaks are intended to make the command easier to visually parse. They
are not technically meaningful; you may take them or leave them.</p>
<p>Demo:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [6]: </span><span class="n">RE</span><span class="p">(</span><span class="n">scan</span><span class="p">(</span><span class="n">dets</span><span class="p">,</span>
<span class="gp">   ...: </span>        <span class="n">motor1</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span>  <span class="c1"># scan motor1 from -1.5 to 1.5</span>
<span class="gp">   ...: </span>        <span class="n">motor2</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span>  <span class="c1"># ...while scanning motor2 from -0.1 to 0.1</span>
<span class="gp">   ...: </span>        <span class="mi">11</span><span class="p">))</span>  <span class="c1"># ...both in 11 steps</span>
<span class="gp">   ...: </span>


<span class="go">Transient Scan ID: 4     Time: 2025-06-14 23:17:30</span>
<span class="go">Persistent Unique Scan ID: &#39;9368b4cb-de1a-4169-9be6-679dc186e417&#39;</span>
<span class="go">New stream: &#39;primary&#39;</span>
<span class="go">+-----------+------------+------------+------------+------------+</span>
<span class="go">|   seq_num |       time |     motor1 |     motor2 |       det4 |</span>
<span class="go">+-----------+------------+------------+------------+------------+</span>
<span class="go">|         1 | 23:17:30.7 |     -1.500 |     -0.100 |      0.323 |</span>
<span class="go">|         2 | 23:17:30.8 |     -1.200 |     -0.080 |      0.485 |</span>
<span class="go">|         3 | 23:17:30.8 |     -0.900 |     -0.060 |      0.666 |</span>
<span class="go">|         4 | 23:17:30.9 |     -0.600 |     -0.040 |      0.835 |</span>
<span class="go">|         5 | 23:17:30.9 |     -0.300 |     -0.020 |      0.956 |</span>
<span class="go">|         6 | 23:17:31.0 |      0.000 |      0.000 |      1.000 |</span>
<span class="go">|         7 | 23:17:31.0 |      0.300 |      0.020 |      0.956 |</span>
<span class="go">|         8 | 23:17:31.1 |      0.600 |      0.040 |      0.835 |</span>
<span class="go">|         9 | 23:17:31.1 |      0.900 |      0.060 |      0.666 |</span>
<span class="go">|        10 | 23:17:31.2 |      1.200 |      0.080 |      0.485 |</span>
<span class="go">|        11 | 23:17:31.2 |      1.500 |      0.100 |      0.323 |</span>
<span class="go">+-----------+------------+------------+------------+------------+</span>
<span class="go">generator scan [&#39;9368b4cb&#39;] (scan num: 4)</span>



<span class="gh">Out[6]: </span><span class="go">(&#39;9368b4cb-de1a-4169-9be6-679dc186e417&#39;,)</span>
</pre></div>
</div>
<figure class="align-default">
<img alt="_images/tutorial-2.png" class="plot-directive" src="_images/tutorial-2.png" />
</figure>
<p>This works for any number of motors, not just two. Try importing <code class="docutils literal notranslate"><span class="pre">motor3</span></code>
from <code class="docutils literal notranslate"><span class="pre">ophyd.sim</span></code> and running a 3-motor scan.</p>
<p>To move motors along arbitrary trajectories instead of equally-spaced points,
use <a class="reference internal" href="generated/bluesky.plans.list_scan.html#bluesky.plans.list_scan" title="bluesky.plans.list_scan"><code class="xref py py-func docutils literal notranslate"><span class="pre">list_scan()</span></code></a> and <a class="reference internal" href="generated/bluesky.plans.rel_list_scan.html#bluesky.plans.rel_list_scan" title="bluesky.plans.rel_list_scan"><code class="xref py py-func docutils literal notranslate"><span class="pre">rel_list_scan()</span></code></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bluesky.plans</span><span class="w"> </span><span class="kn">import</span> <span class="n">list_scan</span>

<span class="c1"># Scan motor1 and motor2 jointly through a 5-point trajectory.</span>
<span class="n">RE</span><span class="p">(</span><span class="n">list_scan</span><span class="p">(</span><span class="n">dets</span><span class="p">,</span> <span class="n">motor1</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> <span class="n">motor2</span><span class="p">,</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
</pre></div>
</div>
<p>Demo:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [7]: </span><span class="n">RE</span><span class="p">(</span><span class="n">list_scan</span><span class="p">(</span><span class="n">dets</span><span class="p">,</span>
<span class="gp">   ...: </span>             <span class="n">motor1</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span>
<span class="gp">   ...: </span>             <span class="n">motor2</span><span class="p">,</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">]))</span>
<span class="gp">   ...: </span>


<span class="go">Transient Scan ID: 5     Time: 2025-06-14 23:17:32</span>
<span class="go">Persistent Unique Scan ID: &#39;801b9ac4-107b-4d03-819b-5628a70de2b0&#39;</span>
<span class="go">New stream: &#39;primary&#39;</span>
<span class="go">+-----------+------------+------------+------------+------------+</span>
<span class="go">|   seq_num |       time |     motor1 |     motor2 |       det4 |</span>
<span class="go">+-----------+------------+------------+------------+------------+</span>
<span class="go">|         1 | 23:17:32.5 |      1.000 |     25.000 |      0.000 |</span>
<span class="go">|         2 | 23:17:32.6 |      1.000 |     16.000 |      0.000 |</span>
<span class="go">|         3 | 23:17:32.6 |      3.000 |      9.000 |      0.000 |</span>
<span class="go">|         4 | 23:17:32.7 |      5.000 |      4.000 |      0.000 |</span>
<span class="go">|         5 | 23:17:32.7 |      8.000 |      1.000 |      0.000 |</span>
<span class="go">+-----------+------------+------------+------------+------------+</span>
<span class="go">generator list_scan [&#39;801b9ac4&#39;] (scan num: 5)</span>



<span class="gh">Out[7]: </span><span class="go">(&#39;801b9ac4-107b-4d03-819b-5628a70de2b0&#39;,)</span>
</pre></div>
</div>
<figure class="align-default">
<img alt="_images/tutorial-3.png" class="plot-directive" src="_images/tutorial-3.png" />
</figure>
</section>
<section id="scan-multiple-motors-in-a-grid">
<h3>Scan Multiple Motors in a Grid<a class="headerlink" href="#scan-multiple-motors-in-a-grid" title="Link to this heading">#</a></h3>
<p>In this case scan N motors through an N-dimensional rectangular grid. We’ll use
the same simulated hardware as in the previous section:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ophyd.sim</span><span class="w"> </span><span class="kn">import</span> <span class="n">det4</span><span class="p">,</span> <span class="n">motor1</span><span class="p">,</span> <span class="n">motor2</span><span class="p">,</span> <span class="n">motor3</span>
<span class="n">dets</span> <span class="o">=</span> <span class="p">[</span><span class="n">det4</span><span class="p">]</span>   <span class="c1"># just one in this case, but it could be more than one</span>
</pre></div>
</div>
<p>We’ll use a new plan, named <a class="reference internal" href="generated/bluesky.plans.grid_scan.html#bluesky.plans.grid_scan" title="bluesky.plans.grid_scan"><code class="xref py py-func docutils literal notranslate"><span class="pre">grid_scan()</span></code></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bluesky.plans</span><span class="w"> </span><span class="kn">import</span> <span class="n">grid_scan</span>
</pre></div>
</div>
<p>Let’s start with a 3x5x5 grid.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">grid_scan</span><span class="p">(</span><span class="n">dets</span><span class="p">,</span>
             <span class="n">motor1</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>  <span class="c1"># scan motor1 from -1.5 to 1.5 in 3 steps</span>
             <span class="n">motor2</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>  <span class="c1"># scan motor2 from -0.1 to 0.1 in 5 steps</span>
             <span class="n">motor3</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>  <span class="c1"># scan motor3 from 10 to -10 in 5 steps</span>
</pre></div>
</div>
<p>Note that this will not plot an output as it is more axes than can currently be
displayed.</p>
<p>The order of the motors controls how the grid is traversed. The “slowest” axis
comes first. Numpy users will appreciate that this is consistent with numpy’s
convention for indexing multidimensional arrays.</p>
<p>The optional parameter <code class="docutils literal notranslate"><span class="pre">snake_axes</span></code> can be used to control which motors’
trajectories “snake” back and forth. A snake-like path is usually more
efficient, but it is not suitable for certain hardware, so it is disabled by
default. To enable snaking for specific axes, give a list like
<code class="docutils literal notranslate"><span class="pre">snake_axes=[motor2]</span></code>.  Since the first (slowest) axis is only traversed
once, it is not eligible to be included in <code class="docutils literal notranslate"><span class="pre">snake_axes</span></code>. As a convenience,
you may use <code class="docutils literal notranslate"><span class="pre">snake_axes=True</span></code> to enable snaking for all except that first
axis.</p>
<figure class="align-default">
<img alt="_images/tutorial-4.png" class="plot-directive" src="_images/tutorial-4.png" />
</figure>
<p>Demo:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [8]: </span><span class="n">RE</span><span class="p">(</span><span class="n">grid_scan</span><span class="p">(</span><span class="n">dets</span><span class="p">,</span>
<span class="gp">   ...: </span>             <span class="n">motor1</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>  <span class="c1"># scan motor1 from -1.5 to 1.5 in 3 steps</span>
<span class="gp">   ...: </span>             <span class="n">motor2</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>  <span class="c1"># scan motor2 from -0.1 to 0.1 in 5 steps</span>
<span class="gp">   ...: </span>


<span class="go">Transient Scan ID: 6     Time: 2025-06-14 23:17:35</span>
<span class="go">Persistent Unique Scan ID: &#39;aab9845c-0a82-4af1-8101-06069cbcd26c&#39;</span>
<span class="go">New stream: &#39;primary&#39;</span>
<span class="go">+-----------+------------+------------+------------+------------+</span>
<span class="go">|   seq_num |       time |     motor1 |     motor2 |       det4 |</span>
<span class="go">+-----------+------------+------------+------------+------------+</span>
<span class="go">|         1 | 23:17:35.1 |     -1.500 |     -0.100 |      0.323 |</span>
<span class="go">|         2 | 23:17:35.2 |     -1.500 |     -0.050 |      0.324 |</span>
<span class="go">|         3 | 23:17:35.3 |     -1.500 |      0.000 |      0.325 |</span>
<span class="go">|         4 | 23:17:35.4 |     -1.500 |      0.050 |      0.324 |</span>
<span class="go">|         5 | 23:17:35.5 |     -1.500 |      0.100 |      0.323 |</span>
<span class="go">|         6 | 23:17:35.6 |      0.000 |     -0.100 |      0.995 |</span>
<span class="go">|         7 | 23:17:35.7 |      0.000 |     -0.050 |      0.999 |</span>
<span class="go">|         8 | 23:17:35.8 |      0.000 |      0.000 |      1.000 |</span>
<span class="go">|         9 | 23:17:35.9 |      0.000 |      0.050 |      0.999 |</span>
<span class="go">|        10 | 23:17:36.0 |      0.000 |      0.100 |      0.995 |</span>
<span class="go">|        11 | 23:17:36.1 |      1.500 |     -0.100 |      0.323 |</span>
<span class="go">|        12 | 23:17:36.1 |      1.500 |     -0.050 |      0.324 |</span>
<span class="go">|        13 | 23:17:36.2 |      1.500 |      0.000 |      0.325 |</span>
<span class="go">|        14 | 23:17:36.3 |      1.500 |      0.050 |      0.324 |</span>
<span class="go">|        15 | 23:17:36.4 |      1.500 |      0.100 |      0.323 |</span>
<span class="go">+-----------+------------+------------+------------+------------+</span>
<span class="go">generator grid_scan [&#39;aab9845c&#39;] (scan num: 6)</span>



<span class="gh">Out[8]: </span><span class="go">(&#39;aab9845c-0a82-4af1-8101-06069cbcd26c&#39;,)</span>
</pre></div>
</div>
<figure class="align-default">
<img alt="_images/tutorial-5.png" class="plot-directive" src="_images/tutorial-5.png" />
</figure>
<p>To move motors along arbitrary trajectories instead of equally-spaced points,
use <a class="reference internal" href="generated/bluesky.plans.list_grid_scan.html#bluesky.plans.list_grid_scan" title="bluesky.plans.list_grid_scan"><code class="xref py py-func docutils literal notranslate"><span class="pre">list_grid_scan()</span></code></a> and
<a class="reference internal" href="generated/bluesky.plans.rel_list_grid_scan.html#bluesky.plans.rel_list_grid_scan" title="bluesky.plans.rel_list_grid_scan"><code class="xref py py-func docutils literal notranslate"><span class="pre">rel_list_grid_scan()</span></code></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bluesky.plans</span><span class="w"> </span><span class="kn">import</span> <span class="n">list_grid_scan</span>

<span class="n">RE</span><span class="p">(</span><span class="n">list_grid_scan</span><span class="p">(</span><span class="n">dets</span><span class="p">,</span>
                  <span class="n">motor1</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
                  <span class="n">motor2</span><span class="p">,</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">9</span><span class="p">]))</span>
</pre></div>
</div>
<p>Demo:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [9]: </span><span class="n">RE</span><span class="p">(</span><span class="n">list_grid_scan</span><span class="p">(</span><span class="n">dets</span><span class="p">,</span>
<span class="gp">   ...: </span>                  <span class="n">motor1</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">],</span>
<span class="gp">   ...: </span>                  <span class="n">motor2</span><span class="p">,</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">9</span><span class="p">]))</span>
<span class="gp">   ...: </span>


<span class="go">Transient Scan ID: 7     Time: 2025-06-14 23:17:38</span>
<span class="go">Persistent Unique Scan ID: &#39;54bf8558-57e0-4b17-9e46-b8cbbfed83d2&#39;</span>
<span class="go">New stream: &#39;primary&#39;</span>
<span class="go">+-----------+------------+------------+------------+------------+</span>
<span class="go">|   seq_num |       time |     motor1 |     motor2 |       det4 |</span>
<span class="go">+-----------+------------+------------+------------+------------+</span>
<span class="go">|         1 | 23:17:38.8 |      1.000 |     25.000 |      0.000 |</span>
<span class="go">|         2 | 23:17:38.9 |      1.000 |     16.000 |      0.000 |</span>
<span class="go">|         3 | 23:17:38.9 |      1.000 |      9.000 |      0.000 |</span>
<span class="go">|         4 | 23:17:39.0 |      1.000 |     25.000 |      0.000 |</span>
<span class="go">|         5 | 23:17:39.1 |      1.000 |     16.000 |      0.000 |</span>
<span class="go">|         6 | 23:17:39.2 |      1.000 |      9.000 |      0.000 |</span>
<span class="go">|         7 | 23:17:39.2 |      2.000 |     25.000 |      0.000 |</span>
<span class="go">|         8 | 23:17:39.3 |      2.000 |     16.000 |      0.000 |</span>
<span class="go">|         9 | 23:17:39.4 |      2.000 |      9.000 |      0.000 |</span>
<span class="go">|        10 | 23:17:39.5 |      3.000 |     25.000 |      0.000 |</span>
<span class="go">|        11 | 23:17:39.5 |      3.000 |     16.000 |      0.000 |</span>
<span class="go">|        12 | 23:17:39.6 |      3.000 |      9.000 |      0.000 |</span>
<span class="go">|        13 | 23:17:39.7 |      5.000 |     25.000 |      0.000 |</span>
<span class="go">|        14 | 23:17:39.8 |      5.000 |     16.000 |      0.000 |</span>
<span class="go">|        15 | 23:17:39.8 |      5.000 |      9.000 |      0.000 |</span>
<span class="go">+-----------+------------+------------+------------+------------+</span>
<span class="go">generator list_grid_scan [&#39;54bf8558&#39;] (scan num: 7)</span>



<span class="gh">Out[9]: </span><span class="go">(&#39;54bf8558-57e0-4b17-9e46-b8cbbfed83d2&#39;,)</span>
</pre></div>
</div>
<figure class="align-default">
<img alt="_images/tutorial-6.png" class="plot-directive" src="_images/tutorial-6.png" />
</figure>
<p>See <a class="reference internal" href="plans.html#multi-dimensional-scans"><span class="std std-ref">Multi-dimensional scans</span></a> to handle more specialized cases, including
combinations of <a class="reference internal" href="generated/bluesky.plans.scan.html#bluesky.plans.scan" title="bluesky.plans.scan"><code class="xref py py-func docutils literal notranslate"><span class="pre">scan()</span></code></a>-like and
<a class="reference internal" href="generated/bluesky.plans.grid_scan.html#bluesky.plans.grid_scan" title="bluesky.plans.grid_scan"><code class="xref py py-func docutils literal notranslate"><span class="pre">grid_scan()</span></code></a>-like movement.</p>
<p>More generally, the <a class="reference internal" href="plans.html"><span class="doc">Plans</span></a> documentation includes more exotic
trajectories, such as spirals, and plans with adaptive logic, such as
efficient peak-finders.</p>
</section>
</section>
<section id="aside-access-saved-data">
<h2>Aside: Access Saved Data<a class="headerlink" href="#aside-access-saved-data" title="Link to this heading">#</a></h2>
<p>At this point it is natural to wonder, “How do I access my saved data?”
From the point of view of <em>bluesky</em>, that’s really not bluesky’s concern, but
it’s a reasonable question, so we’ll address a typical scenario.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This section presumes that you are using the databroker. (We configured
one in <a class="reference internal" href="#databroker-setup"><span class="std std-ref">an earlier section of this tutorial</span></a>.)
You don’t have to use the databroker to use bluesky; it’s just
one convenient way to capture the metadata and data generated by the
RunEngine.</p>
</div>
<p>Very briefly, you can access saved data by referring to a dataset (a “run”) by
its unique ID, which is returned by the RunEngine at collection time.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [10]: </span><span class="kn">from</span><span class="w"> </span><span class="nn">bluesky.plans</span><span class="w"> </span><span class="kn">import</span> <span class="n">count</span>

<span class="gp">In [11]: </span><span class="kn">from</span><span class="w"> </span><span class="nn">ophyd.sim</span><span class="w"> </span><span class="kn">import</span> <span class="n">det</span>

<span class="gp">In [12]: </span><span class="n">uid</span><span class="p">,</span> <span class="o">=</span> <span class="n">RE</span><span class="p">(</span><span class="n">count</span><span class="p">([</span><span class="n">det</span><span class="p">],</span> <span class="n">num</span><span class="o">=</span><span class="mi">3</span><span class="p">))</span>


<span class="go">Transient Scan ID: 8     Time: 2025-06-14 23:17:41</span>
<span class="go">Persistent Unique Scan ID: &#39;4446b36e-c752-44b7-a025-1bd0e0cc2904&#39;</span>
<span class="go">New stream: &#39;primary&#39;</span>
<span class="go">+-----------+------------+------------+</span>
<span class="go">|   seq_num |       time |        det |</span>
<span class="go">+-----------+------------+------------+</span>
<span class="go">|         1 | 23:17:41.7 |      0.607 |</span>
<span class="go">|         2 | 23:17:41.7 |      0.607 |</span>
<span class="go">|         3 | 23:17:41.8 |      0.607 |</span>
<span class="go">+-----------+------------+------------+</span>
<span class="go">generator count [&#39;4446b36e&#39;] (scan num: 8)</span>




<span class="gp">In [13]: </span><span class="n">header</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">uid</span><span class="p">]</span>
</pre></div>
</div>
<p>Alternatively, perhaps more conveniently, you can access it by recency:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [14]: </span><span class="n">header</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># meaning &#39;1 run ago&#39;, i.e. the most recent run</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We assumed above that the plan generated one “run” (dataset), which is
typical for simple plans like <a class="reference internal" href="generated/bluesky.plans.count.html#bluesky.plans.count" title="bluesky.plans.count"><code class="xref py py-func docutils literal notranslate"><span class="pre">count()</span></code></a>. In the
<em>general</em> case, a plan can generate multiple runs, returning multiple uids,
which in turn causes <code class="docutils literal notranslate"><span class="pre">db</span></code> to return a list of headers, not just one.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">uids</span> <span class="o">=</span> <span class="n">RE</span><span class="p">(</span><span class="n">some_plan</span><span class="p">(</span><span class="o">...</span><span class="p">))</span>
<span class="n">headers</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="n">uids</span><span class="p">]</span>  <span class="c1"># list of Headers</span>
</pre></div>
</div>
</div>
<p>Most of the useful metadata is in this dictionary:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [15]: </span><span class="n">header</span><span class="o">.</span><span class="n">start</span>
<span class="gh">Out[15]: </span>
<span class="go">{&#39;uid&#39;: &#39;4446b36e-c752-44b7-a025-1bd0e0cc2904&#39;,</span>
<span class="go"> &#39;time&#39;: 1749943061.7041283,</span>
<span class="go"> &#39;versions&#39;: {&#39;ophyd&#39;: &#39;1.10.6&#39;, &#39;bluesky&#39;: &#39;1.14.3.dev4+gd2e3cb7a&#39;},</span>
<span class="go"> &#39;scan_id&#39;: 8,</span>
<span class="go"> &#39;plan_type&#39;: &#39;generator&#39;,</span>
<span class="go"> &#39;plan_name&#39;: &#39;count&#39;,</span>
<span class="go"> &#39;detectors&#39;: [&#39;det&#39;],</span>
<span class="go"> &#39;num_points&#39;: 3,</span>
<span class="go"> &#39;num_intervals&#39;: 2,</span>
<span class="go"> &#39;plan_args&#39;: {&#39;detectors&#39;: [&quot;SynGauss(prefix=&#39;&#39;, name=&#39;det&#39;, read_attrs=[&#39;val&#39;], configuration_attrs=[&#39;Imax&#39;, &#39;center&#39;, &#39;sigma&#39;, &#39;noise&#39;, &#39;noise_multiplier&#39;])&quot;],</span>
<span class="go">  &#39;num&#39;: 3,</span>
<span class="go">  &#39;delay&#39;: 0.0},</span>
<span class="go"> &#39;hints&#39;: {&#39;dimensions&#39;: [[[&#39;time&#39;], &#39;primary&#39;]]}}</span>
</pre></div>
</div>
<p>And the (“primary”) stream of data is accessible like so:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [16]: </span><span class="n">header</span><span class="o">.</span><span class="n">table</span><span class="p">()</span>  <span class="c1"># return a table (a pandas.DataFrame)</span>
<span class="gh">Out[16]: </span>
<span class="go">                                 time       det</span>
<span class="go">seq_num                                        </span>
<span class="go">1       2025-06-14 23:17:41.717010498  0.606531</span>
<span class="go">2       2025-06-14 23:17:41.781659126  0.606531</span>
<span class="go">3       2025-06-14 23:17:41.832290411  0.606531</span>
</pre></div>
</div>
<p>From here we refer to the
<a class="reference external" href="https://nsls-ii.github.io/databroker/tutorial.html">databroker tutorial</a>.</p>
</section>
<section id="simple-customization">
<span id="tutorial-simple-customization"></span><h2>Simple Customization<a class="headerlink" href="#simple-customization" title="Link to this heading">#</a></h2>
<section id="save-some-typing-with-partial">
<h3>Save Some Typing with ‘Partial’<a class="headerlink" href="#save-some-typing-with-partial" title="Link to this heading">#</a></h3>
<p>Suppose we nearly always use the same detector(s) and we tire of typing out
<code class="docutils literal notranslate"><span class="pre">count([det])</span></code>. We can write a custom variant of <a class="reference internal" href="generated/bluesky.plans.count.html#bluesky.plans.count" title="bluesky.plans.count"><code class="xref py py-func docutils literal notranslate"><span class="pre">count()</span></code></a>
using a built-in function provided by Python itself, <a class="reference external" href="https://docs.python.org/3/library/functools.html#functools.partial" title="(in Python v3.13)"><code class="xref py py-func docutils literal notranslate"><span class="pre">functools.partial()</span></code></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">functools</span><span class="w"> </span><span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bluesky.plans</span><span class="w"> </span><span class="kn">import</span> <span class="n">count</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ophyd.sim</span><span class="w"> </span><span class="kn">import</span> <span class="n">det</span>

<span class="n">my_count</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="p">[</span><span class="n">det</span><span class="p">])</span>
<span class="n">RE</span><span class="p">(</span><span class="n">my_count</span><span class="p">())</span>  <span class="c1"># equivalent to RE(count([det]))</span>

<span class="c1"># Additional arguments to my_count() are passed through to count().</span>
<span class="n">RE</span><span class="p">(</span><span class="n">my_count</span><span class="p">(</span><span class="n">num</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">delay</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
</section>
<section id="plans-in-series">
<h3>Plans in Series<a class="headerlink" href="#plans-in-series" title="Link to this heading">#</a></h3>
<p>A custom plan can dispatch out to other plans using the Python syntax
<code class="docutils literal notranslate"><span class="pre">yield</span> <span class="pre">from</span></code>. (See <a class="reference internal" href="appendix.html#yield-from-primer"><span class="std std-ref">appendix</span></a> if you want to know
why.) Examples:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bluesky.plans</span><span class="w"> </span><span class="kn">import</span> <span class="n">scan</span>

<span class="k">def</span><span class="w"> </span><span class="nf">coarse_and_fine</span><span class="p">(</span><span class="n">detectors</span><span class="p">,</span> <span class="n">motor</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">):</span>
    <span class="s2">&quot;Scan from &#39;start&#39; to &#39;stop&#39; in 10 steps and then again in 100 steps.&quot;</span>
    <span class="k">yield from</span> <span class="n">scan</span><span class="p">(</span><span class="n">detectors</span><span class="p">,</span> <span class="n">motor</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="k">yield from</span> <span class="n">scan</span><span class="p">(</span><span class="n">detectors</span><span class="p">,</span> <span class="n">motor</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="n">RE</span><span class="p">(</span><span class="n">coarse_and_fine</span><span class="p">(</span><span class="n">dets</span><span class="p">,</span> <span class="n">motor</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
</pre></div>
</div>
<p>All of the plans introduced thus far, which we imported from
<code class="xref py py-mod docutils literal notranslate"><span class="pre">bluesky.plans</span></code>, generate data sets (“runs”). Plans in the
<code class="xref py py-mod docutils literal notranslate"><span class="pre">bluesky.plan_stubs</span></code> module do smaller operations. They can be used alone
or combined to build custom plans.</p>
<p>The <a class="reference internal" href="generated/bluesky.plan_stubs.mv.html#bluesky.plan_stubs.mv" title="bluesky.plan_stubs.mv"><code class="xref py py-func docutils literal notranslate"><span class="pre">mv()</span></code></a> plan moves one or more devices and waits for
them all to arrive.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bluesky.plan_stubs</span><span class="w"> </span><span class="kn">import</span> <span class="n">mv</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ophyd.sim</span><span class="w"> </span><span class="kn">import</span> <span class="n">motor1</span><span class="p">,</span> <span class="n">motor2</span>

<span class="c1"># Move motor1 to 1 and motor2 to 10, simultaneously. Wait for both to arrive.</span>
<span class="n">RE</span><span class="p">(</span><span class="n">mv</span><span class="p">(</span><span class="n">motor1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">motor2</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
<p>We can combine <a class="reference internal" href="generated/bluesky.plan_stubs.mv.html#bluesky.plan_stubs.mv" title="bluesky.plan_stubs.mv"><code class="xref py py-func docutils literal notranslate"><span class="pre">mv()</span></code></a> and <a class="reference internal" href="generated/bluesky.plans.count.html#bluesky.plans.count" title="bluesky.plans.count"><code class="xref py py-func docutils literal notranslate"><span class="pre">count()</span></code></a>
into one plan like so:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">move_then_count</span><span class="p">():</span>
    <span class="s2">&quot;Move motor1 and motor2 into position; then count det.&quot;</span>
    <span class="k">yield from</span> <span class="n">mv</span><span class="p">(</span><span class="n">motor1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">motor2</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="k">yield from</span> <span class="n">count</span><span class="p">(</span><span class="n">dets</span><span class="p">)</span>

<span class="n">RE</span><span class="p">(</span><span class="n">move_then_count</span><span class="p">())</span>
</pre></div>
</div>
<p>It’s very important to remember the <code class="docutils literal notranslate"><span class="pre">yield</span> <span class="pre">from</span></code>. The following plan does
nothing at all! (The plans inside it will be <em>defined</em> but never executed.)</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># WRONG EXAMPLE!</span>

<span class="k">def</span><span class="w"> </span><span class="nf">oops</span><span class="p">():</span>
    <span class="s2">&quot;Forgot &#39;yield from&#39;!&quot;</span>
    <span class="n">mv</span><span class="p">(</span><span class="n">motor1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">motor2</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
    <span class="n">count</span><span class="p">(</span><span class="n">dets</span><span class="p">)</span>
</pre></div>
</div>
<p>Much richer customization is possible, but we’ll leave that for a
<a class="reference internal" href="#tutorial-custom-plans"><span class="std std-ref">a later section of this tutorial</span></a>. See also the
complete list of <a class="reference internal" href="plans.html#stub-plans"><span class="std std-ref">plan stubs</span></a>.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>Never put ``RE(…)`` inside a loop or a function. You should always call
it directly — typed by the user at the terminal — and only once.</strong></p>
<p>You might be tempted to write a script like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bluesky.plans</span><span class="w"> </span><span class="kn">import</span> <span class="n">scan</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ophyd.sim</span><span class="w"> </span><span class="kn">import</span> <span class="n">motor</span><span class="p">,</span> <span class="n">det</span>

<span class="c1"># Don&#39;t do this!</span>
<span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]:</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="s1">&#39;steps&#39;</span><span class="p">)</span>
    <span class="n">RE</span><span class="p">(</span><span class="n">scan</span><span class="p">([</span><span class="n">det</span><span class="p">],</span> <span class="n">motor</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">j</span><span class="p">)))</span>
</pre></div>
</div>
<p>Or a function like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Don&#39;t do this!</span>
<span class="k">def</span><span class="w"> </span><span class="nf">bad_function</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="s1">&#39;steps&#39;</span><span class="p">)</span>
        <span class="n">RE</span><span class="p">(</span><span class="n">scan</span><span class="p">([</span><span class="n">det</span><span class="p">],</span> <span class="n">motor</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">j</span><span class="p">)))</span>
</pre></div>
</div>
<p>But, instead, you should do this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bluesky.plans</span><span class="w"> </span><span class="kn">import</span> <span class="n">scan</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ophyd.sim</span><span class="w"> </span><span class="kn">import</span> <span class="n">motor</span><span class="p">,</span> <span class="n">det</span>

<span class="k">def</span><span class="w"> </span><span class="nf">good_plan</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">j</span><span class="p">,</span> <span class="s1">&#39;steps&#39;</span><span class="p">)</span>
        <span class="k">yield from</span> <span class="n">scan</span><span class="p">([</span><span class="n">det</span><span class="p">],</span> <span class="n">motor</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="n">j</span><span class="p">)</span>

<span class="n">RE</span><span class="p">(</span><span class="n">my_plan</span><span class="p">())</span>
</pre></div>
</div>
<p>If you try to hide <code class="docutils literal notranslate"><span class="pre">RE</span></code> inside a function, someone later might
use that function inside another function, and now we’re entering and
exiting the RunEngine multiple times from a single prompt. This can lead
to unexpected behavior, especially around handling interruptions and
errors.</p>
<p>To indulge a musical metaphor, the plan is the sheet music, the hardware is
the orchestra, and the RunEngine is the conductor. There should be only
one conductor and she needs to run whole show, start to finish.</p>
</div>
</section>
</section>
<section id="baseline-readings-and-other-supplemental-data">
<h2>“Baseline” Readings (and other Supplemental Data)<a class="headerlink" href="#baseline-readings-and-other-supplemental-data" title="Link to this heading">#</a></h2>
<p>In addition to the detector(s) and motor(s) of primary interest during an
experiment, it is commonly useful to take a snapshot (“baseline reading”) of
other hardware. This information is typically used to check consistency over
time. (“Is the temperature of the sample mount roughly the same as it was last
week?”) Ideally, we’d like to <em>automatically</em> capture readings from these
devices during all future experiments without any extra thought or typing per
experiment. Bluesky provides a specific solution for this.</p>
<section id="configure">
<h3>Configure<a class="headerlink" href="#configure" title="Link to this heading">#</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you are visiting user at a facility that runs bluesky, you may not need
to do this configuration, and you can skip the next subsection just below
— <a class="reference internal" href="#choose-baseline-devices"><span class="std std-ref">Choose “Baseline” Devices</span></a>.</p>
<p>You can type <code class="docutils literal notranslate"><span class="pre">sd</span></code> to check. If you get something like:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [17]: </span><span class="n">sd</span>
<span class="gh">Out[17]: </span><span class="go">SupplementalData(baseline=[], monitors=[], flyers=[])</span>
</pre></div>
</div>
<p>you should skip this configuration.</p>
</div>
<p>Before we begin, we have to do a little more RunEngine configuration, like what
we did in the <a class="reference internal" href="#tutorial-run-engine-setup"><span class="std std-ref">The RunEngine</span></a> section with <code class="docutils literal notranslate"><span class="pre">RE.subscribe</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bluesky.preprocessors</span><span class="w"> </span><span class="kn">import</span> <span class="n">SupplementalData</span>

<span class="n">sd</span> <span class="o">=</span> <span class="n">SupplementalData</span><span class="p">()</span>
<span class="n">RE</span><span class="o">.</span><span class="n">preprocessors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="choose-baseline-devices">
<span id="id1"></span><h3>Choose “Baseline” Devices<a class="headerlink" href="#choose-baseline-devices" title="Link to this heading">#</a></h3>
<p>We’ll choose the detectors/motors that we want to be read automatically at the
beginning and end of each dataset (“run”). If you are using a shared
configuration, this also might already have been done, so you should check the
content of <code class="docutils literal notranslate"><span class="pre">sd.baseline</span></code> before altering it.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [18]: </span><span class="n">sd</span><span class="o">.</span><span class="n">baseline</span>  <span class="c1"># currently empty</span>
<span class="gh">Out[18]: </span><span class="go">[]</span>
</pre></div>
</div>
<p>Suppose that we want to take baseline readings from three detectors and two
motors. We’ll import a handful of simulated devices for this purpose, put them
into a list, and assign <code class="docutils literal notranslate"><span class="pre">sd.baseline</span></code>.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [19]: </span><span class="kn">from</span><span class="w"> </span><span class="nn">ophyd.sim</span><span class="w"> </span><span class="kn">import</span> <span class="n">det1</span><span class="p">,</span> <span class="n">det2</span><span class="p">,</span> <span class="n">det3</span><span class="p">,</span> <span class="n">motor1</span><span class="p">,</span> <span class="n">motor2</span>

<span class="gp">In [20]: </span><span class="n">sd</span><span class="o">.</span><span class="n">baseline</span> <span class="o">=</span> <span class="p">[</span><span class="n">det1</span><span class="p">,</span> <span class="n">det2</span><span class="p">,</span> <span class="n">det3</span><span class="p">,</span> <span class="n">motor1</span><span class="p">,</span> <span class="n">motor2</span><span class="p">]</span>
</pre></div>
</div>
<p>Notice that we can put a mixture of detectors and motors in this list. It
doesn’t matter to bluesky that some are movable and some are not because it’s
just going to be <em>reading</em> them, and both detectors and motors can be read.</p>
</section>
<section id="use">
<h3>Use<a class="headerlink" href="#use" title="Link to this heading">#</a></h3>
<p>Now we can just do a scan with the detector and motor of primary interest. The
RunEngine will automatically take baseline readings before and after each run.
Demo:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [21]: </span><span class="kn">from</span><span class="w"> </span><span class="nn">ophyd.sim</span><span class="w"> </span><span class="kn">import</span> <span class="n">det</span><span class="p">,</span> <span class="n">motor</span>

<span class="gp">In [22]: </span><span class="kn">from</span><span class="w"> </span><span class="nn">bluesky.plans</span><span class="w"> </span><span class="kn">import</span> <span class="n">scan</span>

<span class="gp">In [23]: </span><span class="n">RE</span><span class="p">(</span><span class="n">scan</span><span class="p">([</span><span class="n">det</span><span class="p">],</span> <span class="n">motor</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>


<span class="go">Transient Scan ID: 9     Time: 2025-06-14 23:17:42</span>
<span class="go">Persistent Unique Scan ID: &#39;5a82d3eb-08e2-4b5d-9266-57772a7470df&#39;</span>
<span class="go">New stream: &#39;baseline&#39;</span>
<span class="go">Start-of-run baseline readings:</span>
<span class="go">+--------------------------------+--------------------------------+</span>
<span class="go">|                           det1 | 9.643749239819588e-22          |</span>
<span class="go">|                           det2 | 0.0006709252558050237          |</span>
<span class="go">|                           det3 | 1.2130613194252668             |</span>
<span class="go">|                         motor1 | 5.0                            |</span>
<span class="go">|                         motor2 | 9.0                            |</span>
<span class="go">+--------------------------------+--------------------------------+</span>
<span class="go">New stream: &#39;primary&#39;</span>
<span class="go">+-----------+------------+------------+------------+</span>
<span class="go">|   seq_num |       time |      motor |        det |</span>
<span class="go">+-----------+------------+------------+------------+</span>
<span class="go">|         1 | 23:17:42.1 |     -1.000 |      0.607 |</span>
<span class="go">|         2 | 23:17:42.1 |     -0.500 |      0.882 |</span>
<span class="go">|         3 | 23:17:42.2 |      0.000 |      1.000 |</span>
<span class="go">|         4 | 23:17:42.2 |      0.500 |      0.882 |</span>
<span class="go">|         5 | 23:17:42.3 |      1.000 |      0.607 |</span>
<span class="go">+-----------+------------+------------+------------+</span>
<span class="go">generator scan [&#39;5a82d3eb&#39;] (scan num: 9)</span>
<span class="go">End-of-run baseline readings:</span>
<span class="go">+--------------------------------+--------------------------------+</span>
<span class="go">|                           det1 | 9.643749239819588e-22          |</span>
<span class="go">|                           det2 | 0.0006709252558050237          |</span>
<span class="go">|                           det3 | 1.2130613194252668             |</span>
<span class="go">|                         motor1 | 5.0                            |</span>
<span class="go">|                         motor2 | 9.0                            |</span>
<span class="go">+--------------------------------+--------------------------------+</span>



<span class="gh">Out[23]: </span><span class="go">(&#39;5a82d3eb-08e2-4b5d-9266-57772a7470df&#39;,)</span>
</pre></div>
</div>
<p>We can clear or update the list of baseline detectors at any time.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [24]: </span><span class="n">sd</span><span class="o">.</span><span class="n">baseline</span> <span class="o">=</span> <span class="p">[]</span>
</pre></div>
</div>
<p>As an aside, this is one place where the design of bluesky really pays off. By
separating the executor (the RunEngine) from the instruction sets (the plans)
it’s easy to apply global configuration without updating every plan
individually.</p>
</section>
<section id="access-baseline-data">
<h3>Access Baseline Data<a class="headerlink" href="#access-baseline-data" title="Link to this heading">#</a></h3>
<p>If you access the data from our baseline scan, you might think that the
baseline data is missing!</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [25]: </span><span class="n">header</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="gp">In [26]: </span><span class="n">header</span><span class="o">.</span><span class="n">table</span><span class="p">()</span>
<span class="gh">Out[26]: </span>
<span class="go">                                 time  motor  motor_setpoint       det</span>
<span class="go">seq_num                                                               </span>
<span class="go">1       2025-06-14 23:17:42.115942478   -1.0            -1.0  0.606531</span>
<span class="go">2       2025-06-14 23:17:42.178948879   -0.5            -0.5  0.882497</span>
<span class="go">3       2025-06-14 23:17:42.229329109    0.0             0.0  1.000000</span>
<span class="go">4       2025-06-14 23:17:42.275190830    0.5             0.5  0.882497</span>
<span class="go">5       2025-06-14 23:17:42.326644421    1.0             1.0  0.606531</span>
</pre></div>
</div>
<p>Looking again at the output when we executed this scan, notice these lines:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>New stream: &#39;baseline&#39;
...
New stream: &#39;primary&#39;
</pre></div>
</div>
<p>By default, <code class="docutils literal notranslate"><span class="pre">header.table()</span></code> gives us the “primary” data stream:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [27]: </span><span class="n">header</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;primary&#39;</span><span class="p">)</span>  <span class="c1"># same result as header.table()</span>
<span class="gh">Out[27]: </span>
<span class="go">                                 time  motor  motor_setpoint       det</span>
<span class="go">seq_num                                                               </span>
<span class="go">1       2025-06-14 23:17:42.115942478   -1.0            -1.0  0.606531</span>
<span class="go">2       2025-06-14 23:17:42.178948879   -0.5            -0.5  0.882497</span>
<span class="go">3       2025-06-14 23:17:42.229329109    0.0             0.0  1.000000</span>
<span class="go">4       2025-06-14 23:17:42.275190830    0.5             0.5  0.882497</span>
<span class="go">5       2025-06-14 23:17:42.326644421    1.0             1.0  0.606531</span>
</pre></div>
</div>
<p>We can access other streams by name.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [28]: </span><span class="n">header</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="s1">&#39;baseline&#39;</span><span class="p">)</span>
<span class="gh">Out[28]: </span>
<span class="go">                                 time  motor1  ...          det1      det3</span>
<span class="go">seq_num                                        ...                        </span>
<span class="go">1       2025-06-14 23:17:42.099893808     5.0  ...  9.643749e-22  1.213061</span>
<span class="go">2       2025-06-14 23:17:42.371434212     5.0  ...  9.643749e-22  1.213061</span>

<span class="go">[2 rows x 8 columns]</span>
</pre></div>
</div>
<p>A list of the stream names in a given run is available as
<code class="docutils literal notranslate"><span class="pre">header.stream_names</span></code>. From here we refer to the
<a class="reference external" href="https://nsls-ii.github.io/databroker/tutorial.html">databroker tutorial</a>.</p>
</section>
<section id="other-supplemental-data">
<h3>Other Supplemental Data<a class="headerlink" href="#other-supplemental-data" title="Link to this heading">#</a></h3>
<p>Above, we used <code class="docutils literal notranslate"><span class="pre">sd.baseline</span></code>. There is also <code class="docutils literal notranslate"><span class="pre">sd.monitors</span></code> for signals to
monitor asynchronously during a run and <code class="docutils literal notranslate"><span class="pre">sd.flyers</span></code> for devices to “fly-scan”
during a run. See <a class="reference internal" href="plans.html#supplemental-data"><span class="std std-ref">Supplemental Data</span></a> for details.</p>
</section>
</section>
<section id="pause-resume-suspend">
<span id="tutorial-pause-resume-suspend"></span><h2>Pause, Resume, Suspend<a class="headerlink" href="#pause-resume-suspend" title="Link to this heading">#</a></h2>
<section id="interactive-pause-resume">
<h3>Interactive Pause &amp; Resume<a class="headerlink" href="#interactive-pause-resume" title="Link to this heading">#</a></h3>
<p>Sometimes it is convenient to pause data collection, check on some things, and
then either resume from where you left off or quit. The RunEngine makes it
possible to do this cleanly and safely on <em>any</em> plan, including user-defined
plans, with minimal effort by the user. Of course, experiments on systems
that evolve with time can’t be arbitrarily paused and resumed. It’s up to the
user to know that and use this feature only when applicable.</p>
<p>Take this example, a step scan over ten points.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ophyd.sim</span><span class="w"> </span><span class="kn">import</span> <span class="n">det</span><span class="p">,</span> <span class="n">motor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">bluesky.plans</span><span class="w"> </span><span class="kn">import</span> <span class="n">scan</span>

<span class="n">motor</span><span class="o">.</span><span class="n">delay</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># simulate slow motor movement</span>
<span class="n">RE</span><span class="p">(</span><span class="n">scan</span><span class="p">([</span><span class="n">det</span><span class="p">],</span> <span class="n">motor</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
<p>Demo:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [29]: </span><span class="n">RE</span><span class="p">(</span><span class="n">scan</span><span class="p">([</span><span class="n">det</span><span class="p">],</span> <span class="n">motor</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="go">Transient Scan ID: 1     Time: 2018/02/12 12:40:36</span>
<span class="go">Persistent Unique Scan ID: &#39;c5db9bb4-fb7f-49f4-948b-72fb716d1f67&#39;</span>
<span class="go">New stream: &#39;primary&#39;</span>
<span class="go">+-----------+------------+------------+------------+</span>
<span class="go">|   seq_num |       time |      motor |        det |</span>
<span class="go">+-----------+------------+------------+------------+</span>
<span class="go">|         1 | 12:40:37.6 |      1.000 |      0.607 |</span>
<span class="go">|         2 | 12:40:38.7 |      2.000 |      0.135 |</span>
<span class="go">|         3 | 12:40:39.7 |      3.000 |      0.011 |</span>
</pre></div>
</div>
<p>At this point we decide to hit <strong>Ctrl+C</strong> (SIGINT). The RunEngine will catch
this signal and react like so. We will examine this output piece by piece.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>^C
A &#39;deferred pause&#39; has been requested.The RunEngine will pause at the next
checkpoint. To pause immediately, hit Ctrl+C again in the next 10 seconds.
Deferred pause acknowledged. Continuing to checkpoint.
&lt;...a few seconds later...&gt;
|         4 | 12:40:40.7 |      4.000 |      0.000 |
Pausing...

---------------------------------------------------------------------------
RunEngineInterrupted                      Traceback (most recent call last)
&lt;ipython-input-14-826ee9dfb918&gt; in &lt;module&gt;()
----&gt; 1 RE(scan([det], motor, 1, 10, 10))
&lt;...snipped details...&gt;

RunEngineInterrupted:
Your RunEngine is entering a paused state. These are your options for changing
the state of the RunEngine:
RE.resume()    Resume the plan.
RE.abort()     Perform cleanup, then kill plan. Mark exit_status=&#39;abort&#39;.
RE.stop()      Perform cleanup, then kill plan. Mark exit_status=&#39;success&#39;.
RE.halt()      Emergency Stop: Do not perform cleanup --- just stop.
</pre></div>
</div>
<p>When it pauses, the RunEngine immediately tells all Devices that it has touched
so far to “stop”. (Devices define what that means to them in their <code class="docutils literal notranslate"><span class="pre">stop()</span></code>
method.) This is not a replacement for proper equipment protection; it is just
a convenience.</p>
<p>Now, at our leisure, we may:</p>
<ul class="simple">
<li><p>pause to think</p></li>
<li><p>investigate the state of our hardware, such as the detector’s exposure time</p></li>
<li><p>turn on more verbose logging  (see <a class="reference internal" href="debugging.html"><span class="doc">Debugging and Logging</span></a>)</p></li>
<li><p>decide whether to stop here or resume</p></li>
</ul>
<p>Suppose we decide to resume. The RunEngine will pick up from the last
“checkpoint”. Typically, this means beginning of each step in a scan, but
plans may specify checkpoints anywhere they like.</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [30]: </span><span class="n">RE</span><span class="o">.</span><span class="n">resume</span><span class="p">()</span>
<span class="go">|         5 | 12:40:50.1 |      5.000 |      0.000 |</span>
<span class="go">|         6 | 12:40:51.1 |      6.000 |      0.000 |</span>
<span class="go">|         7 | 12:40:52.1 |      7.000 |      0.000 |</span>
<span class="go">|         8 | 12:40:53.1 |      8.000 |      0.000 |</span>
<span class="go">|         9 | 12:40:54.1 |      9.000 |      0.000 |</span>
<span class="go">|        10 | 12:40:55.1 |     10.000 |      0.000 |</span>
<span class="go">+-----------+------------+------------+------------+</span>
<span class="go">generator scan [&#39;c5db9bb4&#39;] (scan num: 1)</span>
</pre></div>
</div>
<p>The scan has completed successfully.</p>
<p>If you go back and read the output from when we hit Ctrl+C, you will notice
that the RunEngine didn’t pause immediately: it finished the current step of
the scan first. Quoting an excerpt from the demo above:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>^C
A &#39;deferred pause&#39; has been requested.The RunEngine will pause at the next
checkpoint. To pause immediately, hit Ctrl+C again in the next 10 seconds.
Deferred pause acknowledged. Continuing to checkpoint.
&lt;...a few seconds later...&gt;
|         4 | 12:40:40.7 |      4.000 |      0.000 |
Pausing...
</pre></div>
</div>
<p>Observe that hitting Ctrl+C <em>twice</em> pauses immediately, without waiting to
finish the current step.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>In [2]: RE(scan([det], motor, 1, 10, 10))
Transient Scan ID: 2     Time: 2018/02/15 12:31:14
Persistent Unique Scan ID: &#39;b342448f-6a64-4f26-91a6-37f559cb5537&#39;
New stream: &#39;primary&#39;
+-----------+------------+------------+------------+
|   seq_num |       time |      motor |        det |
+-----------+------------+------------+------------+
|         1 | 12:31:15.8 |      1.000 |      0.607 |
|         2 | 12:31:16.8 |      2.000 |      0.135 |
|         3 | 12:31:17.8 |      3.000 |      0.011 |
^C^C
Pausing...
</pre></div>
</div>
<p>When resumed, the RunEngine will <em>rewind</em> to the last checkpoint (the beginning
of the fourth step in the scan) and repeat instructions as needed.</p>
<p>Quoting again from the demo, notice that <code class="docutils literal notranslate"><span class="pre">RE.resume()</span></code> was only one of our
options. If we decide not to continue we can quit in three different ways:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Your RunEngine is entering a paused state. These are your options for changing
the state of the RunEngine:
RE.resume()    Resume the plan.
RE.abort()     Perform cleanup, then kill plan. Mark exit_status=&#39;abort&#39;.
RE.stop()      Perform cleanup, then kill plan. Mark exit_status=&#39;success&#39;.
RE.halt()      Emergency Stop: Do not perform cleanup --- just stop.
</pre></div>
</div>
<p>“Aborting” and “stopping” are almost the same thing: they just record different
metadata about why the experiment was ended. Both signal to the plan that it
should end early, but they still let it specify more instructions so that it
can “clean up.” For example, a <a class="reference internal" href="generated/bluesky.plans.rel_scan.html#bluesky.plans.rel_scan" title="bluesky.plans.rel_scan"><code class="xref py py-func docutils literal notranslate"><span class="pre">rel_scan()</span></code></a> moves the motor
back to its starting position before quitting.</p>
<p>In rare cases, if we are worried that the plan’s cleanup procedure might be
dangerous, we can “halt”. Halting circumvents the cleanup instructions.</p>
<p>Try executing <code class="docutils literal notranslate"><span class="pre">RE(scan([det],</span> <span class="pre">motor,</span> <span class="pre">1,</span> <span class="pre">10,</span> <span class="pre">10))</span></code>, pausing, and exiting in
these various ways. Observe that the RunEngine won’t let you run a new plan
until you have resolved the paused plan using one of these methods.</p>
</section>
<section id="automated-suspend-resume">
<h3>Automated Suspend &amp; Resume<a class="headerlink" href="#automated-suspend-resume" title="Link to this heading">#</a></h3>
<p>The RunEngine can be configured in advance to <em>automatically</em> pause and resume
in response to external signals. To distinguish automatic pause/resume from
interactive, user-initiated pause and resume, we call this behavior
“suspending.”</p>
<p>For details, see <a class="reference internal" href="state-machine.html#suspenders"><span class="std std-ref">Automated Suspension</span></a>.</p>
</section>
</section>
<section id="metadata">
<span id="tutorial-metadata"></span><h2>Metadata<a class="headerlink" href="#metadata" title="Link to this heading">#</a></h2>
<p>If users pass extra keyword arguments to <code class="docutils literal notranslate"><span class="pre">RE</span></code>, they are interpreted as
metadata</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">count</span><span class="p">([</span><span class="n">det</span><span class="p">]),</span> <span class="n">user</span><span class="o">=</span><span class="s1">&#39;Dan&#39;</span><span class="p">,</span> <span class="n">mood</span><span class="o">=</span><span class="s1">&#39;skeptical&#39;</span><span class="p">)</span>
<span class="n">RE</span><span class="p">(</span><span class="n">count</span><span class="p">([</span><span class="n">det</span><span class="p">]),</span> <span class="n">user</span><span class="o">=</span><span class="s1">&#39;Dan&#39;</span><span class="p">,</span> <span class="n">mood</span><span class="o">=</span><span class="s1">&#39;optimistic&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>and they can be used for searching later:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">headers</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">user</span><span class="o">=</span><span class="s1">&#39;Dan&#39;</span><span class="p">)</span>
<span class="n">headers</span> <span class="o">=</span> <span class="n">db</span><span class="p">(</span><span class="n">mood</span><span class="o">=</span><span class="s1">&#39;skeptical&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Metadata can also be added <em>persistently</em> (i.e. applied to all future runs
until removed) by editing the dictionary <code class="docutils literal notranslate"><span class="pre">RE.md</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="o">.</span><span class="n">md</span>
<span class="n">RE</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Dan&#39;</span>
</pre></div>
</div>
<p>No need to specify <code class="docutils literal notranslate"><span class="pre">user</span></code> every time now….</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">count</span><span class="p">([</span><span class="n">det</span><span class="p">]))</span>  <span class="c1"># automatically includes user=&#39;Dan&#39;</span>
</pre></div>
</div>
<p>The key can be temporarily overridden:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">count</span><span class="p">([</span><span class="n">det</span><span class="p">]),</span> <span class="n">user</span><span class="o">=</span><span class="s1">&#39;Tom&#39;</span><span class="p">)</span>  <span class="c1"># overrides the setting in RE.md, just once</span>
</pre></div>
</div>
<p>or deleted:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">del</span> <span class="n">RE</span><span class="o">.</span><span class="n">md</span><span class="p">[</span><span class="s1">&#39;user&#39;</span><span class="p">]</span>
</pre></div>
</div>
<p>In addition to any user-provided metadata, the RunEngine, the devices, and the
plan capture some metadata automatically. For more see, <a class="reference internal" href="metadata.html"><span class="doc">Recording Metadata</span></a>.</p>
</section>
<section id="simulate-and-introspect-plans">
<h2>Simulate and Introspect Plans<a class="headerlink" href="#simulate-and-introspect-plans" title="Link to this heading">#</a></h2>
<p>We have referred to a <em>plan</em> as a “sequence of instructions encoding an
experimental procedure.” But what’s inside a plan really? Bluesky calls each
atomic instruction inside a plan a <em>message</em>.  Handling the messages directly
is only necessary when debugging or doing unusually deep customization, but
it’s helpful to see them at least once before moving on to more practical
tools.</p>
<p>Try printing out every message in a couple simple plans:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">bluesky.plans</span><span class="w"> </span><span class="kn">import</span> <span class="n">count</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ophyd.sim</span><span class="w"> </span><span class="kn">import</span> <span class="n">det</span>

<span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">count</span><span class="p">([]):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

<span class="k">for</span> <span class="n">msg</span> <span class="ow">in</span> <span class="n">count</span><span class="p">([</span><span class="n">det</span><span class="p">]):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
</pre></div>
</div>
<p>See the <a class="reference internal" href="msg.html"><span class="doc">Message Protocol</span></a> section for more.</p>
<p>Bluesky includes some tools for producing more useful, human-readable summaries
to answer the question, “What will this plan do?”</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [31]: </span><span class="kn">from</span><span class="w"> </span><span class="nn">bluesky.simulators</span><span class="w"> </span><span class="kn">import</span> <span class="n">summarize_plan</span>

<span class="gp">In [32]: </span><span class="kn">from</span><span class="w"> </span><span class="nn">bluesky.plans</span><span class="w"> </span><span class="kn">import</span> <span class="n">count</span><span class="p">,</span> <span class="n">rel_scan</span>

<span class="gp">In [33]: </span><span class="kn">from</span><span class="w"> </span><span class="nn">ophyd.sim</span><span class="w"> </span><span class="kn">import</span> <span class="n">det</span><span class="p">,</span> <span class="n">motor</span>

<span class="go"># Count a detector 3 times.</span>
<span class="gp">In [34]: </span><span class="n">summarize_plan</span><span class="p">(</span><span class="n">count</span><span class="p">([</span><span class="n">det</span><span class="p">],</span> <span class="mi">3</span><span class="p">))</span>
<span class="go">=================================== Open Run ===================================</span>
<span class="go">  Read [&#39;det&#39;]</span>
<span class="go">  Read [&#39;det&#39;]</span>
<span class="go">  Read [&#39;det&#39;]</span>
<span class="go">================================== Close Run ===================================</span>

<span class="go"># A 3-step scan.</span>
<span class="gp">In [35]: </span><span class="n">summarize_plan</span><span class="p">(</span><span class="n">rel_scan</span><span class="p">([</span><span class="n">det</span><span class="p">],</span> <span class="n">motor</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="go">=================================== Open Run ===================================</span>
<span class="go">motor -&gt; 0.0</span>
<span class="go">  Read [&#39;det&#39;, &#39;motor&#39;]</span>
<span class="go">motor -&gt; 1.0</span>
<span class="go">  Read [&#39;det&#39;, &#39;motor&#39;]</span>
<span class="go">motor -&gt; 2.0</span>
<span class="go">  Read [&#39;det&#39;, &#39;motor&#39;]</span>
<span class="go">================================== Close Run ===================================</span>
<span class="go">motor -&gt; 1.0</span>
</pre></div>
</div>
<p>For more possibilities, see <a class="reference internal" href="simulation.html"><span class="doc">Simulation and Error Checking</span></a>.</p>
</section>
<section id="devices">
<span id="tutorial-device"></span><h2>Devices<a class="headerlink" href="#devices" title="Link to this heading">#</a></h2>
<section id="theory">
<h3>Theory<a class="headerlink" href="#theory" title="Link to this heading">#</a></h3>
<p>The notion of a “Device” serves two goals:</p>
<ul class="simple">
<li><p>Provide a <strong>standard interface</strong> to all hardware for the sake of generality
and code reuse.</p></li>
<li><p><strong>Logically group</strong> individual signals into composite “Devices” that can be
read together, as a unit, and configured in a coordinated way. Provide a
human-readable name to this group, with an eye toward later data analysis.</p></li>
</ul>
<p>In bluesky’s view of the world, there are only three different kinds of devices
used in data acquisition.</p>
<ul class="simple">
<li><p>Some devices can be <strong>read</strong>. This includes simple points detectors that
produce a single number and large CCD detectors that produce big arrays.</p></li>
<li><p>Some devices can be both <strong>read and set</strong>. Setting a motor physically moves
it to a new position. Setting a temperature controller impels it to gradually
change its temperature. Setting the exposure time on some detector promptly
updates its configuration.</p></li>
<li><p>Some devices produce data at a rate too high to be read out in real time, and
instead <strong>buffer their data externally</strong> in separate hardware or software
until it can be read out.</p></li>
</ul>
<p>Bluesky interacts with all devices via a <a class="reference internal" href="hardware.html"><span class="doc">specified interface</span></a>.
Each device is represented by a Python object with certain methods and
attributes (with names like <code class="docutils literal notranslate"><span class="pre">read</span></code> and <code class="docutils literal notranslate"><span class="pre">set</span></code>). Some of these methods are
asynchronous, such as <code class="docutils literal notranslate"><span class="pre">set</span></code>, which allows for the concurrent movement of
multiple devices.</p>
</section>
<section id="implementation">
<h3>Implementation<a class="headerlink" href="#implementation" title="Link to this heading">#</a></h3>
<p><a class="reference external" href="https://nsls-ii.github.io/ophyd">Ophyd</a>, a Python library that was
developed in tandem with bluesky, implements this interface for devices that
speak <a class="reference external" href="http://www.aps.anl.gov/epics/">EPICS</a>. But bluesky is not tied to
ophyd or EPICS specifically: any Python object may be used, so long as it
provides the specified methods and attributes that bluesky expects.
For example, an experimental implementation of the bluesky interface for LabView has been written.
See <a class="reference internal" href="hardware-interfaces.html#hardware-interface-packages"><span class="std std-ref">Hardware Interface Packages</span></a> for more examples.
And the simulated hardware that we have been using in this
tutorial is all based on pure-Python constructs unconnected from hardware or
any specific hardware control protocol.</p>
<p>To get a flavor for what it looks like to configure hardware in ophyd,
connecting to an EPICS motor looks like this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ophyd</span><span class="w"> </span><span class="kn">import</span> <span class="n">EpicsMotor</span>

<span class="n">nano_top_x</span> <span class="o">=</span> <span class="n">EpicsMotor</span><span class="p">(</span><span class="s1">&#39;XF:31ID-ES{Dif:Nano-Ax:TopX}Mtr&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;nano_top_x&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>We have provided both the machine-readable address of the motor on the network,
<code class="docutils literal notranslate"><span class="pre">'XF:31ID-ES{Dif:Nano-Ax:TopX}Mtr'</span></code> (in EPICS jargon, the “PV” for
“Process Variable”), and a human-readable name, <code class="docutils literal notranslate"><span class="pre">'nano_top_x'</span></code>, which will be
used to label the data generated by this motor. When it comes time to analyze
the data, we will be grateful to be dealing with the human-readable label.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">EpicsMotor</span></code> device is a logical grouping of many signals. The most
important are the readback (actual position) and setpoint (target position).
All of the signals are summarized thus. The details here aren’t important at
this stage: the take-away message is, “There is a lot of stuff to keep track of
about a motor, and a Device helpfully groups that stuff for us.”</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>In [3]: nano_top_x.summary()
data keys (* hints)
-------------------
*nano_top_x
nano_top_x_user_setpoint

read attrs
----------
user_readback        EpicsSignalRO       (&#39;nano_top_x&#39;)
user_setpoint        EpicsSignal         (&#39;nano_top_x_user_setpoint&#39;)

config keys
-----------
nano_top_x_acceleration
nano_top_x_motor_egu
nano_top_x_user_offset
nano_top_x_user_offset_dir
nano_top_x_velocity

configuration attrs
----------
motor_egu            EpicsSignal         (&#39;nano_top_x_motor_egu&#39;)
velocity             EpicsSignal         (&#39;nano_top_x_velocity&#39;)
acceleration         EpicsSignal         (&#39;nano_top_x_acceleration&#39;)
user_offset          EpicsSignal         (&#39;nano_top_x_user_offset&#39;)
user_offset_dir      EpicsSignal         (&#39;nano_top_x_user_offset_dir&#39;)

Unused attrs
------------
offset_freeze_switch EpicsSignal         (&#39;nano_top_x_offset_freeze_switch&#39;)
set_use_switch       EpicsSignal         (&#39;nano_top_x_set_use_switch&#39;)
motor_is_moving      EpicsSignalRO       (&#39;nano_top_x_motor_is_moving&#39;)
motor_done_move      EpicsSignalRO       (&#39;nano_top_x_motor_done_move&#39;)
high_limit_switch    EpicsSignal         (&#39;nano_top_x_high_limit_switch&#39;)
low_limit_switch     EpicsSignal         (&#39;nano_top_x_low_limit_switch&#39;)
direction_of_travel  EpicsSignal         (&#39;nano_top_x_direction_of_travel&#39;)
motor_stop           EpicsSignal         (&#39;nano_top_x_motor_stop&#39;)
home_forward         EpicsSignal         (&#39;nano_top_x_home_forward&#39;)
home_reverse         EpicsSignal         (&#39;nano_top_x_home_reverse&#39;)
</pre></div>
</div>
</section>
</section>
<section id="write-custom-plans">
<span id="tutorial-custom-plans"></span><h2>Write Custom Plans<a class="headerlink" href="#write-custom-plans" title="Link to this heading">#</a></h2>
<p>As mentioned in the <a class="reference internal" href="#tutorial-simple-customization"><span class="std std-ref">Simple Customization</span></a> section above, the
“pre-assembled” plans with <a class="reference internal" href="generated/bluesky.plans.count.html#bluesky.plans.count" title="bluesky.plans.count"><code class="xref py py-func docutils literal notranslate"><span class="pre">count()</span></code></a> and
<a class="reference internal" href="generated/bluesky.plans.scan.html#bluesky.plans.scan" title="bluesky.plans.scan"><code class="xref py py-func docutils literal notranslate"><span class="pre">scan()</span></code></a> are built from smaller “plan stubs”. We can
mix and match the “stubs” and/or “pre-assembled” plans to build custom plans.</p>
<p>There are many of plan stubs, so it’s convenient to import the whole module and
work with that.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">bluesky.plan_stubs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">bps</span>
</pre></div>
</div>
<section id="move-in-parallel">
<h3>Move in Parallel<a class="headerlink" href="#move-in-parallel" title="Link to this heading">#</a></h3>
<p>Before writing a custom plan to coordinate the motion of multiple devices,
consider whether your use case could be addressed with one of the built-in
<a class="reference internal" href="plans.html#multi-dimensional-scans"><span class="std std-ref">Multi-dimensional scans</span></a>.</p>
<p>We previously introduced the <a class="reference internal" href="generated/bluesky.plan_stubs.mv.html#bluesky.plan_stubs.mv" title="bluesky.plan_stubs.mv"><code class="xref py py-func docutils literal notranslate"><span class="pre">mv()</span></code></a> plan that moves one
or more devices and waits for them all to arrive. There is also
<code class="xref py py-func docutils literal notranslate"><span class="pre">mvr()</span></code> for moving <em>relative</em> to the current position.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">ophyd.sim</span><span class="w"> </span><span class="kn">import</span> <span class="n">motor1</span><span class="p">,</span> <span class="n">motor2</span>

<span class="c1"># Move motor1 to 1 and motor2 10 units in the positive direction relative</span>
<span class="c1"># to their current positions. Wait for both to arrive.</span>
<span class="n">RE</span><span class="p">(</span><span class="n">bps</span><span class="o">.</span><span class="n">mvr</span><span class="p">(</span><span class="n">motor1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">motor2</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
<p>Some scenarios require more low-level control over when the waiting occurs.
For these, we employ <a class="reference internal" href="generated/bluesky.plan_stubs.wait.html#bluesky.plan_stubs.wait" title="bluesky.plan_stubs.wait"><code class="xref py py-func docutils literal notranslate"><span class="pre">wait()</span></code></a> and
<a class="reference internal" href="generated/bluesky.plan_stubs.abs_set.html#bluesky.plan_stubs.abs_set" title="bluesky.plan_stubs.abs_set"><code class="xref py py-func docutils literal notranslate"><span class="pre">abs_set()</span></code></a> (“absolute set”) or
<a class="reference internal" href="generated/bluesky.plan_stubs.rel_set.html#bluesky.plan_stubs.rel_set" title="bluesky.plan_stubs.rel_set"><code class="xref py py-func docutils literal notranslate"><span class="pre">rel_set()</span></code></a> (“relative set”).</p>
<p>Here is a scenario that does require a custom solution: we want to set several
motors in motion at once, including multiple fast motors and one slow motor. We
want to wait for the fast motors to arrive, print a message, then wait for the
slow motor to arrive, and print a second message.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">staggered_wait</span><span class="p">(</span><span class="n">fast_motors</span><span class="p">,</span> <span class="n">slow_motor</span><span class="p">):</span>
    <span class="c1"># Start all the motors, fast and slow, moving at once.</span>
    <span class="c1"># Put all the fast_motors in one group...</span>
    <span class="k">for</span> <span class="n">motor</span> <span class="ow">in</span> <span class="n">fast_motors</span><span class="p">:</span>
        <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">abs_set</span><span class="p">(</span><span class="n">motor</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>
    <span class="c1"># ...but put the slow motor is separate group.</span>
    <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">abs_set</span><span class="p">(</span><span class="n">slow_motor</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">group</span><span class="o">=</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>

    <span class="c1"># Wait for all the fast motors.</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Waiting on the fast motors.&#39;</span><span class="p">)</span>
    <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Fast motors are in place. Just waiting on the slow one now.&#39;</span><span class="p">)</span>

    <span class="c1"># Then wait for the slow motor.</span>
    <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="s1">&#39;B&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Slow motor is in place.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="sleeping-timed-delays">
<h3>Sleeping (Timed Delays)<a class="headerlink" href="#sleeping-timed-delays" title="Link to this heading">#</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you need to wait for your motor to finish moving, temperature to finish
equilibrating, or shutter to finish opening, inserting delays into plans
isn’t the best way to do that. It should be the <em>Device’s</em> business to
report accurately when it is done, including any extra padding for settling
or equilibration. On some devices, such as <code class="docutils literal notranslate"><span class="pre">EpicsMotor</span></code>, this can be
configured like <code class="docutils literal notranslate"><span class="pre">motor.settle_time</span> <span class="pre">=</span> <span class="pre">3</span></code>.</p>
</div>
<p>For timed delays, bluesky has a special plan, which allows the RunEngine to
continue its business during the sleep.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">sleepy_plan</span><span class="p">(</span><span class="n">motor</span><span class="p">,</span> <span class="n">positions</span><span class="p">):</span>
    <span class="s2">&quot;Step a motor through a list of positions with 1-second delays between steps.&quot;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">position</span> <span class="ow">in</span> <span class="n">positions</span><span class="p">:</span>
        <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">mv</span><span class="p">(</span><span class="n">motor</span><span class="p">,</span> <span class="n">position</span><span class="p">)</span>
        <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>You should always use this plan, *never* Python’s built-in function
:func:`time.sleep`.</strong> Why?
The RunEngine uses an event loop to concurrently manage many tasks. It assumes
that none of those tasks blocks for very long. (A good figure for “very long”
is 0.2 seconds.) Therefore, you should never incorporate long blocking function
calls in your plan, such as <code class="docutils literal notranslate"><span class="pre">time.sleep(1)</span></code>.</p>
</section>
<section id="capture-data">
<span id="tutorial-capture-data"></span><h3>Capture Data<a class="headerlink" href="#capture-data" title="Link to this heading">#</a></h3>
<p>Any plan that generates data must include instructions for grouping readings
into <em>Events</em> (i.e. rows in a table) and grouping those Events into <em>Runs</em>
(datasets that are given a “scan ID”). This is best explained by example.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">bluesky.plan_stubs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">bps</span>

<span class="k">def</span><span class="w"> </span><span class="nf">one_run_one_event</span><span class="p">(</span><span class="n">detectors</span><span class="p">):</span>
    <span class="c1"># Declare the beginning of a new run.</span>
    <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">open_run</span><span class="p">()</span>
    <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">declare_stream</span><span class="p">(</span><span class="o">*</span><span class="n">detectors</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;primary&#39;</span><span class="p">)</span>

    <span class="c1"># Trigger each detector and wait for triggering to complete.</span>
    <span class="c1"># Then read the detectors and bundle these readings into an Event</span>
    <span class="c1"># (i.e. one row in a table.)</span>
    <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">trigger_and_read</span><span class="p">(</span><span class="n">detectors</span><span class="p">)</span>

    <span class="c1"># Declare the end of the run.</span>
    <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">close_run</span><span class="p">()</span>
</pre></div>
</div>
<p>Execute the plan like so:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [36]: </span><span class="n">RE</span><span class="p">(</span><span class="n">one_run_one_event</span><span class="p">([</span><span class="n">det1</span><span class="p">,</span> <span class="n">det2</span><span class="p">]))</span>


<span class="go">Transient Scan ID: 10     Time: 2025-06-14 23:17:42</span>
<span class="go">Persistent Unique Scan ID: &#39;1f465296-4a84-4cae-8b1c-64d0886e2db7&#39;</span>
<span class="go">New stream: &#39;primary&#39;</span>
<span class="go">+-----------+------------+------------+------------+</span>
<span class="go">|   seq_num |       time |       det2 |       det1 |</span>
<span class="go">+-----------+------------+------------+------------+</span>
<span class="go">|         1 | 23:17:42.6 |      0.001 |      0.000 |</span>
<span class="go">+-----------+------------+------------+------------+</span>
<span class="go">generator one_run_one_event [&#39;1f465296&#39;] (scan num: 10)</span>



<span class="gh">Out[36]: </span><span class="go">(&#39;1f465296-4a84-4cae-8b1c-64d0886e2db7&#39;,)</span>
</pre></div>
</div>
<p>We observe:</p>
<ul class="simple">
<li><p>one table (one Run)</p></li>
<li><p>one row (one Event)</p></li>
<li><p>two columns (a column for each detector)</p></li>
</ul>
<p>Here’s the same plan again, with <a class="reference internal" href="generated/bluesky.plan_stubs.trigger_and_read.html#bluesky.plan_stubs.trigger_and_read" title="bluesky.plan_stubs.trigger_and_read"><code class="xref py py-func docutils literal notranslate"><span class="pre">trigger_and_read()</span></code></a>
moved inside a for loop.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">one_run_multi_events</span><span class="p">(</span><span class="n">detectors</span><span class="p">,</span> <span class="n">num</span><span class="p">):</span>
    <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">open_run</span><span class="p">()</span>
    <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">declare_stream</span><span class="p">(</span><span class="o">*</span><span class="n">detectors</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;primary&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num</span><span class="p">):</span>
        <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">trigger_and_read</span><span class="p">(</span><span class="n">detectors</span><span class="p">)</span>

    <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">close_run</span><span class="p">()</span>
</pre></div>
</div>
<p>Execute the plan like so:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [37]: </span><span class="n">RE</span><span class="p">(</span><span class="n">one_run_multi_events</span><span class="p">([</span><span class="n">det1</span><span class="p">,</span> <span class="n">det2</span><span class="p">],</span> <span class="mi">3</span><span class="p">))</span>


<span class="go">Transient Scan ID: 11     Time: 2025-06-14 23:17:43</span>
<span class="go">Persistent Unique Scan ID: &#39;10f9d3e2-d6ff-4b88-93e6-e6f587f7395d&#39;</span>
<span class="go">New stream: &#39;primary&#39;</span>
<span class="go">+-----------+------------+------------+------------+</span>
<span class="go">|   seq_num |       time |       det2 |       det1 |</span>
<span class="go">+-----------+------------+------------+------------+</span>
<span class="go">|         1 | 23:17:43.1 |      0.001 |      0.000 |</span>
<span class="go">|         2 | 23:17:43.3 |      0.001 |      0.000 |</span>
<span class="go">|         3 | 23:17:43.5 |      0.001 |      0.000 |</span>
<span class="go">+-----------+------------+------------+------------+</span>
<span class="go">generator one_run_multi_events [&#39;10f9d3e2&#39;] (scan num: 11)</span>



<span class="gh">Out[37]: </span><span class="go">(&#39;10f9d3e2-d6ff-4b88-93e6-e6f587f7395d&#39;,)</span>
</pre></div>
</div>
<p>We observe:</p>
<ul class="simple">
<li><p>one table (one Run)</p></li>
<li><p>three rows (three Events)</p></li>
<li><p>two columns (a column for each detector)</p></li>
</ul>
<p>Finally, add another loop re-using <code class="docutils literal notranslate"><span class="pre">one_run_multi_events</span></code> inside that loop.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">multi_runs_multi_events</span><span class="p">(</span><span class="n">detectors</span><span class="p">,</span> <span class="n">num</span><span class="p">,</span> <span class="n">num_runs</span><span class="p">):</span>
    <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">declare_stream</span><span class="p">(</span><span class="o">*</span><span class="n">detectors</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;primary&#39;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_runs</span><span class="p">):</span>
        <span class="k">yield from</span> <span class="n">one_run_multi_events</span><span class="p">(</span><span class="n">detectors</span><span class="p">,</span> <span class="n">num</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [38]: </span><span class="n">RE</span><span class="p">(</span><span class="n">multi_runs_multi_events</span><span class="p">([</span><span class="n">det1</span><span class="p">,</span> <span class="n">det2</span><span class="p">],</span> <span class="n">num</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">num_runs</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>


<span class="go">Transient Scan ID: 12     Time: 2025-06-14 23:17:43</span>
<span class="go">Persistent Unique Scan ID: &#39;f717bf7e-f56d-4f0a-bfb2-c1c7cc9e04d3&#39;</span>
<span class="go">New stream: &#39;primary&#39;</span>
<span class="go">+-----------+------------+------------+------------+</span>
<span class="go">|   seq_num |       time |       det2 |       det1 |</span>
<span class="go">+-----------+------------+------------+------------+</span>
<span class="go">|         1 | 23:17:43.9 |      0.001 |      0.000 |</span>
<span class="go">|         2 | 23:17:44.1 |      0.001 |      0.000 |</span>
<span class="go">|         3 | 23:17:44.3 |      0.001 |      0.000 |</span>
<span class="go">+-----------+------------+------------+------------+</span>
<span class="go">generator multi_runs_multi_events [&#39;f717bf7e&#39;] (scan num: 12)</span>





<span class="go">Transient Scan ID: 13     Time: 2025-06-14 23:17:44</span>
<span class="go">Persistent Unique Scan ID: &#39;53fbd7cc-162f-41b6-a2a2-3865174fff8d&#39;</span>
<span class="go">New stream: &#39;primary&#39;</span>
<span class="go">+-----------+------------+------------+------------+</span>
<span class="go">|   seq_num |       time |       det2 |       det1 |</span>
<span class="go">+-----------+------------+------------+------------+</span>
<span class="go">|         1 | 23:17:44.8 |      0.001 |      0.000 |</span>
<span class="go">|         2 | 23:17:45.0 |      0.001 |      0.000 |</span>
<span class="go">|         3 | 23:17:45.1 |      0.001 |      0.000 |</span>
<span class="go">+-----------+------------+------------+------------+</span>
<span class="go">generator multi_runs_multi_events [&#39;53fbd7cc&#39;] (scan num: 13)</span>



<span class="gh">Out[38]: </span>
<span class="go">(&#39;f717bf7e-f56d-4f0a-bfb2-c1c7cc9e04d3&#39;,</span>
<span class="go"> &#39;53fbd7cc-162f-41b6-a2a2-3865174fff8d&#39;)</span>
</pre></div>
</div>
<p>We observe:</p>
<ul class="simple">
<li><p>two tables (two Runs)</p></li>
<li><p>three rows (three Events)</p></li>
<li><p>two columns (a column for each detector)</p></li>
</ul>
<p>We also notice that the return value output from the RunEngine is a tuple with
two unique IDs, one per Run generated by this plan.</p>
<p>In order to focus on the scope of an Event and a Run, we have left out an
important detail, addressed in the next section, which may be necessary to
incorporate before trying these plans on real devices.</p>
</section>
<section id="stage-and-unstage">
<h3>Stage and Unstage<a class="headerlink" href="#stage-and-unstage" title="Link to this heading">#</a></h3>
<p>Complex devices often require some preliminary setup before they can be used
for data collection, moving them from a resting state into a state where they
are ready to acquire data. Bluesky accommodates this in a general way by
allowing every Device to implement an optional <code class="docutils literal notranslate"><span class="pre">stage()</span></code> method, with a
corresponding <code class="docutils literal notranslate"><span class="pre">unstage()</span></code> method. Plans should stage every device that they
touch exactly once and unstage every device at the end. If a Device does not
have a <code class="docutils literal notranslate"><span class="pre">stage()</span></code> method the RunEngine will just skip over it.</p>
<p>Revising our simplest example above, <code class="docutils literal notranslate"><span class="pre">one_run_one_event</span></code>,</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">bluesky.plan_stubs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">bps</span>

<span class="k">def</span><span class="w"> </span><span class="nf">one_run_one_event</span><span class="p">(</span><span class="n">detectors</span><span class="p">):</span>
    <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">open_run</span><span class="p">()</span>
    <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">declare_stream</span><span class="p">(</span><span class="o">*</span><span class="n">detectors</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;primary&#39;</span><span class="p">)</span>
    <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">trigger_and_read</span><span class="p">(</span><span class="n">detectors</span><span class="p">)</span>
    <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">close_run</span><span class="p">()</span>
</pre></div>
</div>
<p>we incorporate staging like so:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">one_run_one_event</span><span class="p">(</span><span class="n">detectors</span><span class="p">):</span>

    <span class="c1"># &#39;Stage&#39; every device.</span>
    <span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">detectors</span><span class="p">:</span>
        <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">stage</span><span class="p">(</span><span class="n">det</span><span class="p">)</span>

    <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">open_run</span><span class="p">()</span>
    <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">declare_stream</span><span class="p">(</span><span class="o">*</span><span class="n">detectors</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;primary&#39;</span><span class="p">)</span>
    <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">trigger_and_read</span><span class="p">(</span><span class="n">detectors</span><span class="p">)</span>
    <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">close_run</span><span class="p">()</span>

    <span class="c1"># &#39;Unstage&#39; every device.</span>
    <span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">detectors</span><span class="p">:</span>
        <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">unstage</span><span class="p">(</span><span class="n">det</span><span class="p">)</span>
</pre></div>
</div>
<p>This is starting to get verbose. At this point, we might want to accept some
additional complexity in exchange for brevity — and some assurance that we
don’t forget to use these plans in matching pairs. To that end, this plan is
equivalent:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">bluesky.preprocessors</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">bpp</span>

<span class="k">def</span><span class="w"> </span><span class="nf">one_run_one_event</span><span class="p">(</span><span class="n">detectors</span><span class="p">):</span>

    <span class="nd">@bpp</span><span class="o">.</span><span class="n">stage_decorator</span><span class="p">(</span><span class="n">detectors</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">inner</span><span class="p">():</span>
        <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">open_run</span><span class="p">()</span>
        <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">declare_stream</span><span class="p">(</span><span class="o">*</span><span class="n">detectors</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;primary&#39;</span><span class="p">)</span>
        <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">trigger_and_read</span><span class="p">(</span><span class="n">detectors</span><span class="p">)</span>
        <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">close_run</span><span class="p">()</span>

    <span class="k">return</span> <span class="p">(</span><span class="k">yield from</span> <span class="n">inner</span><span class="p">())</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="generated/bluesky.preprocessors.stage_decorator.html#bluesky.preprocessors.stage_decorator" title="bluesky.preprocessors.stage_decorator"><code class="xref py py-func docutils literal notranslate"><span class="pre">stage_decorator()</span></code></a> is a <em>plan preprocessor</em>, a
plan which consumes another plan and modifies its instructions. In this case,
it adds inserts ‘stage’ and ‘unstage’ messages, supplanting
<a class="reference internal" href="generated/bluesky.plan_stubs.stage.html#bluesky.plan_stubs.stage" title="bluesky.plan_stubs.stage"><code class="xref py py-func docutils literal notranslate"><span class="pre">stage()</span></code></a> and <a class="reference internal" href="generated/bluesky.plan_stubs.unstage.html#bluesky.plan_stubs.unstage" title="bluesky.plan_stubs.unstage"><code class="xref py py-func docutils literal notranslate"><span class="pre">unstage()</span></code></a>. We
can trim the verbosity down yet more by employing
<a class="reference internal" href="generated/bluesky.preprocessors.run_decorator.html#bluesky.preprocessors.run_decorator" title="bluesky.preprocessors.run_decorator"><code class="xref py py-func docutils literal notranslate"><span class="pre">run_decorator()</span></code></a>, supplanting
<a class="reference internal" href="generated/bluesky.plan_stubs.open_run.html#bluesky.plan_stubs.open_run" title="bluesky.plan_stubs.open_run"><code class="xref py py-func docutils literal notranslate"><span class="pre">open_run()</span></code></a> and <a class="reference internal" href="generated/bluesky.plan_stubs.close_run.html#bluesky.plan_stubs.close_run" title="bluesky.plan_stubs.close_run"><code class="xref py py-func docutils literal notranslate"><span class="pre">close_run()</span></code></a>.
The result:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">bluesky.preprocessors</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">bpp</span>

<span class="k">def</span><span class="w"> </span><span class="nf">one_run_one_event</span><span class="p">(</span><span class="n">detectors</span><span class="p">):</span>

    <span class="nd">@bpp</span><span class="o">.</span><span class="n">stage_decorator</span><span class="p">(</span><span class="n">detectors</span><span class="p">)</span>
    <span class="nd">@bpp</span><span class="o">.</span><span class="n">run_decorator</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">inner</span><span class="p">():</span>
        <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">declare_stream</span><span class="p">(</span><span class="o">*</span><span class="n">detectors</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;primary&#39;</span><span class="p">)</span>
        <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">trigger_and_read</span><span class="p">(</span><span class="n">detectors</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="k">yield from</span> <span class="n">inner</span><span class="p">())</span>
</pre></div>
</div>
<p>Incidentally, recall that we have already encountered a preprocessor in this
tutorial, in the section on baseline readings.
<a class="reference internal" href="plans.html#bluesky.preprocessors.SupplementalData" title="bluesky.preprocessors.SupplementalData"><code class="xref py py-class docutils literal notranslate"><span class="pre">SupplementalData</span></code></a> is a preprocessor.</p>
</section>
<section id="add-metadata">
<span id="tutorial-plan-metadata"></span><h3>Add Metadata<a class="headerlink" href="#add-metadata" title="Link to this heading">#</a></h3>
<p>To make it easier to search for data generated by the plan and to inspect what
was done afterward, we should include some metadata. We create a dictionary and
pass it to <a class="reference internal" href="generated/bluesky.preprocessors.run_decorator.html#bluesky.preprocessors.run_decorator" title="bluesky.preprocessors.run_decorator"><code class="xref py py-func docutils literal notranslate"><span class="pre">run_decorator()</span></code></a> (or, in the more
verbose formulation, to <a class="reference internal" href="generated/bluesky.plan_stubs.open_run.html#bluesky.plan_stubs.open_run" title="bluesky.plan_stubs.open_run"><code class="xref py py-func docutils literal notranslate"><span class="pre">open_run()</span></code></a>). The RunEngine
will combine this metadata with any information provided by the user, as shown
in the <a class="reference internal" href="#tutorial-metadata"><span class="std std-ref">the earlier section on metadata</span></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">one_run_one_event</span><span class="p">(</span><span class="n">detectors</span><span class="p">):</span>

    <span class="n">md</span> <span class="o">=</span> <span class="p">{</span>
        <span class="c1"># Human-friendly names of detector Devices (useful for searching)</span>
        <span class="s1">&#39;detectors&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">det</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">detectors</span><span class="p">],</span>

        <span class="c1"># The Python &#39;repr&#39;s each argument to the plan</span>
        <span class="s1">&#39;plan_args&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;detectors&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">repr</span><span class="p">,</span> <span class="n">detectors</span><span class="p">))},</span>

        <span class="c1"># The name of this plan</span>
        <span class="s1">&#39;plan_name&#39;</span><span class="p">:</span> <span class="s1">&#39;one_run_one_event&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="nd">@bpp</span><span class="o">.</span><span class="n">stage_decorator</span><span class="p">(</span><span class="n">detectors</span><span class="p">)</span>
    <span class="nd">@bpp</span><span class="o">.</span><span class="n">run_decorator</span><span class="p">(</span><span class="n">md</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">inner</span><span class="p">():</span>
        <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">declare_stream</span><span class="p">(</span><span class="o">*</span><span class="n">detectors</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;primary&#39;</span><span class="p">)</span>
        <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">trigger_and_read</span><span class="p">(</span><span class="n">detectors</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="k">yield from</span> <span class="n">inner</span><span class="p">())</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The values in the metadata dictionary must be strings, numbers,
lists/arrays, or dictionaries only. Metadata cannot contain arbitrary
Python types because downstream consumers (like databases) do not know what
to do with those and will error.</p>
</div>
<p>To be polite, we should allow the user to override this metadata. All of
bluesky’s “pre-assembled” plans (<a class="reference internal" href="generated/bluesky.plans.count.html#bluesky.plans.count" title="bluesky.plans.count"><code class="xref py py-func docutils literal notranslate"><span class="pre">count()</span></code></a>,
<a class="reference internal" href="generated/bluesky.plans.scan.html#bluesky.plans.scan" title="bluesky.plans.scan"><code class="xref py py-func docutils literal notranslate"><span class="pre">scan()</span></code></a>, etc.) provide an optional <code class="docutils literal notranslate"><span class="pre">md</span></code> argument for this
purpose, implemented like so:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">one_run_one_event</span><span class="p">(</span><span class="n">detectors</span><span class="p">,</span> <span class="n">md</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="n">_md</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;detectors&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">det</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">detectors</span><span class="p">],</span>
        <span class="s1">&#39;plan_args&#39;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;detectors&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">repr</span><span class="p">,</span> <span class="n">detectors</span><span class="p">))},</span>
        <span class="s1">&#39;plan_name&#39;</span><span class="p">:</span> <span class="s1">&#39;one_run_one_event&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="c1"># If a key exists in md, it overwrites the default in _md.</span>
    <span class="n">_md</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">md</span> <span class="ow">or</span> <span class="p">{})</span>

    <span class="nd">@bpp</span><span class="o">.</span><span class="n">stage_decorator</span><span class="p">(</span><span class="n">detectors</span><span class="p">)</span>
    <span class="nd">@bpp</span><span class="o">.</span><span class="n">run_decorator</span><span class="p">(</span><span class="n">_md</span><span class="p">)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">inner</span><span class="p">():</span>
        <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">declare_stream</span><span class="p">(</span><span class="o">*</span><span class="n">detectors</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;primary&#39;</span><span class="p">)</span>
        <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">trigger_and_read</span><span class="p">(</span><span class="n">detectors</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="k">yield from</span> <span class="n">inner</span><span class="p">())</span>
</pre></div>
</div>
</section>
<section id="add-hints-in-metadata">
<h3>Add “Hints” in Metadata<a class="headerlink" href="#add-hints-in-metadata" title="Link to this heading">#</a></h3>
<p>The metadata dictionary may optionally include a key named <code class="docutils literal notranslate"><span class="pre">'hints'</span></code>. This
key has special significance to the
<code class="xref py py-class docutils literal notranslate"><span class="pre">BestEffortCallback</span></code> and potentially
other downstream consumers, which use it to try to infer useful ways to
present the data. Currently, it solves two specific problems.</p>
<ol class="arabic simple">
<li><p>Narrow the potentially large set of readings to a manageable number of most
important ones that fit into a table.</p></li>
<li><p>Identify the dimensionality of the data (1D scan? 2D grid? N-D grid?) and
the dependent and independent parameters, for visualization and peak-fitting
purposes.</p></li>
</ol>
<p>It’s up to each device to address (1). The plan has no role in that.
Each device has an optional <code class="docutils literal notranslate"><span class="pre">hints</span></code> attribute with a value like
<code class="docutils literal notranslate"><span class="pre">{'fields':</span> <span class="pre">[...]}</span></code> to answer the question, “Of all the readings you
produce, what are the names of the most important ones?”</p>
<p>We need the plan to help us with (2). Only the plan can sort out which devices
are being employed as “independent” axes and which are being measured as
dependent variables. This isn’t clear just from looking at the Devices alone
because any given movable device can be used as an axis or as a “detector”
depending on the context — <code class="docutils literal notranslate"><span class="pre">count([motor])</span></code> is a perfectly valid thing to
do!</p>
<p>The schema of the plan’s hint metadata is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s1">&#39;dimensions&#39;</span><span class="p">:</span> <span class="p">[([</span><span class="o">&lt;</span><span class="n">FIELD</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="o">&lt;</span><span class="n">STREAM_NAME</span><span class="o">&gt;</span><span class="p">),</span>
                <span class="p">([</span><span class="o">&lt;</span><span class="n">FIELD</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="o">&lt;</span><span class="n">STREAM_NAME</span><span class="o">&gt;</span><span class="p">),</span>
                <span class="o">...</span>
               <span class="p">]}</span>
</pre></div>
</div>
<p>Examples:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># a 1-D scan over x</span>
<span class="p">{</span><span class="s1">&#39;dimensions&#39;</span><span class="p">:</span> <span class="p">[([</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="s1">&#39;primary&#39;</span><span class="p">)]}</span>

<span class="c1"># a 2-D grid_scan over x and y</span>
<span class="p">{</span><span class="s1">&#39;dimensions&#39;</span><span class="p">:</span> <span class="p">[([</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="s1">&#39;primary&#39;</span><span class="p">),</span>
                <span class="p">([</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="s1">&#39;primary&#39;</span><span class="p">)]}</span>

<span class="c1"># a scan moving x and y together along a diagonal</span>
<span class="p">{</span><span class="s1">&#39;dimensions&#39;</span><span class="p">:</span> <span class="p">[([</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="s1">&#39;primary&#39;</span><span class="p">)]}</span>

<span class="c1"># a 1-D scan over temperature, represented in C and K units</span>
<span class="p">{</span><span class="s1">&#39;dimensions&#39;</span><span class="p">:</span> <span class="p">[([</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;K&#39;</span><span class="p">],</span> <span class="s1">&#39;primary&#39;</span><span class="p">)]}</span>

<span class="c1"># a 1-D scan over energy, as measured in energy and diffractometer position</span>
<span class="p">{</span><span class="s1">&#39;dimensions&#39;</span><span class="p">:</span> <span class="p">[([</span><span class="s1">&#39;E&#39;</span><span class="p">,</span> <span class="s1">&#39;dcm&#39;</span><span class="p">],</span> <span class="s1">&#39;primary&#39;</span><span class="p">)]}</span>

<span class="c1"># special case: a sequence of readings where the independent axis is just time</span>
<span class="p">{</span><span class="s1">&#39;dimensions&#39;</span><span class="p">:</span> <span class="p">[([</span><span class="s1">&#39;time&#39;</span><span class="p">],</span> <span class="s1">&#39;primary&#39;</span><span class="p">)]}</span>
</pre></div>
</div>
<p>Each entry in the outer list represents one independent dimension. A dimension
might be represented by multiple fields, either from different devices moved in
a coordinated fashion by the plan (<code class="docutils literal notranslate"><span class="pre">['x',</span> <span class="pre">'y']</span></code>), presented as fully redundant
information from one device (<code class="docutils literal notranslate"><span class="pre">['C',</span> <span class="pre">'K']</span></code>), or coupled information from two
sub-devices (<code class="docutils literal notranslate"><span class="pre">['E',</span> <span class="pre">'dcm']</span></code>).</p>
<p>The second element in each entry is the stream name: <code class="docutils literal notranslate"><span class="pre">'primary'</span></code> in every
example above.  This should correspond to the <code class="docutils literal notranslate"><span class="pre">name</span></code> passed into
<a class="reference internal" href="generated/bluesky.plan_stubs.trigger_and_read.html#bluesky.plan_stubs.trigger_and_read" title="bluesky.plan_stubs.trigger_and_read"><code class="xref py py-func docutils literal notranslate"><span class="pre">trigger_and_read()</span></code></a> or
<a class="reference internal" href="generated/bluesky.plan_stubs.create.html#bluesky.plan_stubs.create" title="bluesky.plan_stubs.create"><code class="xref py py-func docutils literal notranslate"><span class="pre">create()</span></code></a> inside the plan. The default name is
<code class="docutils literal notranslate"><span class="pre">primary</span></code>.</p>
<p>Putting it all together, the plan asks the device(s) being used as independent
axes for their important field(s) and builds a list of dimensions like so:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">dimensions</span> <span class="o">=</span> <span class="p">[(</span><span class="n">motor</span><span class="o">.</span><span class="n">hints</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">],</span> <span class="s1">&#39;primary&#39;</span><span class="p">)]</span>
</pre></div>
</div>
<p>We must account for the fact that <code class="docutils literal notranslate"><span class="pre">hints</span></code> is optional. A given Device
might not have a <code class="docutils literal notranslate"><span class="pre">hints</span></code> attribute at all and, even if it does, the
hints might not contain the <code class="docutils literal notranslate"><span class="pre">'fields'</span></code> key that we are interested in. This
pattern silently omits the dimensions hint if the necessary information is not
provided by the Device:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">scan</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">md</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">_md</span> <span class="o">=</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
    <span class="n">_md</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">md</span> <span class="ow">or</span> <span class="p">{})</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">dimensions</span> <span class="o">=</span> <span class="p">[(</span><span class="n">motor</span><span class="o">.</span><span class="n">hints</span><span class="p">[</span><span class="s1">&#39;fields&#39;</span><span class="p">],</span> <span class="s1">&#39;primary&#39;</span><span class="p">)]</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">_md</span><span class="p">[</span><span class="s1">&#39;hints&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;dimensions&#39;</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">)</span>

    <span class="o">...</span>
</pre></div>
</div>
<p>Finally, by using <code class="docutils literal notranslate"><span class="pre">setdefault</span></code>, we have allowed user to override these hints
if they know better by passing in <code class="docutils literal notranslate"><span class="pre">scan(...,</span> <span class="pre">md={'hints':</span> <span class="pre">...})</span></code>.</p>
</section>
<section id="adaptive-logic-in-a-plan">
<span id="tutorial-adaptive"></span><h3>Adaptive Logic in a Plan<a class="headerlink" href="#adaptive-logic-in-a-plan" title="Link to this heading">#</a></h3>
<p>Two-way communication is possible between the generator and the RunEngine.
For example, the <code class="xref py py-func docutils literal notranslate"><span class="pre">trigger_and_read()</span></code> plan responds with its readings. We
can use it to make an on-the-fly decision about whether to continue or stop.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">bluesky.preprocessors</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">bpp</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">bluesky.plan_stubs</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">bps</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ophyd.sim</span><span class="w"> </span><span class="kn">import</span> <span class="n">det</span><span class="p">,</span> <span class="n">motor</span>
<span class="k">def</span><span class="w"> </span><span class="nf">conditional_break</span><span class="p">(</span><span class="n">threshold</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set, trigger, read until the detector reads intensity &lt; threshold&quot;&quot;&quot;</span>

    <span class="nd">@bpp</span><span class="o">.</span><span class="n">stage_decorator</span><span class="p">([</span><span class="n">det</span><span class="p">,</span> <span class="n">motor</span><span class="p">])</span>
    <span class="nd">@bpp</span><span class="o">.</span><span class="n">run_decorator</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">inner</span><span class="p">():</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">declare_stream</span><span class="p">(</span><span class="n">det</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;primary&#39;</span><span class="p">)</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">mv</span><span class="p">(</span><span class="n">motor</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span>
            <span class="n">readings</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">trigger_and_read</span><span class="p">([</span><span class="n">det</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">readings</span><span class="p">[</span><span class="s1">&#39;det&#39;</span><span class="p">][</span><span class="s1">&#39;value&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">threshold</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="p">(</span><span class="k">yield from</span> <span class="n">inner</span><span class="p">())</span>
</pre></div>
</div>
<p>Demo:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [39]: </span><span class="n">RE</span><span class="p">(</span><span class="n">conditional_break</span><span class="p">(</span><span class="mf">0.2</span><span class="p">))</span>


<span class="go">Transient Scan ID: 14     Time: 2025-06-14 23:17:45</span>
<span class="go">Persistent Unique Scan ID: &#39;54ca9dbf-bfcb-42d1-8369-fbeb9b2d8319&#39;</span>
<span class="go">New stream: &#39;primary&#39;</span>
<span class="go">+-----------+------------+------------+</span>
<span class="go">|   seq_num |       time |        det |</span>
<span class="go">+-----------+------------+------------+</span>
<span class="go">|         1 | 23:17:45.6 |      1.000 |</span>
<span class="go">|         2 | 23:17:45.7 |      0.607 |</span>
<span class="go">|         3 | 23:17:45.7 |      0.135 |</span>
<span class="go">+-----------+------------+------------+</span>
<span class="go">generator conditional_break [&#39;54ca9dbf&#39;] (scan num: 14)</span>



<span class="gh">Out[39]: </span><span class="go">(&#39;54ca9dbf-bfcb-42d1-8369-fbeb9b2d8319&#39;,)</span>
</pre></div>
</div>
<p>The important line in this example is</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">reading</span> <span class="o">=</span> <span class="k">yield from</span> <span class="n">bps</span><span class="o">.</span><span class="n">trigger_and_read</span><span class="p">([</span><span class="n">det</span><span class="p">])</span>
</pre></div>
</div>
<p>The action proceeds like this:</p>
<ol class="arabic simple">
<li><p>The plan yields a ‘read’ message to the RunEngine.</p></li>
<li><p>The RunEngine reads the detector.</p></li>
<li><p>The RunEngine sends that reading <em>back to the plan</em>, and that response is
assigned to the variable <code class="docutils literal notranslate"><span class="pre">reading</span></code>.</p></li>
</ol>
<p>The response, <code class="docutils literal notranslate"><span class="pre">reading</span></code>, is formatted like:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="o">&lt;</span><span class="n">name</span><span class="o">&gt;</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;value&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span><span class="p">,</span> <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">timestamp</span><span class="o">&gt;</span><span class="p">},</span> <span class="o">...</span><span class="p">}</span>
</pre></div>
</div>
<p>For a detailed technical description of the messages and their responses,
see <a class="reference internal" href="msg.html#msg"><span class="std std-ref">Message Protocol</span></a>.</p>
</section>
<section id="plan-cleanup-exception-handling">
<span id="tutorial-exception-handling"></span><h3>Plan “Cleanup” (Exception Handling)<a class="headerlink" href="#plan-cleanup-exception-handling" title="Link to this heading">#</a></h3>
<p>If an exception is raised, the RunEngine gives the plan the opportunity to
catch the exception and either handle it or merely yield some “clean up”
messages before re-raising the exception and killing plan execution. (Recall
this from <a class="reference internal" href="#tutorial-pause-resume-suspend"><span class="std std-ref">Pause, Resume, Suspend</span></a> above.)</p>
<p>This is the general idea:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># This example is illustrative, but it is not completely correct.</span>
<span class="c1"># Use `finalize_wrapper` instead (or read its source code).</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plan_with_cleanup</span><span class="p">():</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">main_plan</span><span class="p">():</span>
        <span class="c1"># do stuff...</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup_plan</span><span class="p">():</span>
        <span class="c1"># do other stuff...</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield from</span> <span class="n">main_plan</span><span class="p">()</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># Do this even if an Exception is raised.</span>
        <span class="k">yield from</span> <span class="n">cleanup_plan</span><span class="p">()</span>
</pre></div>
</div>
<p>Note: The <cite>contingency_wrapper</cite> is superior to the <cite>finalize_wrapper</cite> as it accepts exceptions as arguments,
allowing for targeted cleanup based on specific failure modes.</p>
<p>The exception in question may originate from the plan itself or from the
RunEngine when it attempts to execute a given command.</p>
<p>The <a class="reference internal" href="generated/bluesky.preprocessors.finalize_wrapper.html#bluesky.preprocessors.finalize_wrapper" title="bluesky.preprocessors.finalize_wrapper"><code class="xref py py-func docutils literal notranslate"><span class="pre">finalize_wrapper()</span></code></a> preprocessor provides a
succinct and fully correct way of applying this general pattern.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">bluesky.preprocessors</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">bpp</span>

<span class="k">def</span><span class="w"> </span><span class="nf">plan_with_cleanup</span><span class="p">():</span>
    <span class="k">yield from</span> <span class="n">bpp</span><span class="o">.</span><span class="n">finalize_wrapper</span><span class="p">(</span><span class="n">main_plan</span><span class="p">(),</span> <span class="n">cleanup_plan</span><span class="p">())</span>
</pre></div>
</div>
</section>
<section id="further-reading">
<h3>Further Reading<a class="headerlink" href="#further-reading" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><a class="reference internal" href="plans.html#per-step-hook"><span class="std std-ref">Customize Step Scans with per_step</span></a></p></li>
<li><p>Specifying checkpoints (TODO)</p></li>
<li><p>Monitoring (TODO)</p></li>
<li><p>Fly Scanning (TODO)</p></li>
<li><p><a class="reference internal" href="state-machine.html#planned-pauses"><span class="std std-ref">Pausing from a plan</span></a></p></li>
<li><p><code class="xref py py-func docutils literal notranslate"><span class="pre">input_plan()</span></code> (TODO)</p></li>
<li><p>Going deeper than <a class="reference internal" href="generated/bluesky.plan_stubs.trigger_and_read.html#bluesky.plan_stubs.trigger_and_read" title="bluesky.plan_stubs.trigger_and_read"><code class="xref py py-func docutils literal notranslate"><span class="pre">trigger_and_read()</span></code></a> (TODO)</p></li>
</ul>
</section>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="userindex.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">User Documentation</p>
      </div>
    </a>
    <a class="right-next"
       href="plans.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Plans</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <dialog id="pst-secondary-sidebar-modal"></dialog>
                <div id="pst-secondary-sidebar" class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#before-you-begin">Before You Begin</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#if-you-get-lost-or-confused">If you get lost or confused…</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#the-runengine">The RunEngine</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#prepare-live-visualization">Prepare Live Visualization</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#prepare-data-storage">Prepare Data Storage</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#add-a-progress-bar">Add a Progress Bar</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#common-experiments-plans">Common Experiments (“Plans”)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#read-some-detectors">Read Some Detectors</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#scan">Scan</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#scan-multiple-motors-together">Scan Multiple Motors Together</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#scan-multiple-motors-in-a-grid">Scan Multiple Motors in a Grid</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#aside-access-saved-data">Aside: Access Saved Data</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#simple-customization">Simple Customization</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#save-some-typing-with-partial">Save Some Typing with ‘Partial’</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plans-in-series">Plans in Series</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#baseline-readings-and-other-supplemental-data">“Baseline” Readings (and other Supplemental Data)</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#configure">Configure</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#choose-baseline-devices">Choose “Baseline” Devices</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#use">Use</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#access-baseline-data">Access Baseline Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#other-supplemental-data">Other Supplemental Data</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#pause-resume-suspend">Pause, Resume, Suspend</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#interactive-pause-resume">Interactive Pause &amp; Resume</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#automated-suspend-resume">Automated Suspend &amp; Resume</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#metadata">Metadata</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#simulate-and-introspect-plans">Simulate and Introspect Plans</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#devices">Devices</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#theory">Theory</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#implementation">Implementation</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#write-custom-plans">Write Custom Plans</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#move-in-parallel">Move in Parallel</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#sleeping-timed-delays">Sleeping (Timed Delays)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#capture-data">Capture Data</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#stage-and-unstage">Stage and Unstage</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#add-metadata">Add Metadata</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#add-hints-in-metadata">Add “Hints” in Metadata</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#adaptive-logic-in-a-plan">Adaptive Logic in a Plan</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#plan-cleanup-exception-handling">Plan “Cleanup” (Exception Handling)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#further-reading">Further Reading</a></li>
</ul>
</li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  
  <div class="tocsection editthispage">
    <a href="https://github.com/bluesky/bluesky/edit/1.14.3.dev4+gd2e3cb7a/docs/tutorial.rst">
      <i class="fa-solid fa-pencil"></i>
      
      
        
          Edit on GitHub
        
      
    </a>
  </div>
</div>

  <div class="sidebar-secondary-item">
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/tutorial.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2015, Brookhaven National Lab.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>